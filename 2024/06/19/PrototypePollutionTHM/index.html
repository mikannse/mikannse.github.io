<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>PrototypePollutionTHM | MikannseのSekai</title><meta name="author" content="Mikannse"><meta name="copyright" content="Mikannse"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Introduction在网络安全这个令人激动的世界里，黑客和渗透测试人员四处寻找漏洞，一个不断发展的概念被称为原型污染。这允许不良行为者操纵和利用 JavaScript 应用程序的内部工作原理，并使攻击者能够访问敏感数据和应用程序后端。 虽然原型污染最常在 JavaScript 环境中讨论，但该概念可以应用于使用类似基于原型的继承模型的任何系统。 然而，JavaScript 的广泛使用，特别是在">
<meta property="og:type" content="article">
<meta property="og:title" content="PrototypePollutionTHM">
<meta property="og:url" content="http://mikannse.space/2024/06/19/PrototypePollutionTHM/index.html">
<meta property="og:site_name" content="MikannseのSekai">
<meta property="og:description" content="Introduction在网络安全这个令人激动的世界里，黑客和渗透测试人员四处寻找漏洞，一个不断发展的概念被称为原型污染。这允许不良行为者操纵和利用 JavaScript 应用程序的内部工作原理，并使攻击者能够访问敏感数据和应用程序后端。 虽然原型污染最常在 JavaScript 环境中讨论，但该概念可以应用于使用类似基于原型的继承模型的任何系统。 然而，JavaScript 的广泛使用，特别是在">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg">
<meta property="article:published_time" content="2024-06-19T08:47:55.000Z">
<meta property="article:modified_time" content="2024-06-19T12:42:11.552Z">
<meta property="article:author" content="Mikannse">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="渗透测试">
<meta property="article:tag" content="Nodejs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="http://mikannse.space/2024/06/19/PrototypePollutionTHM/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Mikannse","link":"链接: ","source":"来源: MikannseのSekai","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'PrototypePollutionTHM',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-06-19 20:42:11'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">313</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="MikannseのSekai"><span class="site-name">MikannseのSekai</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PrototypePollutionTHM</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-19T08:47:55.000Z" title="发表于 2024-06-19 16:47:55">2024-06-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-19T12:42:11.552Z" title="更新于 2024-06-19 20:42:11">2024-06-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E5%AE%89/">网安</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>29分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="PrototypePollutionTHM"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>在网络安全这个令人激动的世界里，黑客和渗透测试人员四处寻找漏洞，一个不断发展的概念被称为原型污染。这允许不良行为者操纵和利用 JavaScript 应用程序的内部工作原理，并使攻击者能够访问敏感数据和应用程序后端。</p>
<p>虽然原型污染最常在 JavaScript 环境中讨论，但该概念可以应用于使用类似基于原型的继承模型的任何系统。</p>
<p>然而，JavaScript 的广泛使用，特别是在 Web 开发中，以及其灵活而动态的对象模型，使原型污染成为这种语言中更突出和更相关的问题。相比之下，基于类的继承语言（如 Java 或 C++）具有不同的继承模型，其中类（对象的蓝图）通常是静态的，并且在运行时更改类以影响其所有实例并不是常见的做法或简单的任务。</p>
<p>学习目标<br>﻿通过本课程，您将全面了解以下关键概念：</p>
<p>原型污染的工作原理<br>对 Web 应用程序的潜在风险<br>利用技术（客户端和服务器端）<br>缓解技术</p>
<p>学习前提条件<br>建议在开始本课程之前了解以下主题：</p>
<p>网站的工作方式<br>HTTP 协议和方法<br>OWASP 十大 Web 漏洞</p>
<h1 id="Essential-Recap"><a href="#Essential-Recap" class="headerlink" title="Essential Recap"></a>Essential Recap</h1><p>在我们深入讨论原型污染等高级内容之前，让我们先了解 JavaScript 中的一些基本知识。将<strong>对象</strong>视为保存信息的构建块。<strong>继承</strong>就像将特征从一个对象传递到另一个对象。<strong>函数</strong>就像可以单独使用或作为这些对象的一部分使用的工具。最后，JavaScript 中的<strong>类</strong>就像蓝图，可以帮助我们轻松制作类似的东西。一旦我们掌握了这些基础知识，我们就可以在我们的房间里探索更复杂的原型污染主题。</p>
<p>对象</p>
<p>在 JavaScript 中，对象就像可以容纳不同信息的容器。将社交网络个人资料想象成一个对象，其中每个个人资料都具有姓名、年龄和关注者等属性。您可以使用花括号和键值对来表示它：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> user = {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'Ben S'</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">  <span class="attr">followers</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="title class_">DoB</span>: <span class="string">'1/1/1990'</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>此处的“用户”是一个具有“名称”、“年龄”和“关注者”等属性的对象。这些属性存储有关用户的特定信息。JavaScript 中的对象使我们能够组织和管理相关数据，使其成为构建动态和交互式应用程序的基本概念。</p>
<p>要实际测试它，请在附加的 VM 中打开“Chrome”，打开浏览器后，右键单击并选择“检查”，然后选择“控制台”，这将打开以下窗口。请复制上述代码并将其粘贴到控制台中；它将为您创建一个用户对象。现在，您可以使用“console.log”访问对象的属性，如下所示：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/99cc8d4964ad5650031e743fd3dddcd4.png" alt="image for console log"></p>
<p>类</p>
<p>在 JavaScript 中，类就像蓝图一样，有助于创建具有相似结构和行为的多个对象。继续我们的社交网络示例，我们可以使用类来定义一般用户和内容创建者。类提供了一种方便的方式来组织和实例化具有共同特征的对象。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">           <span class="comment">// Class for User </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserProfile</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, age, followers, dob</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">age</span> = age;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">followers</span> = followers;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dob</span> = dob; <span class="comment">// Adding Date of Birth</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Class for Content Creator Profile inheriting from User </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContentCreatorProfile</span> <span class="keyword">extends</span> <span class="title class_ inherited__">User</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, age, followers, dob, content, posts</span>) {</span><br><span class="line">    <span class="variable language_">super</span>(name, age, followers, dob);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">content</span> = content;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">posts</span> = posts;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating instances of the classes</span></span><br><span class="line"><span class="keyword">let</span> regularUser = <span class="keyword">new</span> <span class="title class_">UserProfile</span>(<span class="string">'Ben S'</span>, <span class="number">25</span>, <span class="number">1000</span>, <span class="string">'1/1/1990'</span>);</span><br><span class="line"><span class="keyword">let</span> contentCreator = <span class="keyword">new</span> <span class="title class_">ContentCreatorProfile</span>(<span class="string">'Jane Smith'</span>, <span class="number">30</span>, <span class="number">5000</span>, <span class="string">'1/1/1990'</span>, <span class="string">'Engaging Content'</span>, <span class="number">50</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>现在，<code>User</code> 类将出生日期 (dob) 作为其属性的一部分，而 <code>ContentCreatorProfile</code> 类继承了此属性。在创建这些类的实例时，我们可以提供出生日期和其他详细信息。如我们所见，包括出生日期可以为用户资料提供更多信息。</p>
<p>原型</p>
<p>在 JavaScript 中，每个对象都链接到一个原型对象，这些原型形成一个通常称为<strong>原型链</strong>的链。原型充当对象的模板或蓝图。当您使用构造函数或类创建对象时，JavaScript 会自动在对象与其原型之间建立链接。在我们的社交网络示例的背景下，让我们说明原型的工作原理：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">           <span class="comment">// Prototype for User </span></span><br><span class="line"><span class="keyword">let</span> userPrototype = {</span><br><span class="line">  <span class="attr">greet</span>: <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`Hello, <span class="subst">${<span class="variable language_">this</span>.name}</span>!`</span>;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// User Constructor Function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfilePrototype</span>(<span class="params">name, age, followers, dob</span>) {</span><br><span class="line">  <span class="keyword">let</span> user = <span class="title class_">Object</span>.<span class="title function_">create</span>(userPrototype);</span><br><span class="line">  user.<span class="property">name</span> = name;</span><br><span class="line">  user.<span class="property">age</span> = age;</span><br><span class="line">  user.<span class="property">followers</span> = followers;</span><br><span class="line">  user.<span class="property">dob</span> = dob;</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating an instance</span></span><br><span class="line"><span class="keyword">let</span> regularUser = <span class="title class_">UserProfilePrototype</span>(<span class="string">'Ben S'</span>, <span class="number">25</span>, <span class="number">1000</span>, <span class="string">'1/1/1990'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Using the prototype method</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(regularUser.<span class="title function_">greet</span>());        </span><br></pre></td></tr></tbody></table></figure>

<p>您可以复制并试用附加 VM 中的代码，以了解 JavaScript 对象的工作原理。</p>
<p>类和原型之间的区别</p>
<p>JS 中的类和原型是实现类似目标的两种方式：创建具有行为和特征的对象。想象一下，您正在房间里建造汽车模型。使用类就像为要开发的每种汽车模型准备一份详细的蓝图或一套说明。您严格按照蓝图来制造每辆汽车，并且所有根据精确蓝图制造的汽车都保证具有相同的功能和行为。JavaScript 中的类的工作原理类似；它们提供了一种清晰、结构化的方式来创建共享相同属性和方法的对象，使它们易于理解和使用。</p>
<p>另一方面，原型就像拥有一个基本的汽车模型，然后通过直接在汽车本身上添加或修改功能来对其进行自定义。使用原型，您从一个简单的对象开始，然后通过将其链接到已经具有这些行为的原型对象来为其添加行为。以这种方式创建的对象通过原型链链接，允许它们从其他对象继承行为。这种方法更具动态性和灵活性，但与类的结构化方法相比，管理和理解起来可能更困难。</p>
<p>继承</p>
<p>在 JavaScript 中，继承允许一个对象从另一个对象继承属性，从而创建相关对象的层次结构。继续我们的社交网络示例，让我们考虑内容创建者的更具体的个人资料。这个新对象可以从一般用户个人资料中继承属性，如“名称”和“关注者”，并添加特定属性，如“内容”和“帖子”。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> user = {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'Ben S'</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">  <span class="attr">followers</span>: <span class="number">1000</span>,</span><br><span class="line"><span class="title class_">DoB</span>: <span class="string">'1/1/1990'</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// Content Creator Profile inheriting from User </span></span><br><span class="line"><span class="keyword">let</span> contentCreatorProfile = <span class="title class_">Object</span>.<span class="title function_">create</span>(user);</span><br><span class="line">contentCreatorProfile.<span class="property">content</span> = <span class="string">'Engaging Content'</span>;</span><br><span class="line">contentCreatorProfile.<span class="property">posts</span> = <span class="number">50</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>这里，<code>contentCreatorProfile</code> 使用 <code>Object.create()</code> 从用户那里继承属性。现在，它具有 <code>content</code> 和 <code>posts</code> 等特定属性，并从一般用户资料中继承了 <code>name</code>、<code>age</code> 和 <code>followers</code>，如下所示。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/de24c38d79efaee48dcc302e6a0b4411.png" alt="image for console log"></p>
<p>这样，继承有助于创建更专业的对象，同时重用父对象的公共属性。JavaScript 支持类和基于原型的继承。</p>
<ul>
<li><strong>基于原型的继承</strong>：在 JavaScript 中，每个对象都有一个原型，当您创建新对象时，您可以指定其原型。对象从其原型继承属性和方法。您可以使用 <code>Object.create()</code> 方法创建具有指定原型的新对象，也可以使用现有对象的原型属性直接修改其原型。</li>
<li><strong>基于类的继承</strong>：JavaScript 还支持类，它为定义对象和继承提供了更熟悉的语法。JavaScript 中的类只是 JavaScript 现有基于原型的继承的语法糖。在底层，类仍然使用原型。</li>
</ul>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/c78a12f7d39bbcf14ef8832fefaf930d.svg" alt="image for prototype of userprofile"></p>
<p>右图表示 JS 中基于原型的继承：</p>
<ul>
<li><strong>定义 UserProfile 对象</strong>：我们首先定义一个通用的 <code>UserProfile</code> 对象，该对象表示不同类型的配置文件共享的通用属性。在此示例中，<code>UserProfile</code> 包括电子邮件和密码等属性，这些属性可能对所有用户配置文件都通用。</li>
<li><strong>创建 ContentCreatorProfile</strong>：我们创建一个名为 <code>ContentCreatorProfile</code> 的专用配置文件。此配置文件特定于内容创建者，可能具有通用用户配置文件中没有的其他属性或行为。我们通过使用 <code>Object.create(UserProfile)</code> 创建 <code>ContentCreatorProfile</code> 来实现这一点，它将 <code>UserProfile</code> 设置为 <code>ContentCreatorProfile</code> 的原型。</li>
<li><strong>添加其他属性</strong>：创建 ContentCreatorProfile 后，我们添加特定属性，例如帖子。此属性是 <code>ContentCreatorProfile</code> 独有的，不从 <code>UserProfile</code> 继承。</li>
<li><strong>访问属性</strong>：访问“ContentCreatorProfile”的属性时，JavaScript 首先检查该属性是否直接存在于“ContentCreatorProfile”上。如果未找到该属性，则查找原型链并检查“UserProfile”上是否存在该属性。如果找到，则返回原型链中的值。因此，“ContentCreatorProfile”从“UserProfile”继承了属性 email 和 password，同时还具有自己独特的属性 number of posts。这允许使用分层结构，其中专门的配置文件可以从通用配置文件继承通用属性，同时添加其特定属性。</li>
</ul>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/ba889a24229822ded96d81b5a97484d0.svg" alt="image for summary of classes and inheritance"></p>
<p>让我们用上图总结一下到目前为止所讨论的内容。原型的概念在实现继承中起着至关重要的作用。JavaScript 中的每个对象都有一个原型，它是对象属性和方法的蓝图。在上图中，当我们定义一个像“UserProfile”这样的类时，它的原型将成为从它创建的所有实例的原型。这意味着“UserProfile”类中定义的属性和方法可供“UserProfile”的所有实例访问。此外，JavaScript 允许我们动态扩展这些原型，通过原型链实现继承。例如，“ContentCreator”、“ContentDesigner”和“Moderator”等子类可以扩展“UserProfile”类的原型以继承其属性和方法。通过利用原型，JavaScript 提供了一种灵活而有效的机制来实现继承，从而实现了面向对象编程范式中的代码重用和可维护性。</p>
<h1 id="How-it-Works"><a href="#How-it-Works" class="headerlink" title="How it Works"></a>How it Works</h1><p>现在我们对 JavaScript 有了基本的了解，让我们使用相同的社交网络示例深入研究原型污染。</p>
<p>原型污染是一种漏洞，当攻击者操纵对象的原型时，就会影响该对象的所有实例。在 JavaScript 中，原型有助于继承，攻击者可以利用这一点来修改共享属性或在对象之间注入恶意行为。</p>
<p><em>原型污染本身可能并不总是直接构成可利用的威胁。然而，当它与其他类型的漏洞（如 XSS 和 CSRF）结合在一起时，其真正的危害潜力就会变得尤为明显。</em></p>
<p>一个常见的例子</p>
<p>假设我们有一个带有“introduce”方法的“Person”基本原型。攻击者旨在通过改变原型来操纵所有实例中“introduce”方法的行为。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Base Prototype for Persons</span></span><br><span class="line"><span class="keyword">let</span> personPrototype = {</span><br><span class="line">  <span class="attr">introduce</span>: <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`Hi, I'm <span class="subst">${<span class="variable language_">this</span>.name}</span>.`</span>;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// Person Constructor Function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">name</span>) {</span><br><span class="line">  <span class="keyword">let</span> person = <span class="title class_">Object</span>.<span class="title function_">create</span>(personPrototype);</span><br><span class="line">  person.<span class="property">name</span> = name;</span><br><span class="line">  <span class="keyword">return</span> person;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creating an instance</span></span><br><span class="line"><span class="keyword">let</span> ben = <span class="title class_">Person</span>(<span class="string">'Ben'</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>请复制上述代码，粘贴到控制台并按 Enter。当我们创建一个新对象“ben”并调用“introduce”方法时，它会显示“Hi, I’m Ben”，如下图所示。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/23cf37880af1735915022ab52c32a166.png" alt="image of console"></p>
<p>如果攻击者使用 <code>__proto__</code> 属性将恶意内容注入所有实例的 introduce 方法中，结果会怎样？在 JavaScript 中，<code>__proto__</code> 属性是访问对象原型的常用方法，本质上指向继承属性和方法的对象。让我们看看，攻击者以某种方式使用任何攻击媒介（如 XSS、CSRF 等）执行以下代码。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Attacker's Payload</span></span><br><span class="line">ben.<span class="property">__proto__</span>.<span class="property">introduce</span>=<span class="keyword">function</span>(<span class="params"></span>){<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"You've been hacked, I'm Bob"</span>);}</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ben.<span class="title function_">introduce</span>()); </span><br></pre></td></tr></tbody></table></figure>

<p>我们将详细讨论后台到底发生了什么：</p>
<ul>
<li><strong>原型定义</strong>：Person 原型 (personPrototype) 最初使用无害的 <code>introduce</code> 方法定义，介绍该人。</li>
<li><strong>对象实例化</strong>：使用名称 <code>'Ben' (let ben = Person('Ben');)</code> 创建 Person 实例。</li>
<li><strong>原型污染攻击</strong>：攻击者将恶意负载注入原型的 <code>introduce</code> 方法，更改其行为以显示有害消息。</li>
<li><strong>对现有实例的影响</strong>：结果，即使现有实例 (<code>ben</code>) 也会受到影响，并且调用 <code>ben.introduce()</code> 现在会输出攻击者注入的消息。</li>
</ul>
<p>此示例显示了攻击者如何改变跨对象共享方法的行为，从而可能造成安全风险。防止原型污染包括仔细验证输入数据并避免直接使用不受信任的内容修改原型。</p>
<h1 id="Exploitation-XSS"><a href="#Exploitation-XSS" class="headerlink" title="Exploitation - XSS"></a>Exploitation - XSS</h1><p>标准方法</p>
<p>众所周知，JavaScript 中的 Object 原型本身就具有许多属性。其中，<code>constructor</code> 和 <code>__proto__</code> 属性是威胁行为者特别值得注意的目标。<code>constructor</code> 属性指向构造对象原型的函数，而 <code>__proto__</code> 是对当前对象直接继承的原型对象的引用。恶意行为者经常利用这些属性来操纵对象的原型链，从而可能导致原型污染。</p>
<p>黄金法则</p>
<p>该概念取决于攻击者影响某些关键参数的能力，例如 <code>x</code> 和 <code>val</code>，表达式类似于 <code>Person[x][y] = val</code>。假设攻击者将 <code>__proto__</code> 分配给 <code>x</code>。在这种情况下，由 <code>y</code> 标识的属性在与具有 <code>val</code> 表示的值的对象共享同一类的所有对象中都是通用的。</p>
<p>在更复杂的场景中，当攻击者控制结构（如“Person[x][y][z] = val”）中的“x”、“y”和“val”时，将“x”指定为“构造函数”，将“y”指定为“原型”，会导致在应用程序中所有具有指定“val”的对象中建立由“z”定义的新属性。后一种方法需要更复杂的对象属性排列，因此在实践中不太常见。</p>
<p>几个重要函数</p>
<p>在识别潜在的原型污染漏洞时，渗透测试人员应关注易受原型污染影响的常用向量/函数。彻底检查应用程序如何处理对象操作至关重要。我们将了解攻击者可以利用的一些重要函数，然后我们将实际执行利用。</p>
<ul>
<li><strong>按路径定义属性</strong>：如果路径组件由用户输入控制，则根据给定路径设置对象属性的函数（如“object[a][b][c] = value”）可能很危险。应检查这些函数以确保它们不会无意中修改对象的原型。考虑一个允许用户更新任何好友评论的端点。</li>
</ul>
<p><strong>初始对象结构</strong></p>
<p>在进行任何更新之前，我们有一个初始好友数组，其中包含一个代表好友个人资料的对象。每个个人资料对象都包含 ID、名称、评论和专辑等属性。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> friends = [ { <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"testuser"</span>, <span class="attr">age</span>: <span class="number">25</span>, <span class="attr">country</span>: <span class="string">"UK"</span>, <span class="attr">reviews</span>: [], <span class="attr">albums</span>: [{ }], <span class="attr">password</span>: <span class="string">"xxx"</span>, } ]; _.<span class="title function_">set</span>(friend, input.<span class="property">path</span>, input.<span class="property">value</span>);</span><br></pre></td></tr></tbody></table></figure>

<p><strong>从用户收到的输入</strong></p>
<p>用户想要为朋友添加评论。他们提供了一个有效负载，其中包含应添加评论的路径（<strong>reviews.content</strong>）和评论内容（**<script>alert(anycontent)</script>**）。</p>
<p>攻击者更新路径以瞄准原型：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">{ <span class="string">"path"</span>: <span class="string">"reviews[0].content"</span>, <span class="string">"value"</span>: <span class="string">"&amp;#60;script&amp;#62;alert('anycontent')&amp;#60;/script&amp;#62;"</span> };</span><br></pre></td></tr></tbody></table></figure>

<p>我们使用 lodash 中的 <strong>_set</strong> 函数来应用有效负载，并将评论内容添加到好友个人资料对象中的指定路径。</p>
<p><strong>结果对象结构</strong></p>
<p>执行代码后，好友数组将被修改以包含用户的评论。但是，由于缺乏适当的输入验证，用户提供的评论内容（**<script>alert('anycontent')</script>**）未经适当清理就直接添加到个人资料对象中。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> friends = [</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">"testuser"</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">country</span>: <span class="string">"UK"</span>,</span><br><span class="line">    <span class="attr">reviews</span>: [</span><br><span class="line">      <span class="string">"&lt;script&gt;alert('anycontent')&lt;/script&gt;"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">albums</span>: [{}],</span><br><span class="line">    <span class="attr">password</span>: <span class="string">"xxx"</span>,</span><br><span class="line">  }</span><br><span class="line">];</span><br></pre></td></tr></tbody></table></figure>

<p>类似地，假设攻击者想要在好友的个人资料中插入恶意属性。在这种情况下，他们会提供一个有效负载，其中包含应添加属性的路径（<strong>isAdmin</strong>）和恶意属性的值（true）。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> payload = { <span class="string">"path"</span>: <span class="string">"isAdmin"</span>, <span class="string">"value"</span>: <span class="literal">true</span> };</span><br></pre></td></tr></tbody></table></figure>

<p>执行代码后，“friends”数组将被修改，以在好友的个人资料对象中包含恶意属性<strong>isAdmin</strong>。“friends”对象将具有以下结构：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> friends = [</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">"testuser"</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">country</span>: <span class="string">"UK"</span>,</span><br><span class="line">    <span class="attr">reviews</span>: [],</span><br><span class="line">    <span class="attr">albums</span>: [],</span><br><span class="line">    <span class="attr">password</span>: <span class="string">"xxx"</span>,</span><br><span class="line">    <span class="attr">isAdmin</span>: <span class="literal">true</span> <span class="comment">// Malicious property inserted by the attacker</span></span><br><span class="line">  }</span><br><span class="line">];</span><br></pre></td></tr></tbody></table></figure>

<p>实例</p>
<p>现在，我们将实际了解攻击者如何利用该漏洞。假设您在一家公司担任渗透测试员，负责渗透测试社交媒体应用程序。您可以使用以下登录凭据通过 <code>10.10.144.78:5000</code> URL 访问该应用程序：</p>
<ul>
<li>用户名：<code>bob</code></li>
<li>密码：<code>bob@123</code></li>
</ul>
<p>登录后，您将看到如下仪表板：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/e8b58c7609886ffefb79435e3ac75f23.png" alt="image of the dashboard"></p>
<p>为了识别原型污染，我们将探索社交媒体应用程序的不同功能，例如添加相册、发送好友请求、添加评论等。登录后，其他朋友可以添加到您的朋友列表中。访问任何朋友的个人资料（在本例中假设为 Sabalenka）。访问页面后，您将看到不同的选项，例如添加评论、克隆相册等。让我们探索提交评论功能。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/f730a61990991d810591859a18ee0974.png" alt="submit review feature"></p>
<p>提交评论功能允许用户提交任何评论，这些评论将保存在数据库中。让我们探索客户端和服务器端代码，以分析各种利用可能性。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">&lt;form action="/submit-friend-review" method="post" class="mb-4"&gt;</span><br><span class="line">    &lt;h2 class="mb-3"&gt;Submit a Review&lt;/h2&gt;</span><br><span class="line">    &lt;input type="hidden" name="friendId" value="1"&gt;</span><br><span class="line">    &lt;div class="form-group"&gt;</span><br><span class="line">        &lt;textarea class="form-control" name="reviewContent" placeholder="Write your review here"</span><br><span class="line">            rows="3"&gt;&lt;/textarea&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;button type="submit" class="btn btn-primary"&gt;Submit Review&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>客户端代码将评论作为输入参数，并调用 API 端点 <code>/submit-friend-review</code> 来添加评论以及隐藏参数 <code>friendId</code>。如前面的任务所述，单独的原型污染很少能被利用；然而，一旦与 XSS 等其他攻击媒介结合，它可以提供更好的攻击面。现在，让我们来看看服务器端代码。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> friends = [</span><br><span class="line">  {</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">"Sabalenka"</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">25</span>,</span><br><span class="line">    <span class="attr">country</span>: <span class="string">"UK"</span>,</span><br><span class="line">    <span class="attr">reviews</span>: [],</span><br><span class="line">    <span class="attr">albums</span>: [{ <span class="attr">name</span>: <span class="string">"USA Trip"</span>, <span class="attr">photos</span>: <span class="string">"git.thm"</span> }],</span><br><span class="line">    <span class="attr">password</span>: <span class="string">"xxx"</span>,</span><br><span class="line">  },</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">"/submit-friend-review"</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">user</span>) {</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">"/signin"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> { friendId, reviewContent } = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">const</span> friend = friends.<span class="title function_">find</span>(<span class="function">(<span class="params">f</span>) =&gt;</span> f.<span class="property">id</span> === <span class="built_in">parseInt</span>(friendId));</span><br><span class="line">  <span class="keyword">if</span> (!friend) {</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">"Friend not found"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> input = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(reviewContent);</span><br><span class="line">    _.<span class="title function_">set</span>(friend, input.<span class="property">path</span>, payload.<span class="property">value</span>);</span><br><span class="line">  } <span class="keyword">catch</span> (e) { }</span><br><span class="line">  res.<span class="title function_">redirect</span>(<span class="string">`/friend/<span class="subst">${friendId}</span>`</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>此代码正在执行以下操作：</p>
<ul>
<li>首先，验证已登录用户的会话；如果没有，则将其重定向到登录页面。</li>
<li>然后，代码提取参数并验证已登录用户与请求参数中收到的“friendId”之间的连接。</li>
<li>验证好友的连接后，代码将评论插入好友的对象中。</li>
<li>代码使用 Lodash 实用程序中的“_.set”函数，该函数允许您在对象的给定路径处设置属性的值。这是一种在对象上深度设置值的便捷方法，而无需检查路径的每个级别是否存在。如果路径的某个部分不存在，则“_set”将创建它。</li>
<li>代码分析表明，这是执行<strong>按路径定义属性</strong>攻击的绝佳机会。</li>
<li>接下来，让我们添加一个朋友并访问他的个人资料以添加一个简单的评论，看看它是否有效。</li>
</ul>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/63a1b1a9086c96548a20e1e607368019.png" alt="image after successfully adding a review"></p>
<p>评论已成功添加。根据我们从源代码审查中获得的知识，让我们准备一个有效负载来发送触发警报的评论。我们知道朋友的对象有一个“评论”数组，其中存储了每个用户的评论。添加评论的功能仅适用于朋友的个人资料。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">{<span class="string">"path"</span>: <span class="string">"reviews[0].content"</span>, <span class="string">"value"</span>: <span class="string">"&lt;script&gt;alert('Hacked')&lt;/script&gt;"</span>}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/49e3129bac73bee07c10fe3a1909ac3c.png" alt="XSS image after prototype pollution"></p>
<p>现在，每当有人访问此用户的个人资料时，就会触发 XSS 攻击。在这种情况下，攻击者甚至可以操纵其他可能允许管理员访问用户的属性，例如 <code>isAdmin</code>、<code>isloggedIn</code> 等。</p>
<p>在此任务中，我们了解了攻击者如何使用按定义属性技术发起原型污染和 XSS 攻击。在下一个任务中，我们将继续学习更多功能。</p>
<h1 id="Exploitation-Property-Injection"><a href="#Exploitation-Property-Injection" class="headerlink" title="Exploitation - Property Injection"></a>Exploitation - Property Injection</h1><p>几个重要函数</p>
<ul>
<li><strong>对象递归合并</strong>：此函数涉及将源对象的属性递归合并到目标对象中。如果合并函数未验证其输入并允许将属性合并到原型链中，攻击者可以利用此功能。考虑相同的社交网络示例，让我们假设以下代码。假设应用程序具有合并用户设置的功能：</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Vulnerable recursive merge function</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">recursiveMerge</span>(<span class="params">target, source</span>) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) {</span><br><span class="line">        <span class="keyword">if</span> (source[key] <span class="keyword">instanceof</span> <span class="title class_">Object</span>) {</span><br><span class="line">            <span class="keyword">if</span> (!target[key]) target[key] = {};</span><br><span class="line">            <span class="title function_">recursiveMerge</span>(target[key], source[key]);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            target[key] = source[key];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Endpoint to update user settings</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">'/updateSettings'</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> userSettings = req.<span class="property">body</span>; <span class="comment">// User-controlled input</span></span><br><span class="line">    <span class="title function_">recursiveMerge</span>(globalUserSettings, userSettings);</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">'Settings updated!'</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>攻击者发送一个包含“__proto__”的嵌套对象的请求：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">{ <span class="string">"__proto__"</span>: { <span class="string">"newProperty"</span>: <span class="string">"value"</span> } } </span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><strong>对象克隆</strong>：对象克隆是一种类似的功能，允许深度克隆操作无意中将属性从原型链复制到另一个原型链。测试应确保这些函数仅克隆对象的用户定义属性并过滤特殊关键字，如__proto__、构造函数等。一个可能的用例是应用程序后端克隆对象以创建新的用户配置文件：</li>
</ul>
<p>实际示例</p>
<p>现在，我们将实际了解攻击者如何利用此漏洞。让我们探索克隆相册功能。克隆相册允许用户通过提供新名称来克隆相册。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/ad5f4fc5de32c3280cc67bdeecb40a23.png" alt="Clone album feature"></p>
<p>让我们探索客户端和服务器端代码来探索各种利用可能性。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">&lt;form action=<span class="string">"/clone-album/1"</span> method=<span class="string">"post"</span> <span class="keyword">class</span>=<span class="string">"mb-4"</span>&gt;</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"mb-3"</span>&gt;</span>Clone Album of Josh<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"selectedAlbum"</span>&gt;</span>Select an Album to Clone:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"selectedAlbum"</span> <span class="attr">id</span>=<span class="string">"selectedAlbum"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Trip to US"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        Trip to US</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"newAlbumName"</span>&gt;</span>New Album Name:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"newAlbumName"</span> <span class="attr">id</span>=<span class="string">"newAlbumName"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">placeholder</span>=<span class="string">"Enter new album name"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>Clone Album<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>

<p>客户端代码将名称作为输入，并调用 API 端点 <code>/clone-album/{album_ID}</code> 来克隆相册。如前面的任务所述，单独的 Prototype 污染很少能被利用；然而，一旦与 XSS 等其他攻击媒介结合，它可以提供更好的攻击面。现在，让我们来看看服务器端代码。</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">"/clone-album/:friendId"</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> {</span><br><span class="line">  <span class="keyword">const</span> { friendId } = req.<span class="property">params</span>;</span><br><span class="line">  <span class="keyword">const</span> { selectedAlbum, newAlbumName } = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">const</span> friend = friends.<span class="title function_">find</span>(<span class="function">(<span class="params">f</span>) =&gt;</span> f.<span class="property">id</span> === <span class="built_in">parseInt</span>(friendId));</span><br><span class="line">  <span class="keyword">if</span> (!friend) {</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"Friend not found"</span>);</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">"Friend not found"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> albumToClone = friend.<span class="property">albums</span>.<span class="title function_">find</span>(</span><br><span class="line">    <span class="function">(<span class="params">album</span>) =&gt;</span> album.<span class="property">name</span> === selectedAlbum</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (albumToClone &amp;&amp; newAlbumName) {</span><br><span class="line">    <span class="keyword">let</span> clonedAlbum = { ...albumToClone };</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">const</span> payload = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(newAlbumName);</span><br><span class="line">      <span class="title function_">merge</span>(clonedAlbum, payload);</span><br><span class="line">    } <span class="keyword">catch</span> (e) {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">to, <span class="keyword">from</span></span>) {</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> <span class="keyword">from</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> to[key] == <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> <span class="keyword">from</span>[key] == <span class="string">"object"</span>) {</span><br><span class="line">      <span class="title function_">merge</span>(to[key], <span class="keyword">from</span>[key]);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      to[key] = <span class="keyword">from</span>[key];</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> to;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在上面的代码中，服务器收到一个包含专辑名称的 JSON 对象，将需要复制的专辑复制到另一个对象中，并通过调用合并函数更改新创建的副本的名称。</p>
<p>我们知道，如果合并函数盲目复制所有对象和属性而不根据键进行清理，那么它就是原型污染的理想候选者。我们可以看到，开发人员编写的合并函数缺少任何此类清理过滤器。如果我们发送一个包含 <code>__proto__</code> 的请求，其中包含 <code>newProperty</code> 和值，如下所示：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">{<span class="string">"__proto__"</span>: {<span class="string">"newProperty"</span>: <span class="string">"hacked"</span>}}</span><br></pre></td></tr></tbody></table></figure>

<p>合并函数将把 <code>__proto__</code> 视为属性，并调用 <code>obj.__proto__.newProperty=value</code>。通过这样做，<code>newProperty</code> 不会直接添加到朋友对象中。相反，它会被添加到朋友对象的原型中。这意味着 <code>newProperty</code> 不是朋友属性（如姓名、年龄等）的可见部分，但仍然可以访问。让我们通过访问 Josh 的个人资料并使用上述有效负载作为相册名称来克隆相册。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/985c66e44b234218ff481dfb9fc2ef48.png" alt="image after clonning an album"></p>
<p>开始吧！我们为所有友元对象添加了一个新属性。</p>
<ul>
<li>对同一类型的所有对象的影响</li>
</ul>
<p>：由于所有友元对象共享相同的原型（它们由相同的模板或构造函数创建），因此添加</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">newProperty</span><br></pre></td></tr></tbody></table></figure>

<p>添加到原型意味着所有朋友对象现在都可以访问 newProperty。这就像向模板添加新功能一样；</p>
<p>现在，从该模板创建的每个对象都具有此新功能。</p>
<p>-<strong>观察变化</strong>：即使在打印朋友对象时无法直接看到 <code>newProperty</code>，但它仍然存在。您可以通过调用 <code>friend.newProperty</code> 来访问它，它将显示“<code>testValue</code>”。<br>-<strong>newProperty 如何变得可见</strong>：当您通过原型添加 newProperty 时，它并不直接存在于单个对象（如每个朋友）上，而是存在于它们的原型上。但是，当您访问对象的属性时，JavaScript 首先在对象本身上查找该属性。如果未找到，JavaScript 会查找原型链，直到找到它（或到达链的末尾）。</p>
<ul>
<li><strong>在屏幕上渲染</strong>：在 <a target="_blank" rel="noopener" href="https://ejs.co/">EJS</a> 模板中，当您使用 <code>for...in loop</code> (<code>&lt;% for (let key in friend) { %&gt; ... &lt;% } %&gt;</code>) 循环遍历朋友对象的属性并显示它们时，此循环将遍历朋友对象的所有可枚举属性，包括从原型继承的属性。因此，即使 newProperty 不是直接在朋友对象上，而是在其原型上，它仍会显示在此循环中并呈现在屏幕上。</li>
</ul>
<p>在此任务中，我们学习了如何在对象的原型中添加新属性来污染整体结构。在下一个任务中，我们将了解如果开发人员不采取必要措施，如何使整个应用程序崩溃。</p>
<p>注意：要回答以下问题，请访问 URL <code>http://10.10.168.64:8080/getFlag.php</code> 以获取标志。您将看到以下仪表板以获取标志：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/e9c9b96e18ff0aac5850831cb879842d.png" alt="dashboard for getting flags"></p>
<h1 id="Exploitation-Denial-of-Service"><a href="#Exploitation-Denial-of-Service" class="headerlink" title="Exploitation - Denial of Service"></a>Exploitation - Denial of Service</h1><p>拒绝服务</p>
<p>原型污染是 JavaScript 应用程序中的一个严重漏洞，它可能导致拒绝服务 (DoS) 攻击以及其他严重后果。当攻击者操纵广泛使用的对象的原型时，就会发生这种情况，导致应用程序出现意外行为或完全崩溃。在 JavaScript 中，对象从其原型继承属性和方法，更改此原型会影响共享它的所有对象。</p>
<p>例如，如果攻击者污染了 <code>Object.prototype.toString</code> 方法，则任何对象对此方法的后续调用都会执行更改后的行为。在经常使用 <code>toString</code> 的复杂应用程序中，这可能会导致意外结果，从而可能导致应用程序出现故障。<code>toString</code> 方法在 JavaScript 中被广泛使用。它在许多情况下都会自动调用，尤其是在需要将对象转换为字符串时。</p>
<p>如果污染的方法导致处理效率低下或无限循环，则可能会耗尽系统资源，从而导致 DoS 情况。此外，原型污染还会干扰应用程序的业务逻辑。更改基本方法或属性可能会触发未处理的异常或错误，从而导致进程或服务终止。这可能会导致 Web 应用程序中的服务器无响应，从而拒绝向合法用户提供服务。</p>
<p>实际示例</p>
<ul>
<li>再次访问 URL <code>http://10.10.168.64:5000</code>，看看我们是否可以通过任何输入使服务器崩溃。如前所述，我们有一个方法 <code>Object.prototype.toString</code>，可将对象转换为 String 数据类型。</li>
<li>访问任何朋友的个人资料页面；我们可以从上一个任务中看到服务器端代码的样子</li>
</ul>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/clone-album/1"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">class</span>=<span class="string">"mb-4"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"mb-3"</span>&gt;</span>Clone Album of Josh<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"selectedAlbum"</span>&gt;</span>Select an Album to Clone:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"selectedAlbum"</span> <span class="attr">id</span>=<span class="string">"selectedAlbum"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Trip to US"</span>&gt;</span></span><br><span class="line">                        Trip to US</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"newAlbumName"</span>&gt;</span>New Album Name:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"newAlbumName"</span> <span class="attr">id</span>=<span class="string">"newAlbumName"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">placeholder</span>=<span class="string">"Enter new album name"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>Clone Album<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>我们看到此函数正在调用合并函数，该函数合并两个对象。如果我们尝试发送一个有效负载，该负载将覆盖现有函数（如“toString()”），然后如果我们在某个对象上调用它，它会导致服务器出现异常行为，该怎么办？</li>
<li>要准备有效负载，让我们采用一个简单的 JSON 代码，它将覆盖 toString 函数，如下所示：</li>
</ul>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line">{<span class="string">"__proto__"</span>: {<span class="string">"toString"</span>: <span class="string">"Just crash the server"</span>}}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>进入个人资料页面，输入 payload 代替新专辑名称，如下所示：</li>
</ul>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/0c526f55ae09c8a2edd3bb9424d67223.png" alt="clone album image"></p>
<ul>
<li>一旦 <code>app.js</code> 收到请求，解析 JSON，并在 friend 对象的 <code>__proto__</code> 属性中分配 <code>toString</code> 函数值，我们就解码有效负载。</li>
<li>这会产生异常行为，因为 <code>toString</code> 在不同对象中被广泛使用。当我们单击“克隆相册”时，应用程序崩溃，如下所示：</li>
</ul>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/63081473d800a1e88f5a46c40ed09aa5.png" alt="error screenshot after overriding the string"></p>
<ul>
<li>我们得到的 <code>TypeError</code> 是 <code>Object.prototype.toString.call</code> 不是一个函数，因为我们已经使用 Prototype 污染覆盖了该函数。</li>
<li>您可以覆盖其他几个内置对象/函数，如 <code>toJSON</code>、<code>valueOf</code>、<code>constructor</code> 等，但应用程序不会在所有行为中崩溃。这完全取决于您要覆盖的函数。</li>
</ul>
<p><strong>注意</strong>：要再次启动服务器，请访问 URL <code>http://10.10.168.64:8080</code> 来启动服务器。</p>
<h1 id="Automating-the-Process"><a href="#Automating-the-Process" class="headerlink" title="Automating the Process"></a>Automating the Process</h1><p>识别过程中的主要问题</p>
<p>识别原型污染在任何语言中都是一个棘手的问题，尤其是在 JavaScript 中，因为 JavaScript 允许一个</p>
<p>对象与另一个对象共享其功能。使用软件工具自动检测此问题非常困难，因为它不像其他常见的网站安全问题那样简单。每个网站或网络应用程序都是不同的，要找出原型污染可能发生的位置，需要有人仔细查看网站的代码，了解其工作原理，并查看可能出现错误的位置。</p>
<p>与其他可以通过寻找特定模式或迹象发现的安全问题不同，发现原型污染需要渗透测试人员/开发人员深入研究网站的代码。这一切都是为了了解 JavaScript 中对象相互影响的复杂方式，并发现可能出错的地方。安全工具可以帮助指出可能的问题，但它们无法捕捉到所有问题。这就是为什么拥有知道如何仔细阅读和分析代码的人如此重要的原因。</p>
<p>一些重要的脚本</p>
<p>安全和开源社区已经开发了几种工具和项目来帮助自动查找原型污染漏洞。以下是一些著名的 GitHub 存储库，它们提供了用于检测原型污染漏洞的工具、库或见解：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/ajinabraham/nodejsscan">NodeJsScan</a></strong> 是 Node.js 应用程序的静态安全代码扫描器。它包括对各种安全漏洞的检查，包括原型污染。将 NodeJsScan 集成到您的开发工作流程中可以帮助自动识别代码库中的潜在安全问题。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/KathanP19/protoscan"><strong>Prototype Pollution Scanner</strong></a> 是一种旨在扫描 JavaScript 代码以查找原型污染漏洞的工具。它可用于分析代码库中易受污染的模式，帮助开发人员识别和解决其应用程序中的潜在安全问题。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/dwisiswant0/ppfuzz"><strong>PPFuzz</strong></a> 是另一个模糊器，旨在自动检测 Web 应用程序中的原型污染漏洞。通过对可能与对象属性交互的输入向量进行模糊测试，<code>PPFuzz</code> 可以帮助识别应用程序中易受原型污染影响的点。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/BlackFan/client-side-prototype-pollution"><strong>BlackFan</strong></a> 的客户端检测专注于识别客户端 JavaScript 中的原型污染漏洞。它包括如何在浏览器中利用原型污染进行 XSS 攻击和其他恶意活动的示例。它是了解原型污染对客户端影响的宝贵资源。</li>
</ul>
<p>在识别原型污染时，渗透测试人员应寻找用户控制的输入可能影响正在合并、定义或克隆的键或属性的实例。验证应用程序是否正确清理并验证此类输入以防止修改原型链对于防止原型污染漏洞至关重要。</p>
<h1 id="Mitigation-Measures"><a href="#Mitigation-Measures" class="headerlink" title="Mitigation Measures"></a>Mitigation Measures</h1><p>减轻原型污染带来的风险对于渗透测试人员和安全代码开发人员都至关重要，因为该漏洞使攻击者能够操纵对象的原型，从而可能导致意外行为和安全问题。以下是一些原型污染缓解措施：</p>
<p>渗透测试人员</p>
<ul>
<li><strong>输入模糊测试和操纵</strong>：广泛与用户输入交互，尤其是用于与基于原型的结构交互的输入，并使用各种有效载荷对其进行模糊测试。寻找不受信任的数据可能导致原型污染的场景。</li>
<li><strong>上下文分析和有效载荷注入</strong>：分析应用程序的代码库，了解用户输入在基于原型的结构中的使用方式。将有效载荷注入这些上下文以测试原型污染漏洞。</li>
<li><strong>CSP 绕过和有效载荷注入</strong>：评估 CSP 等安全标头在减轻原型污染方面的有效性。尝试绕过 CSP 限制并注入有效载荷以操纵原型。</li>
<li><strong>依赖关系分析和利用</strong>：对应用程序使用的第三方库和依赖关系进行彻底分析。识别可能引入原型污染漏洞的过时或易受攻击的库。利用这些漏洞操纵原型并获得未经授权的访问或执行其他恶意操作。</li>
<li><strong>静态代码分析</strong>：在开发阶段使用静态代码分析工具识别潜在的原型污染漏洞。这些工具可以深入了解不安全的编码模式和潜在的安全风险。</li>
</ul>
<p>安全代码开发人员</p>
<ul>
<li>**避免使用 <strong>proto</strong>**：避免使用 <code>__proto__</code> 属性，因为它最容易受到原型污染。相反，使用 <code>Object.getPrototypeOf()</code> 以更安全的方式访问对象的原型。</li>
<li><strong>不可变对象</strong>：尽可能将对象设计为不可变的。这可以防止对原型进行意外修改，从而减少原型污染漏洞的影响。</li>
<li><strong>封装</strong>：封装对象及其功能，仅公开必要的接口。这有助于防止未经授权访问对象原型。</li>
<li><strong>使用安全默认值</strong>：创建对象时，建立安全默认值，避免依赖用户输入来设置原型属性。安全地初始化对象以最大限度地降低污染风险。</li>
<li><strong>输入清理</strong>：彻底清理和验证用户输入。使用用户控制的数据修改对象原型时要小心谨慎。应用严格的输入验证实践来降低注入风险。</li>
<li><strong>依赖管理</strong>：定期更新和监控依赖项。选择维护良好的库和框架，并随时了解与原型污染相关的任何安全更新或补丁。</li>
<li><strong>安全标头</strong>：实施安全标头（如内容安全策略 (CSP)）来控制可以从中加载资源的来源。这有助于降低加载操纵原型的恶意脚本的风险。</li>
</ul>
<p>通过结合严格的测试实践、安全编码原则和持续的安全意识，渗透测试人员和安全代码开发人员都可以为有效缓解应用程序中的原型污染漏洞做出贡献。定期更新有关新出现的威胁和漏洞的知识对于避免潜在风险至关重要。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://mikannse.space">Mikannse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://mikannse.space/2024/06/19/PrototypePollutionTHM/">http://mikannse.space/2024/06/19/PrototypePollutionTHM/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mikannse.space" target="_blank">MikannseのSekai</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><a class="post-meta__tags" href="/tags/Nodejs/">Nodejs</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/05/24-%EF%BC%96%E6%9D%82%E8%B0%88/" title="24-６杂谈"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">24-６杂谈</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/18/XXEInjectionTHM/" title="XXEInjectionTHM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">XXEInjectionTHM</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/06/15/AdvancedSQLInjectionTHM/" title="AdvancedSQLInjectionTHM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-15</div><div class="title">AdvancedSQLInjectionTHM</div></div></a></div><div><a href="/2023/11/17/Cross-Site%20Scripting%20(XSS)HTB/" title="Cross-Site Scripting (XSS)HTB"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-17</div><div class="title">Cross-Site Scripting (XSS)HTB</div></div></a></div><div><a href="/2024/03/14/ContainerVulnerabilitiesTHM/" title="ContainerVulnerabilitiesTHM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-14</div><div class="title">ContainerVulnerabilitiesTHM</div></div></a></div><div><a href="/2023/10/24/HackingWordPressHTB/" title="HackingWordPressHTB"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">HackingWordPressHTB</div></div></a></div><div><a href="/2024/04/02/IceTHM/" title="IceTHM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-02</div><div class="title">IceTHM</div></div></a></div><div><a href="/2023/11/15/Information%20Gathering%20-%20Web%20EditionHTB/" title="Information Gathering - Web EditionHTB"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-15</div><div class="title">Information Gathering - Web EditionHTB</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mikannse</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">313</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mikannse/mikannse.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">暂时没有公告QAQ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Essential-Recap"><span class="toc-number">2.</span> <span class="toc-text">Essential Recap</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#How-it-Works"><span class="toc-number">3.</span> <span class="toc-text">How it Works</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploitation-XSS"><span class="toc-number">4.</span> <span class="toc-text">Exploitation - XSS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploitation-Property-Injection"><span class="toc-number">5.</span> <span class="toc-text">Exploitation - Property Injection</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploitation-Denial-of-Service"><span class="toc-number">6.</span> <span class="toc-text">Exploitation - Denial of Service</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Automating-the-Process"><span class="toc-number">7.</span> <span class="toc-text">Automating the Process</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mitigation-Measures"><span class="toc-number">8.</span> <span class="toc-text">Mitigation Measures</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/25/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%85%AD%E7%AB%A0%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E6%8A%93%E5%8F%96/" title="Python3爬虫开发笔记第六章动态渲染页面抓取">Python3爬虫开发笔记第六章动态渲染页面抓取</a><time datetime="2024-12-25T15:31:25.000Z" title="发表于 2024-12-25 23:31:25">2024-12-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/21/Wiki.js%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E5%8F%8Anginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/" title="Wiki.js云服务器部署及nginx反向代理配置">Wiki.js云服务器部署及nginx反向代理配置</a><time datetime="2024-12-21T03:20:41.000Z" title="发表于 2024-12-21 11:20:41">2024-12-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/17/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%BA%94%E7%AB%A0Ajax%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/" title="Python3爬虫开发笔记第五章Ajax数据爬取">Python3爬虫开发笔记第五章Ajax数据爬取</a><time datetime="2024-12-17T13:56:19.000Z" title="发表于 2024-12-17 21:56:19">2024-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/14/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E7%AB%A0%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" title="Python3爬虫开发笔记第四章数据存储">Python3爬虫开发笔记第四章数据存储</a><time datetime="2024-12-14T15:40:04.000Z" title="发表于 2024-12-14 23:40:04">2024-12-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/14/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%89%E7%AB%A0%E8%A7%A3%E6%9E%90%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Python3爬虫开发笔记第三章解析库的使用">Python3爬虫开发笔记第三章解析库的使用</a><time datetime="2024-12-14T06:33:42.000Z" title="发表于 2024-12-14 14:33:42">2024-12-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Mikannse</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'http://mikannse.space/2024/06/19/PrototypePollutionTHM/'
    this.page.identifier = '/2024/06/19/PrototypePollutionTHM/'
    this.page.title = 'PrototypePollutionTHM'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>