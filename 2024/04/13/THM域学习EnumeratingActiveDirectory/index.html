<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>THM域学习EnumeratingActiveDirectory | MikannseのSekai</title><meta name="author" content="Mikannse"><meta name="copyright" content="Mikannse"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Why AD Enumeration该网络是 Breaching AD 网络的延续。 请确保先完成此网络，然后再继续此操作。 另请注意，我们将广泛讨论 AD 对象。 如果您需要复习一下，请快速浏览一下这个房间。 现在我们有了第一组有效的 Active Directory (AD) 凭据，我们将探索可用于枚举 AD 的不同方法。 AD枚举 一旦我们拥有第一组 AD 凭据以及在网络上使用它们进行身份验">
<meta property="og:type" content="article">
<meta property="og:title" content="THM域学习EnumeratingActiveDirectory">
<meta property="og:url" content="http://mikannse.space/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/index.html">
<meta property="og:site_name" content="MikannseのSekai">
<meta property="og:description" content="Why AD Enumeration该网络是 Breaching AD 网络的延续。 请确保先完成此网络，然后再继续此操作。 另请注意，我们将广泛讨论 AD 对象。 如果您需要复习一下，请快速浏览一下这个房间。 现在我们有了第一组有效的 Active Directory (AD) 凭据，我们将探索可用于枚举 AD 的不同方法。 AD枚举 一旦我们拥有第一组 AD 凭据以及在网络上使用它们进行身份验">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg">
<meta property="article:published_time" content="2024-04-13T03:12:25.000Z">
<meta property="article:modified_time" content="2024-07-14T13:00:49.681Z">
<meta property="article:author" content="Mikannse">
<meta property="article:tag" content="渗透测试">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="Domain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="http://mikannse.space/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Mikannse","link":"链接: ","source":"来源: MikannseのSekai","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'THM域学习EnumeratingActiveDirectory',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-07-14 21:00:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">309</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="MikannseのSekai"><span class="site-name">MikannseのSekai</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">THM域学习EnumeratingActiveDirectory</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-13T03:12:25.000Z" title="发表于 2024-04-13 11:12:25">2024-04-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-14T13:00:49.681Z" title="更新于 2024-07-14 21:00:49">2024-07-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E5%AE%89/">网安</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>32分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="THM域学习EnumeratingActiveDirectory"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Why-AD-Enumeration"><a href="#Why-AD-Enumeration" class="headerlink" title="Why AD Enumeration"></a>Why AD Enumeration</h1><p>该网络是 <a target="_blank" rel="noopener" href="https://tryhackme.com/jr/breachingad">Breaching AD</a> 网络的延续。 请确保先完成此网络，然后再继续此操作。 另请注意，我们将广泛讨论 AD 对象。 如果您需要复习一下，请快速浏览一下<a target="_blank" rel="noopener" href="https://tryhackme.com/jr/activedirectorybasics">这个房间。 </a>现在我们有了第一组有效的 Active Directory (AD) 凭据，我们将探索可用于枚举 AD 的不同方法。</p>
<p>AD枚举</p>
<p>一旦我们拥有第一组 AD 凭据以及在网络上使用它们进行身份验证的方法，一个全新的可能性世界就会打开！ 我们可以开始枚举有关经过身份验证的访问（甚至是超低权限访问）的 AD 设置和结构的各种详细信息。</p>
<p>在红队参与期间，这通常会导致我们能够执行某种形式的权限升级或横向移动以获得额外的访问权限，直到我们有足够的权限来执行和实现我们的目标。 在大多数情况下，枚举和利用紧密地交织在一起。 一旦利用了枚举阶段显示的攻击路径，就会从这个新的特权位置再次执行枚举，如下图所示。</p>
<p>学习目标<br>在此网络中，我们将介绍几种可用于枚举 AD 的方法。 这绝不是一个完整的列表，因为可用的方法通常是高度情境化的，并且依赖于所获得的违规行为。 但是，我们将介绍以下枚举 AD 的技术：</p>
<ul>
<li>Microsoft 管理控制台的 AD 管理单元。</li>
<li>命令提示符的网络命令。</li>
<li>PowerShell 的 AD-RSAT cmdlet。</li>
<li>Bloodhound。</li>
</ul>
<h1 id="Credential-Injection"><a href="#Credential-Injection" class="headerlink" title="Credential Injection"></a>Credential Injection</h1><p>在讨论 AD 对象和枚举之前，我们首先讨论凭据注入方法。 从破坏 AD 网络中，您会发现凭据通常可以在不损害加入域的计算机的情况下找到。 特定的枚举技术可能需要特定的设置才能工作。</p>
<p>Windows 与 Linux</p>
<p><em>“知敌知己，则不惧百战；知己不知敌，百胜必败。”</em>——《孙子兵法》 。</p>
<p>在 Kali 机器上进行 AD 枚举可以取得令人难以置信的成果。 尽管如此，如果你真的想进行深入的枚举甚至利用，你需要了解和模仿你的敌人。 因此，您需要一台 Windows 计算机。 这将使我们能够使用几种内置方法来进行枚举和利用。 在此网络中，我们将探索这些内置工具之一，称为“runas.exe”二进制文件。</p>
<p>鲁纳斯解释</p>
<p>您是否曾经发现过 AD 凭据但无处可登录？ Runas 可能就是您一直在寻找的答案！</p>
<p>在安全评估中，您通常可以访问网络并刚刚发现 AD 凭据，但没有方法或权限来创建新的加入域的计算机。 因此，我们需要能够在我们控制的 Windows 计算机上使用这些凭据。</p>
<p>如果我们有 <username>:<password> 格式的 AD 凭据，我们可以使用 Runas（一个合法的 Windows 二进制文件）将凭据注入到内存中。 通常的 Runas 命令看起来像这样：</password></username></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">runas.exe /netonly /user:&lt;domain&gt;\&lt;username&gt; cmd.exe</span><br></pre></td></tr></tbody></table></figure>

<p>我们看一下参数：</p>
<ul>
<li><strong>/netonly</strong> - 由于我们没有加入域，因此我们希望加载网络身份验证的凭据，但不针对域控制器进行身份验证。 因此，在计算机上本地执行的命令将在标准 Windows 帐户的上下文中运行，但任何网络连接都将使用此处指定的帐户进行。</li>
<li><strong>/user</strong> - 在这里，我们提供域和用户名的详细信息。 使用完全限定域名 (FQDN) 而不仅仅是域的 NetBIOS 名称始终是一个安全的选择，因为这将有助于解决问题。</li>
<li><strong>cmd.exe</strong> - 这是我们在注入凭据后要执行的程序。 这可以更改为任何内容，但最安全的选择是 cmd.exe，因为您可以使用它来启动您想要的任何内容，并注入凭据。</li>
</ul>
<p>运行此命令后，系统将提示您提供密码。 请注意，由于我们添加了 /netonly 参数，因此域控制器不会直接验证凭据，因此它将接受任何密码。 我们仍然需要确认网络凭据是否已成功且正确加载。</p>
<p><strong>注意：</strong> 如果您使用自己的 Windows 计算机，则应确保以管理员身份运行第一个命令提示符。 这会将管理员令牌注入到 CMD 中。 如果您运行需要 Runas 生成的 CMD 本地管理权限的工具，则令牌将已经可用。 这不会为您提供网络管理权限，但会确保您执行的任何本地命令都将以管理权限执行。</p>
<p>始终是 DNS</p>
<p><strong>注意：</strong> 仅当您使用自己的 Windows 计算机进行练习时才需要执行这些后续步骤。 然而，学习如何表演是很好的知识，因为它可能对红队练习有帮助。</p>
<p>提供密码后，将打开一个新的命令提示符窗口。 现在我们仍然需要验证我们的凭据是否有效。 最可靠的方法是列出 SYSVOL。 任何 AD 帐户，无论权限有多低，都可以读取 SYSVOL 目录的内容。</p>
<p>SYSVOL 是所有域控制器上都存在的文件夹。 它是一个共享文件夹，存储组策略对象 (GPO) 和信息以及任何其他域相关的脚本。 它是 Active Directory 的重要组件，因为它将这些 GPO 传递到域中的所有计算机。 然后，加入域的计算机可以读取这些 GPO 并应用适用的 GPO，从而从中央位置进行域范围的配置更改。</p>
<p>在列出 SYSVOL 之前，我们需要配置 DNS。 有时您很幸运，内部 DNS 会通过 DHCP 或 VPN 连接自动为您配置，但并非总是如此（例如此 TryHackMe 网络）。 最好了解如何手动执行此操作。 对于 DNS 服务器来说，最安全的选择通常是域控制器。 使用域控制器的IP，我们可以在PowerShell窗口中执行以下命令：</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable">$dnsip</span> = <span class="string">"&lt;DC IP&gt;"</span></span><br><span class="line"><span class="variable">$index</span> = <span class="built_in">Get-NetAdapter</span> <span class="literal">-Name</span> <span class="string">'Ethernet'</span> | <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> <span class="string">'ifIndex'</span></span><br><span class="line"><span class="built_in">Set-DnsClientServerAddress</span> <span class="literal">-InterfaceIndex</span> <span class="variable">$index</span> <span class="literal">-ServerAddresses</span> <span class="variable">$dnsip</span></span><br></pre></td></tr></tbody></table></figure>

<p>当然，“以太网”将是连接到 TryHackMe 网络的任何接口。 我们可以通过运行以下命令来验证 DNS 是否正常工作：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt; nslookup za.tryhackme.com</span><br></pre></td></tr></tbody></table></figure>

<p>现在应该解析为 DC IP，因为这是托管 FQDN 的位置。 现在 DNS 正在运行，我们终于可以测试我们的凭据了。 我们可以使用以下命令强制基于网络列出 SYSVOL 目录：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Tools&gt;dir \\za.tryhackme.com\SYSVOL\</span><br><span class="line"> Volume in drive \\za.tryhackme.com\SYSVOL is Windows</span><br><span class="line"> Volume Serial Number is 1634-22A9</span><br><span class="line"></span><br><span class="line"> Directory of \\za.tryhackme.com\SYSVOL</span><br><span class="line"></span><br><span class="line">02/24/2022  09:57 PM    &lt;DIR&gt;          .</span><br><span class="line">02/24/2022  09:57 PM    &lt;DIR&gt;          ..</span><br><span class="line">02/24/2022  09:57 PM    &lt;JUNCTION&gt;     za.tryhackme.com [C:\Windows\SYSVOL\domain]</span><br><span class="line">               0 File(s)              0 bytes</span><br><span class="line">               3 Dir(s)  51,835,408,384 bytes free</span><br></pre></td></tr></tbody></table></figure>

<p>我们现在不会太深入地了解 SYSVOL 的内容，但请注意，枚举其内容也很好，因为那里可能潜伏着一些额外的 AD 凭据。</p>
<p>IP vs Hostnames</p>
<p><strong>问题：</strong> <em><code>dir \\za.tryhackme.com\SYSVOL</code> 和 <code>dir \\&lt;DC IP&gt;\SYSVOL</code> 之间有区别吗</em> <em>为什么 DNS 这么大惊小怪？</em></p>
<p>有很大的区别，这可以归结为所使用的身份验证方法。 当我们提供主机名时，网络身份验证将首先尝试执行 Kerberos 身份验证。 由于 Kerberos 身份验证使用嵌入在票证中的主机名，因此如果我们提供 IP，则可以强制身份验证类型为 NTLM。 虽然从表面上看，这对我们来说并不重要，但了解这些细微的差异是有好处的，因为它们可以让您在红队评估期间保持更加隐秘。 在某些情况下，组织将监控 OverPass 和 Pass-The-Hash 攻击。 强制进行 NTLM 身份验证是本书中介绍的一个很好的技巧，可以避免在这些情况下被检测到。</p>
<p>使用注入的凭据</p>
<p>现在我们已经将 AD 凭据注入到内存中，这就是乐趣的开始。 使用 /netonly 选项，所有网络通信都将使用这些注入的凭据进行身份验证。 这包括从该命令提示符窗口执行的应用程序的所有网络通信。</p>
<p>这就是它变得强大的地方。 您是否曾经遇到过 MS SQL 数据库使用 Windows 身份验证，而您未加入域的情况？ 从该命令提示符启动 MS SQL Studio； 即使它显示您的本地用户名，单击“登录”，它将在后台使用 AD 凭据进行身份验证！ 我们甚至可以使用它来<a target="_blank" rel="noopener" href="https://labs.f-secure.com/blog/pth-attacks-against-ntlm-authenticated-web-applications/">对使用 NTLM 身份验证的 Web 应用程序进行身份验证</a>。</p>
<p>我们将在下一个任务中使用它来实现我们的第一个 AD 枚举技术。</p>
<h1 id="Enumeration-through-Microsoft-Management-Console"><a href="#Enumeration-through-Microsoft-Management-Console" class="headerlink" title="Enumeration through Microsoft Management Console"></a>Enumeration through Microsoft Management Console</h1><p>您现在应该已经完成了 <a target="_blank" rel="noopener" href="https://tryhackme.com/jr/activedirectorybasics">AD 基础知识室</a>，其中最初介绍了不同的 AD 对象。 在此任务中，假设您了解这些对象是什么。 使用 RDP 和您在任务 1 中配置的凭据连接到 THMJMP1 以执行此任务。</p>
<p>微软管理控制台</p>
<p>在此任务中，我们将探索第一个枚举方法，这是直到最后一个任务为止唯一使用 GUI 的方法。 我们将使用 Microsoft 管理控制台 (MMC) 和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">远程服务器管理工具</a> (RSAT ) AD 管理单元。 如果您使用提供的 Windows VM (THMJMP1)，则它已为您安装。 但是，如果您使用自己的 Windows 计算机，则可以执行以下步骤来安装管理单元：</p>
<ol>
<li>按<strong>开始</strong></li>
<li>搜索<strong>“应用程序和功能”</strong>并按 Enter</li>
<li>单击“<strong>管理可选功能</strong>”</li>
<li>单击“<strong>添加功能</strong>”</li>
<li>搜索 <strong>“RSAT”</strong></li>
<li>选择“<strong>RSAT：Active Directory 域服务和轻量级目录工具”</strong>，然后单击“<strong>安装</strong>”</li>
</ol>
<p>您可以通过使用 Windows“开始”按钮、搜索“运行”并键入 MMC 来启动 MMC。 如果我们只是正常运行 MMC，它将无法工作，因为我们的计算机未加入域，并且我们的本地帐户无法用于对域进行身份验证。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/dd93acc5bf807d120eb083d2250e77ef.png" alt="MMC failed start due to credentials"></p>
<p>这就是上一个任务中的 Runas 窗口发挥作用的地方。 在该窗口中，我们可以启动 MMC，这将确保所有 MMC 网络连接都将使用我们注入的 AD 凭据。</p>
<p>在 MMC 中，我们现在可以附加 AD RSAT 管理单元：</p>
<ol>
<li>单击 <strong>文件</strong> -&gt; <strong>添加/删除管理单元</strong></li>
<li>选择并<strong>添加</strong>所有三个 Active Directory 管理单元</li>
<li>单击所有错误和警告</li>
<li>右键单击 <strong>Active Directory 域和信任</strong>，然后选择 <strong>更改林</strong></li>
<li>输入 <em>za.tryhackme.com</em> 作为 <strong>根域</strong>，然后单击 <strong>确定</strong></li>
<li>右键单击 <strong>Active Directory 站点和服务</strong>，然后选择 <strong>更改林</strong></li>
<li>输入 <em>za.tryhackme.com</em> 作为 <strong>根域</strong>，然后单击“确定”</li>
<li>右键单击 <strong>Active Directory 用户和计算机</strong>，然后选择 <strong>更改域</strong></li>
<li>输入 <em>za.tryhackme.com</em> 作为 <strong>域名</strong>，然后单击 <strong>确定</strong></li>
<li>右键单击左侧窗格中的 <strong>Active Directory 用户和计算机</strong></li>
<li>单击 <strong>查看</strong> -&gt; <strong>高级功能</strong></li>
</ol>
<p>如果到目前为止一切正常，您的 MMC 现在应该指向目标域并对其进行身份验证：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/da8bba5a4df58baf0045d4a71db37e05.png" alt="MMC AD Snap-in"></p>
<p>我们现在可以开始在这里枚举有关 AD 结构的信息。</p>
<p>用户和计算机</p>
<p>让我们看一下Active Directory 的结构。 对于此任务，我们将重点关注 AD 用户和计算机。 展开该管理单元并展开 za 域以查看初始组织单位 (OU) 结构：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/a5fc9efbd6a77ee9ea72a25d7ba13240.png" alt="MMC AD Snap-in"></p>
<p>让我们看一下 People 目录。 这里我们看到用户是按照部门OU来划分的。 单击每个 OU 将显示属于该部门的用户。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/993c161b6d86d61bf5ecc31a0ce0fa54.png" alt="MMC AD Snap-in"></p>
<p>单击这些用户中的任何一个都将允许我们查看他们的所有属性和属性。 我们还可以查看他们属于哪些组：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/659127fd61749667192a19e0fb71ad55.png" alt="MMC AD Snap-in"></p>
<p>我们还可以使用 MMC 来查找环境中的主机。 如果我们单击“服务器”或“工作站”，将显示加入域的计算机的列表。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/9e353f21616effb4a9cca2f3e86e65ad.png" alt="MMC AD Snap-in"></p>
<p>如果我们有相关权限，我们还可以使用MMC直接对AD进行更改，例如更改用户的密码或将帐户添加到特定组。 使用 MMC 来更好地理解 AD 域结构。 利用搜索功能来寻找对象。</p>
<p>好处</p>
<ul>
<li>GUI 提供了一种获得 AD 环境整体视图的绝佳方法。</li>
<li>可以快速搜索不同的AD对象。</li>
<li>提供直接查看AD对象具体更新的方法。</li>
<li>如果我们有足够的权限，我们可以直接更新现有的AD对象或添加新的。</li>
</ul>
<p>缺点</p>
<ul>
<li>GUI 需要 RDP 访问执行它的计算机。</li>
<li>尽管搜索对象速度很快，但无法执行收集 AD 范围内的特性或属性。</li>
</ul>
<h1 id="Enumeration-through-Command-Prompt"><a href="#Enumeration-through-Command-Prompt" class="headerlink" title="Enumeration through Command Prompt"></a>Enumeration through Command Prompt</h1><p>命令提示符</p>
<p>有时，您只需要执行快速而肮脏的 AD 查找，命令提示符可以为您提供帮助。 当您可能无法通过 RDP 访问系统、防御者正在监视 PowerShell 的使用，并且您需要通过远程访问特洛伊木马 (RAT) 执行 AD 枚举时，优秀可靠的 CMD 会非常方便。 在网络钓鱼负载中嵌入几个简单的 AD 枚举命令甚至会很有帮助，以帮助您获得重要信息，从而帮助您发起最终攻击。</p>
<p>CMD 有一个内置命令，我们可以使用它来枚举有关 AD 的信息，即“net”。 “net”命令是一个方便的工具，用于枚举有关本地系统和 AD 的信息。 我们将看看从这个位置可以列举的一些有趣的事情，但这并不是一个详尽的列表。</p>
<p><strong>注意：对于此任务，您必须使用 THMJMP1，并且无法使用您自己的 Windows VM。 这将在缺点中解释。</strong></p>
<p>用户</p>
<p>我们可以使用“net”命令通过“user”子选项列出AD域中的所有用户：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;net user /domain</span><br><span class="line">The request will be processed at a domain controller for domain za.tryhackme.com</span><br><span class="line"></span><br><span class="line">User accounts for \\THMDC</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">aaron.conway             aaron.hancock            aaron.harris</span><br><span class="line">aaron.johnson            aaron.lewis              aaron.moore</span><br><span class="line">aaron.patel              aaron.smith              abbie.joyce</span><br><span class="line">abbie.robertson          abbie.taylor             abbie.walker</span><br><span class="line">abdul.akhtar             abdul.bates              abdul.holt</span><br><span class="line">abdul.jones              abdul.wall               abdul.west</span><br><span class="line">abdul.wilson             abigail.cox              abigail.cox1</span><br><span class="line">abigail.smith            abigail.ward             abigail.wheeler</span><br><span class="line">[....]</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></tbody></table></figure>

<p>这将为我们返回所有 AD 用户，并有助于确定域的大小以进行进一步的攻击。 我们还可以使用此子选项来枚举有关单个用户帐户的更详细信息：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;net user zoe.marshall /domain</span><br><span class="line">The request will be processed at a domain controller for domain za.tryhackme.com</span><br><span class="line"></span><br><span class="line">User name                    zoe.marshall</span><br><span class="line">Full Name                    Zoe Marshall</span><br><span class="line">Comment</span><br><span class="line">User's comment</span><br><span class="line">Country/region code          000 (System Default)</span><br><span class="line">Account active               Yes</span><br><span class="line">Account expires              Never</span><br><span class="line"></span><br><span class="line">Password last set            2/24/2022 10:06:06 PM</span><br><span class="line">Password expires             Never</span><br><span class="line">Password changeable          2/24/2022 10:06:06 PM</span><br><span class="line">Password required            Yes</span><br><span class="line">User may change password     Yes</span><br><span class="line"></span><br><span class="line">Workstations allowed         All</span><br><span class="line">Logon script</span><br><span class="line">User profile</span><br><span class="line">Home directory</span><br><span class="line">Last logon                   Never</span><br><span class="line"></span><br><span class="line">Logon hours allowed          All</span><br><span class="line"></span><br><span class="line">Local Group Memberships</span><br><span class="line">Global Group memberships     *Domain Users         *Internet Access</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意：</strong> 如果用户只是少数 AD 组的一部分，此命令将能够向我们显示组成员身份。 但是，通常，在超过十个组成员身份后，该命令将无法列出所有组成员。</p>
<p>团体</p>
<p>我们可以使用“net”命令通过使用“group”子选项来枚举域的组：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;net group /domain</span><br><span class="line">The request will be processed at a domain controller for domain za.tryhackme.com</span><br><span class="line"></span><br><span class="line">Group Accounts for \\THMDC</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">*Cloneable Domain Controllers</span><br><span class="line">*DnsUpdateProxy</span><br><span class="line">*Domain Admins</span><br><span class="line">*Domain Computers</span><br><span class="line">*Domain Controllers</span><br><span class="line">*Domain Guests</span><br><span class="line">*Domain Users</span><br><span class="line">[...]</span><br><span class="line">*Schema Admins</span><br><span class="line">*Server Admins</span><br><span class="line">*Tier 0 Admins</span><br><span class="line">*Tier 1 Admins</span><br><span class="line">*Tier 2 Admins</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></tbody></table></figure>

<p>这些信息可以帮助我们找到目标执行的特定群体。 我们还可以通过在同一命令中指定组来枚举更多详细信息，例如组的成员身份：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;net group "Tier 1 Admins" /domain</span><br><span class="line">The request will be processed at a domain controller for domain za.tryhackme.com</span><br><span class="line"></span><br><span class="line">Group name     Tier 1 Admins</span><br><span class="line">Comment</span><br><span class="line"></span><br><span class="line">Members</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">t1_arthur.tyler          t1_gary.moss             t1_henry.miller</span><br><span class="line">t1_jill.wallis           t1_joel.stephenson       t1_marian.yates</span><br><span class="line">t1_rosie.bryant</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></tbody></table></figure>

<p>密码政策</p>
<p>我们可以使用“net”命令通过“accounts”子选项枚举域的密码策略：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;net accounts /domain</span><br><span class="line">The request will be processed at a domain controller for domain za.tryhackme.com</span><br><span class="line"></span><br><span class="line">Force user logoff how long after time expires?:       Never</span><br><span class="line">Minimum password age (days):                          0</span><br><span class="line">Maximum password age (days):                          Unlimited</span><br><span class="line">Minimum password length:                              0</span><br><span class="line">Length of password history maintained:                None</span><br><span class="line">Lockout threshold:                                    Never</span><br><span class="line">Lockout duration (minutes):                           30</span><br><span class="line">Lockout observation window (minutes):                 30</span><br><span class="line">Computer role:                                        PRIMARY</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></tbody></table></figure>

<p>这将为我们提供有用的信息，例如：</p>
<ul>
<li>保留密码历史记录的长度。 这意味着用户必须提供多少个唯一密码才能重新使用旧密码。</li>
<li>错误密码尝试的锁定阈值以及帐户将被锁定的时间。</li>
<li>密码的最小长度。</li>
<li>允许密码达到的最长期限，指示密码是否必须定期轮换。</li>
</ul>
<p>如果我们想对我们现在列举的其他用户帐户进行额外的密码喷射攻击，那么这些信息可以使我们受益。 它可以帮助我们更好地猜测在攻击中应该使用哪些单一密码，以及在冒锁定帐户的风险之前可以运行多少次攻击。 但是，应该注意的是，如果我们执行盲目密码喷射攻击，我们可能会锁定帐户，因为我们没有检查以确定特定帐户在被锁定之前还剩多少次尝试。</p>
<p>您可以在<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/networking/net-commands-on-operating-systems">此处</a>找到与 net 命令相关的全部选项。 使用这些网络命令来收集有关特定用户和组的信息。</p>
<p>好处</p>
<ul>
<li>不需要额外或外部工具，并且蓝队通常不会监控这些简单的命令。</li>
<li>我们不需要 GUI 来执行此枚举。</li>
<li>VBScript 和其他常用于网络钓鱼有效负载的宏语言本身支持这些命令，因此它们可用于在制作更具体的有效负载之前枚举有关 AD 域的初始信息。</li>
</ul>
<p>缺点</p>
<ul>
<li>“net”命令必须从加入域的计算机执行。 如果计算机未加入域，则它将默认为 WORKGROUP 域。</li>
<li><code>net</code> 命令可能不会显示所有信息。 例如，如果用户是十多个组的成员，则并非所有这些组都会显示在输出中。</li>
</ul>
<h1 id="Enumeration-through-PowerShell"><a href="#Enumeration-through-PowerShell" class="headerlink" title="Enumeration through PowerShell"></a>Enumeration through PowerShell</h1><p>电源外壳</p>
<p>PowerShell 是命令提示符的升级版。 Microsoft 于 2006 年首次发布它。虽然 PowerShell 具有命令提示符提供的所有标准功能，但它还提供对 cmdlet（发音为 command-let）的访问，这些 cmdlet 是用于执行特定功能的 .NET 类。 虽然我们可以编写自己的 cmdlet，就像 <a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView">PowerView</a> 的创建者所做的那样，但我们已经可以使用内置的 cmdlet 取得很大的进展。</p>
<p>由于我们在任务 3 中安装了 AD-RSAT 工具，它会自动为我们安装关联的 cmdlet。 安装了 50 多个 cmdlet。 我们将研究其中的一些，但请参阅[此列表以获取完整的 cmdlet 列表。</p>
<p>使用我们的 SSH 终端，我们可以使用以下命令将其升级到 PowerShell 终端：<code>powershell</code></p>
<p>用户</p>
<p>我们可以使用“Get-ADUser”cmdlet 来枚举 AD 用户：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADUser -Identity gordon.stevens -Server za.tryhackme.com -Properties *</span><br><span class="line"></span><br><span class="line">AccountExpirationDate                :</span><br><span class="line">accountExpires                       : 9223372036854775807</span><br><span class="line">AccountLockoutTime                   :</span><br><span class="line">[...]</span><br><span class="line">Deleted                              :</span><br><span class="line">Department                           : Consulting</span><br><span class="line">Description                          :</span><br><span class="line">DisplayName                          : Gordon Stevens</span><br><span class="line">DistinguishedName                    : CN=gordon.stevens,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=com</span><br><span class="line">[...]</span><br></pre></td></tr></tbody></table></figure>

<p>这些参数用于以下用途：</p>
<ul>
<li>-Identity  我们正在枚举的帐户名称</li>
<li>-Properties 将显示与帐户关联的哪些属性，* 将显示所有属性</li>
<li>-Server  由于我们没有加入域，因此我们必须使用此参数将其指向我们的域控制器</li>
</ul>
<p>对于大多数这些 cmdlet，我们还可以使用“-Filter”参数来对枚举进行更多控制，并使用“Format-Table”cmdlet 来整齐地显示结果，如下所示：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADUser -Filter 'Name -like "*stevens"' -Server za.tryhackme.com | Format-Table Name,SamAccountName -A</span><br><span class="line"></span><br><span class="line">Name             SamAccountName</span><br><span class="line">----             --------------</span><br><span class="line">chloe.stevens    chloe.stevens</span><br><span class="line">samantha.stevens samantha.stevens</span><br><span class="line">[...]</span><br><span class="line">janice.stevens   janice.stevens</span><br><span class="line">gordon.stevens   gordon.stevens</span><br></pre></td></tr></tbody></table></figure>

<p>团体</p>
<p>我们可以使用“Get-ADGroup”cmdlet 来枚举 AD 组：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADGroup -Identity Administrators -Server za.tryhackme.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=Administrators,CN=Builtin,DC=za,DC=tryhackme,DC=com</span><br><span class="line">GroupCategory     : Security</span><br><span class="line">GroupScope        : DomainLocal</span><br><span class="line">Name              : Administrators</span><br><span class="line">ObjectClass       : group</span><br><span class="line">ObjectGUID        : f4d1cbcd-4a6f-4531-8550-0394c3273c4f</span><br><span class="line">SamAccountName    : Administrators</span><br><span class="line">SID               : S-1-5-32-544</span><br></pre></td></tr></tbody></table></figure>

<p>我们还可以使用 Get-ADGroupMember cmdlet 枚举组成员身份：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADGroupMember -Identity Administrators -Server za.tryhackme.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">distinguishedName : CN=Domain Admins,CN=Users,DC=za,DC=tryhackme,DC=com</span><br><span class="line"></span><br><span class="line">name              : Domain Admins</span><br><span class="line">objectClass       : group</span><br><span class="line">objectGUID        : 8a6186e5-e20f-4f13-b1b0-067f3326f67c</span><br><span class="line">SamAccountName    : Domain Admins</span><br><span class="line">SID               : S-1-5-21-3330634377-1326264276-632209373-512</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">distinguishedName : CN=Administrator,CN=Users,DC=za,DC=tryhackme,DC=com name              : Administrator</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : b10fe384-bcce-450b-85c8-218e3c79b30fSamAccountName    : Administrator</span><br><span class="line">SID               : S-1-5-21-3330634377-1326264276-632209373-500</span><br></pre></td></tr></tbody></table></figure>

<p>AD对象</p>
<p>可以使用“Get-ADObject” cmdlet 对任何 AD 对象执行更通用的搜索。 例如，如果我们正在查找在特定日期之后更改的所有 AD 对象：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; $ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)</span><br><span class="line">PS C:\&gt; Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server za.tryhackme.com</span><br><span class="line"></span><br><span class="line">Deleted           :</span><br><span class="line">DistinguishedName : DC=za,DC=tryhackme,DC=com</span><br><span class="line">Name              : za</span><br><span class="line">ObjectClass       : domainDNS</span><br><span class="line">ObjectGUID        : 518ee1e7-f427-4e91-a081-bb75e655ce7a</span><br><span class="line"></span><br><span class="line">Deleted           :</span><br><span class="line">DistinguishedName : CN=Administrator,CN=Users,DC=za,DC=tryhackme,DC=com</span><br><span class="line">Name              : Administrator</span><br><span class="line">ObjectClass       : user</span><br><span class="line">ObjectGUID        : b10fe384-bcce-450b-85c8-218e3c79b30f</span><br></pre></td></tr></tbody></table></figure>

<p>例如，如果我们想在不锁定帐户的情况下执行密码喷射攻击，我们可以使用它来枚举 badPwdCount 大于 0 的帐户，以避免这些帐户参与我们的攻击：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADObject -Filter 'badPwdCount -gt 0' -Server za.tryhackme.com</span><br><span class="line">PS C:\&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>仅当网络中的用户之一多次错误输入密码时，才会显示结果。</p>
<p>域名</p>
<p>我们可以使用“Get-ADDomain”来检索有关特定域的附加信息：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADDomain -Server za.tryhackme.com</span><br><span class="line"></span><br><span class="line">AllowedDNSSuffixes                 : {}</span><br><span class="line">ChildDomains                       : {}</span><br><span class="line">ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=com</span><br><span class="line">DeletedObjectsContainer            : CN=Deleted Objects,DC=za,DC=tryhackme,DC=com</span><br><span class="line">DistinguishedName                  : DC=za,DC=tryhackme,DC=com</span><br><span class="line">DNSRoot                            : za.tryhackme.com</span><br><span class="line">DomainControllersContainer         : OU=Domain Controllers,DC=za,DC=tryhackme,DC=com</span><br><span class="line">[...]</span><br><span class="line">UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=com</span><br></pre></td></tr></tbody></table></figure>

<p>更改 AD 对象</p>
<p>AD-RSAT cmdlet 的优点在于，有些 cmdlet 甚至允许您创建新的或更改现有的 AD 对象。 然而，我们对该网络的关注点是枚举。 创建新对象或更改现有对象将被视为 AD 开发，稍后将在 AD 模块中介绍。</p>
<p>但是，我们将通过使用“Set-ADAccountPassword” cmdlet 强制更改 AD 用户的密码来展示此示例：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">PS C:\&gt; Set-ADAccountPassword -Identity gordon.stevens -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)</span><br></pre></td></tr></tbody></table></figure>

<p>请记住更改您在任务 1 中的经销商网页上提供的用于枚举的帐户的身份值和密码。</p>
<p>好处</p>
<ul>
<li>PowerShell cmdlet 可以枚举比命令提示符中的 net 命令更多的信息。</li>
<li>我们可以指定服务器和域来使用未加入域的计算机上的 runas 执行这些命令。</li>
<li>我们可以创建自己的 cmdlet 来枚举特定信息。</li>
<li>我们可以使用 AD-RSAT cmdlet 直接更改 AD 对象，例如重置密码或将用户添加到特定组。</li>
</ul>
<p>缺点</p>
<ul>
<li>与命令提示符相比，蓝队通常更多地监控 PowerShell。</li>
<li>我们必须安装 AD-RSAT 工具或使用其他可能可检测的脚本进行 PowerShell 枚举。</li>
</ul>
<h1 id="Enumeration-through-Bloodhound"><a href="#Enumeration-through-Bloodhound" class="headerlink" title="Enumeration through Bloodhound"></a>Enumeration through Bloodhound</h1><p>最后，我们将研究使用 <a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a> 执行 AD 枚举。 Bloodhound 是迄今为止最强大的 AD 枚举工具，当它于 2016 年发布时，它永远改变了 AD 枚举格局。</p>
<p>Bloodhound History</p>
<p>在相当长的一段时间内，红队队员（不幸的是，攻击者）占据了上风。 以至于微软在其高级威胁防护解决方案中集成了他们自己版本的 Bloodhound。 这一切都归结为以下这句话：</p>
<p><em>“防御者用列表思考，攻击者用图表思考。” - 未知</em></p>
<p>Bloodhound 允许攻击者（现在也包括防御者）通过互连节点以图形格式可视化 AD 环境。 每个连接都是一条可能的路径，可用于实现目标。 相比之下，防御者使用列表，例如域管理员列表或环境中所有主机的列表。</p>
<p>这种基于图的思维为攻击者打开了一个世界。 它允许进行两阶段攻击。 在第一阶段，攻击者会进行网络钓鱼攻击以获得枚举AD信息的初始条目。 这个初始有效负载通常非常嘈杂，并且会在攻击者执行除泄露枚举数据之外的任何操作之前被蓝队检测到并包含在内。 然而，攻击者现在可以离线使用这些数据以图形格式创建攻击路径，准确显示所需的步骤和跳跃。 在第二次网络钓鱼活动中利用这些信息，攻击者通常可以在突破后几分钟内达到他们的目标。 它通常比蓝队收到第一个警报的速度还要快。 这就是图表思维的力量，这就是为什么这么多蓝队也开始使用这些类型的工具来更好地了解他们的安全态势。</p>
<p>猎犬</p>
<p>您经常会听到用户将 Sharphound 和 Bloodhound 互换使用。 然而，它们并不相同。 Sharphound是Bloodhound的枚举工具。 它用于枚举 AD 信息，然后可以在 Bloodhound 中直观地显示这些信息。 Bloodhound 是用于显示 AD 攻击图的实际 GUI。 因此，我们首先需要学习如何使用Sharphound来枚举AD，然后才能使用Bloodhound直观地看到结果。</p>
<p>共有三种不同的 Sharphound 收藏家：</p>
<ul>
<li><strong>Sharphound.ps1</strong> - 用于运行 Sharphound 的 PowerShell 脚本。 不过，最新版本的 Sharphound 已经停止发布 Powershell 脚本版本。 该版本非常适合与 RAT 一起使用，因为脚本可以直接加载到内存中，从而逃避磁盘上的 AV 扫描。</li>
<li><strong>Sharphound.exe</strong> - 用于运行 Sharphound 的 Windows 可执行版本。</li>
<li><strong>AzureHound.ps1</strong> - 用于运行 Sharphound for Azure（Microsoft 云计算服务）实例的 PowerShell 脚本。 Bloodhound 可以提取从 Azure 枚举的数据，以查找与 Azure 身份和访问管理配置相关的攻击路径。</li>
</ul>
<p><strong>注意：您的 Bloodhound 和 Sharphound 版本必须匹配才能获得最佳结果。 通常会对 Bloodhound 进行更新，这意味着旧的 Sharphound 结果无法被摄取。 该网络是使用 Bloodhound v4.1.0 创建的。 请确保将此版本与 Sharphound 结果一起使用。</strong></p>
<p>在评估中使用这些收集器脚本时，这些文件很可能被检测为恶意软件并向蓝队发出警报。 这又是我们未加入域的 Windows 计算机可以提供帮助的地方。 我们可以使用“runas”命令注入 AD 凭据并将 Sharphound 指向域控制器。 由于我们控制这台 Windows 计算机，因此我们可以禁用 AV 或为特定文件或文件夹创建例外，这已在 THMJMP1 计算机上为您执行。 您可以在该主机上的“C:\Tools\”目录中找到 Sharphound 二进制文件。 我们将使用 SharpHound.exe 版本进行枚举，但也可以随意使用其他两个版本。 我们将执行 Sharphound，如下所示：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Sharphound.exe --CollectionMethods &lt;Methods&gt;  --Domain za.tryhackme.com --ExcludeDCs</span><br></pre></td></tr></tbody></table></figure>

<p>参数解释：</p>
<ul>
<li>CollectionMethods - 确定 Sharphound 将收集什么类型的数据。 最常见的选项是“默认”或“全部”。 另外，由于 Sharphound 会缓存信息，因此一旦第一次运行完成，您只能使用 Session 收集方法来检索新的用户会话以加快该过程。</li>
<li>域 - 在这里，我们指定要枚举的域。 在某些情况下，您可能想要枚举与您的现有域信任的父域或其他域。 您可以通过更改此参数来告诉 Sharphound 应枚举哪个域。</li>
<li>ExcludeDCs - 这将指示 Sharphound 不要接触域控制器，从而降低 Sharphound 运行引发警报的可能性。</li>
</ul>
<p>您可以在<a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-collection/sharpound-all-flags.html">此处</a>找到所有各种 Sharphound 参数。 最好概述一下其他参数，因为根据您的红队评估情况，可能需要这些参数。</p>
<p>使用上一个任务中的 SSH PowerShell 会话，将 Sharphound 二进制文件复制到 AD 用户的文档目录：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; copy C:\Tools\Sharphound.exe ~\Documents\</span><br><span class="line">PS C:\&gt; cd ~\Documents\</span><br><span class="line">PS C:\Users\gordon.stevens\Documents&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>我们将使用 All 和 Session 收集方法运行 Sharphound：</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\Users\gordon.stevens\Documents\&gt;SharpHound.exe --CollectionMethods All --Domain za.tryhackme.com --ExcludeDCs</span><br><span class="line">2022-03-16T19:11:41.2898508+00:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote</span><br><span class="line">2022-03-16T19:11:41.3056683+00:00|INFORMATION|Initializing SharpHound at 7:11 PM on 3/16/2022</span><br><span class="line">2022-03-16T19:11:41.6648113+00:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote</span><br><span class="line">2022-03-16T19:11:41.8211318+00:00|INFORMATION|Beginning LDAP search for za.tryhackme.com</span><br><span class="line">[....]</span><br><span class="line">2022-03-16T19:12:31.6981568+00:00|INFORMATION|Output channel closed, waiting for output task to complete</span><br><span class="line">Closing writers</span><br><span class="line">2022-03-16T19:12:32.2605943+00:00|INFORMATION|Status: 2163 objects finished (+2163 43.26)/s -- Using 85 MB RAM</span><br><span class="line">2022-03-16T19:12:32.2605943+00:00|INFORMATION|Enumeration finished in 00:00:50.4369344</span><br><span class="line">2022-03-16T19:12:32.5418517+00:00|INFORMATION|SharpHound Enumeration Completed at 7:12 PM on 3/16/2022! Happy Graphing!</span><br></pre></td></tr></tbody></table></figure>

<p>Sharphound 执行枚举大约需要 1 分钟。 在较大的组织中，第一次执行可能需要更长的时间，甚至几个小时。 完成后，您将在执行 Sharphound 的同一文件夹中获得一个带时间戳的 ZIP 文件。</p>
<p>​          SSH PowerShell      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\Users\gordon.stevens\Documents&gt; dir</span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\gordon.stevens\Documents</span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-a----        3/16/2022   7:12 PM         121027 20220316191229_BloodHound.zip</span><br><span class="line">-a----        3/16/2022   5:19 PM         906752 SharpHound.exe</span><br><span class="line">-a----        3/16/2022   7:12 PM         360355 YzE4MDdkYjAtYjc2MC00OTYyLTk1YTEtYjI0NjhiZmRiOWY1.bin </span><br></pre></td></tr></tbody></table></figure>

<p>我们现在可以使用 Bloodhound 提取此 ZIP，以直观地向我们展示攻击路径。</p>
<p>寻血猎犬</p>
<p>如前所述，Bloodhound 是一个 GUI，允许我们导入 Sharphound 捕获的数据并将其可视化到攻击路径中。 Bloodhound 使用 Neo4j 作为其后端数据库和图形系统。 Neo4j 是一个图形数据库管理系统。 如果您使用 AttackBox，则可以使用 Dock 中的红色 Bloodhound 图标来启动它。 在所有其他情况下，请确保您的攻击计算机上安装并配置了 Bloodhound 和 neo4j。 无论哪种方式，了解后台发生的事情都是有好处的。 在启动 Bloodhound 之前，我们需要加载 Neo4j：</p>
<p>​          Command Prompt      </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm@thm:~# neo4j console start</span><br><span class="line">Active database: graph.db</span><br><span class="line">Directories in use:</span><br><span class="line">  home:         /var/lib/neo4j</span><br><span class="line">  config:       /etc/neo4j</span><br><span class="line">  logs:         /var/log/neo4j</span><br><span class="line">  plugins:      /var/lib/neo4j/plugins</span><br><span class="line">  import:       /var/lib/neo4j/import</span><br><span class="line">  data:         /var/lib/neo4j/data</span><br><span class="line">  certificates: /var/lib/neo4j/certificates</span><br><span class="line">  run:          /var/run/neo4j</span><br><span class="line">Starting Neo4j.</span><br><span class="line">[....]</span><br><span class="line">2022-03-13 19:59:18.014+0000 INFO  Bolt enabled on 127.0.0.1:7687.</span><br></pre></td></tr></tbody></table></figure>

<p>在另一个终端选项卡中，运行“bloodhound –no-sandbox”。 这将向您显示身份验证 GUI：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/39f261aecedccbaf118eb2ee69d55129.png" alt="Bloodhound"></p>
<p>neo4j 数据库的默认凭据为“neo4j:neo4j”。 使用它在 Bloodhound 中进行身份验证。 要导入我们的结果，您需要从 Windows 主机恢复 ZIP 文件。 最简单的方法是在 AttackBox 上使用 SCP 命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">scp &lt;AD Username&gt;@THMJMP1.za.tryhackme.com:C:/Users/&lt;AD Username&gt;/Documents/&lt;Sharphound ZIP&gt; .</span><br></pre></td></tr></tbody></table></figure>

<p>一旦您提供密码，这会将结果复制到您当前的工作目录。 将 ZIP 文件拖放到 Bloodhound GUI 上以导入 Bloodhound。 它将显示正在提取文件并启动导入。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/d7bed860790aaca612cc658d19d782ef.png" alt="Bloodhound"></p>
<p>导入所有 JSON 文件后，我们可以开始使用 Bloodhound 枚举该特定域的攻击路径。</p>
<p>攻击路径</p>
<p>Bloodhound 可以显示多种攻击路径。 按“搜索节点”旁边的三个条纹将显示选项。 第一个选项卡向我们显示有关当前进口的信息。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/5d695d25afebc2b1dfc7cb408704e755.png" alt="Bloodhound"></p>
<p>请注意，如果您导入新运行的 Sharphound，这些计数会累积增加。 首先，我们将查看节点信息。 让我们在 Bloodhound 中搜索我们的 AD 帐户。 您必须单击该节点才能刷新视图。 另请注意，您可以通过按 LeftCtrl 更改标签方案。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/a6e1af6f79653eeedb18ac9c3be7a038.png" alt="Bloodhound"></p>
<p>我们可以看到返回了大量有关我们使用情况的信息。 每个类别都提供以下信息：</p>
<ul>
<li><strong>概述</strong> - 提供摘要信息，例如帐户拥有的活动会话数以及是否可以达到高价值目标。</li>
<li><strong>节点属性</strong> - 显示有关 AD 帐户的信息，例如显示名称和标题。</li>
<li><strong>额外属性</strong> - 提供更详细的 AD 信息，例如可分辨名称和创建帐户的时间。</li>
<li><strong>组成员资格</strong> - 显示有关帐户所属组的信息。</li>
<li><strong>本地管理员权限</strong> - 提供有关帐户具有管理权限的已加入域的主机的信息。</li>
<li><strong>执行权限</strong> - 提供有关特殊权限的信息，例如通过 RDP 访问计算机的能力。</li>
<li><strong>出站控制权限</strong> - 显示有关此帐户有权修改其属性的 AD 对象的信息。</li>
<li><strong>入站控制权限</strong> - 提供有关可以修改此帐户属性的 AD 对象的信息。</li>
</ul>
<p>如果您想了解每个类别的更多信息，可以按信息查询旁边的数字。 例如，让我们看看与我们的帐户关联的组成员身份。 通过按“First Degree Group Membership”旁边的数字，我们可以看到我们的帐户是两个组的成员。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/5912fb5bc22f7acfa8bc35f86329f0b4.png" alt="Bloodhound"></p>
<p>接下来，我们将研究分析查询。 这些是 Bloodhound 的创建者自己编写的查询，用于列举有用的信息。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/247be9dc8f34b8de181516199b0664dd.png" alt="Bloodhound"></p>
<p>在“域信息”部分下，我们可以运行“查找所有域管理员”查询。 请注意，您可以按左 Ctrl 更改标签显示设置。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/9e4a7afd2acd099df71dc70d9eccf705.png" alt="Bloodhound"></p>
<p>图标称为节点，线称为边。 让我们更深入地了解 Bloodhound 向我们展示的内容。 有一个用户名为 <strong>T0_TINUS.GREEN</strong> 的 AD 用户帐户，它是 <strong>Tier 0 ADMINS</strong> 组的成员。 但是，该组是 <strong>DOMAIN ADMINS</strong> 组中的嵌套组，这意味着属于 <strong>Tier 0 ADMINS</strong> 组的所有用户实际上都是 DA。</p>
<p>此外，还有一个用户名为 <strong>ADMINISTRATOR</strong> 的附加 AD 帐户，它是 <strong>DOMAIN ADMINS</strong> 组的一部分。 因此，如果我们想获得 DA 权限，我们的攻击面中可能会尝试破坏两个帐户。 由于 <strong>ADMINISTRATOR</strong> 帐户是内置帐户，因此我们可能会关注用户帐户。</p>
<p>前面的任务中讨论的每个 AD 对象都可以是 Bloodhound 中的一个节点，并且每个对象都有一个不同的图标来描述其对象类型。 如果我们想制定攻击路径，我们需要查看当前位置和我们拥有的特权与我们想要去的地方之间的可用边缘。 Bloodhound 有各种可用的边缘，可以通过过滤器图标访问：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/c21ccdbdd84a6e709d39fdff14764cea.png" alt="Bloodhound"></p>
<p>随着新攻击媒介的发现，这些内容也会不断更新。 我们将考虑在未来的网络中利用这些不同的优势。 但是，让我们看看仅使用默认边和一些特殊边的最基本的攻击路径。 我们将在 Bloodhound 中运行搜索来枚举攻击路径。 按路径图标即可进行路径搜索。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/d3fab8519fda4ac61db80c35274c53a1.png" alt="Bloodhound"></p>
<p>我们的起始节点将是我们的 AD 用户名，我们的结束节点将是 <strong>Tier 1 ADMINS</strong> 组，因为该组具有对服务器的管理权限。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/b7ae2e4f8e1824e25e69fa69d95c4a4e.png" alt="Bloodhound"></p>
<p>如果使用所选边缘过滤器没有可用的攻击路径，Bloodhound 将显示“未找到结果”。 <strong>请注意，这也可能是由于 Bloodhound/Sharphound 不匹配造成的，这意味着结果未正确摄取。 请使用 Bloodhound v4.1.0。</strong> 但是，在我们的例子中，Bloodhound 显示了攻击路径。 它显示 **T1 管理员 ACCOUNT 之一通过使用其凭据对工作站 **THMJMP1 进行身份验证，打破了分层模型。 它还表明属于 <strong>DOMAIN USERS</strong> 组的任何用户（包括我们的 AD 帐户）都能够通过 RDP 连接到该主机。</p>
<p>我们可以执行如下操作来利用这条路径：</p>
<ol>
<li>使用我们的 AD 凭据通过 RDP 进入 <strong>THMJMP1</strong>。</li>
<li>在主机上寻找可为我们提供管理访问权限的权限升级向量。</li>
<li>通过管理访问，我们可以使用凭证收集技术和工具，例如 Mimikatz。</li>
<li>由于 T1 管理员在 <strong>THMJMP1</strong> 上有一个活动会话，因此我们的凭据收集将为我们提供关联帐户的 NTLM 哈希值。</li>
</ol>
<p>这是一个简单的例子。 一般情况下，攻击路径可能比较复杂，需要采取多次行动才能达到最终目标。 如果您对与每个边缘相关的漏洞感兴趣，以下 <a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html">Bloodhound 文档</a> 提供了一个很好的指南。 Bloodhound 是一款极其强大的 AD 枚举工具，可以深入了解攻击面的 AD 结构。 值得花精力去尝试它并了解它的各种功能。</p>
<p>仅会话数据</p>
<p>在大型组织中，AD 的结构不会经常改变。 可能会有一些新员工，但 OU、组、用户和权限的整体结构将保持不变。</p>
<p>然而，不断变化的一件事是活动会话和登录事件。 由于 Sharphound 创建 AD 结构的时间点快照，因此活动会话数据并不总是准确的，因为某些用户可能已经注销了其会话，或者新用户可能已经建立了新会话。 这是需要注意的重要事项，也是我们希望定期执行 Sharphound 的原因。</p>
<p>一个好的方法是在评估开始时使用“全部”收集方法执行 Sharphound，然后使用“会话”收集方法每天至少执行两次 Sharphound。 这将为您提供新的会话数据并确保这些运行速度更快，因为它们不会再次枚举整个 AD 结构。 执行这些会话运行的最佳时间是在 10:00 左右，此时用户喝完第一杯咖啡并开始工作，然后在 14:00 左右，即他们午休回来但回家之前。</p>
<p>在从这些新的 Sharphound 运行中导入数据之前，您可以通过单击“清除会话信息”在“数据库信息”选项卡上清除 Bloodhound 中的停滞会话数据。</p>
<p>好处</p>
<ul>
<li>提供用于 AD 枚举的 GUI。</li>
<li>能够显示枚举的 AD 信息的攻击路径。</li>
<li>提供对通常需要多次手动查询才能恢复的 AD 对象的更深刻见解。</li>
</ul>
<p>缺点</p>
<ul>
<li>需要执行 Sharphound，它的噪音很大，通常可以被 AV 或 EDR 解决方案检测到。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://mikannse.space">Mikannse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://mikannse.space/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/">http://mikannse.space/2024/04/13/THM域学习EnumeratingActiveDirectory/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mikannse.space" target="_blank">MikannseのSekai</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/Domain/">Domain</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/25/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0LateralMovementandPivoting/" title="THM域学习LateralMovementandPivoting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM域学习LateralMovementandPivoting</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/" title="THM域学习BreachingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM域学习BreachingActiveDirectory</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/30/THMZeroLogon/" title="THMZeroLogon"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">THMZeroLogon</div></div></a></div><div><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ActiveDirectoryBasics/" title="THM域学习ActiveDirectoryBasics"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-12</div><div class="title">THM域学习ActiveDirectoryBasics</div></div></a></div><div><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/" title="THM域学习BreachingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-12</div><div class="title">THM域学习BreachingActiveDirectory</div></div></a></div><div><a href="/2024/05/21/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0CredentialsHarvesting/" title="THM域学习CredentialsHarvesting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">THM域学习CredentialsHarvesting</div></div></a></div><div><a href="/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/" title="THM域学习ExploitingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-27</div><div class="title">THM域学习ExploitingActiveDirectory</div></div></a></div><div><a href="/2024/04/25/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0LateralMovementandPivoting/" title="THM域学习LateralMovementandPivoting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-25</div><div class="title">THM域学习LateralMovementandPivoting</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mikannse</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">309</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mikannse/mikannse.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">暂时没有公告QAQ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Why-AD-Enumeration"><span class="toc-number">1.</span> <span class="toc-text">Why AD Enumeration</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Credential-Injection"><span class="toc-number">2.</span> <span class="toc-text">Credential Injection</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration-through-Microsoft-Management-Console"><span class="toc-number">3.</span> <span class="toc-text">Enumeration through Microsoft Management Console</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration-through-Command-Prompt"><span class="toc-number">4.</span> <span class="toc-text">Enumeration through Command Prompt</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration-through-PowerShell"><span class="toc-number">5.</span> <span class="toc-text">Enumeration through PowerShell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration-through-Bloodhound"><span class="toc-number">6.</span> <span class="toc-text">Enumeration through Bloodhound</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/14/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%89%E7%AB%A0%E8%A7%A3%E6%9E%90%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Python3爬虫开发笔记第三章解析库的使用">Python3爬虫开发笔记第三章解析库的使用</a><time datetime="2024-12-14T06:33:42.000Z" title="发表于 2024-12-14 14:33:42">2024-12-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/07/%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95(%E4%B8%80%E5%85%AD%E4%B8%83)%E4%B9%8BVulnHubDeathNote/" title="打靶记录(一六七)之VulnHubDeathNote">打靶记录(一六七)之VulnHubDeathNote</a><time datetime="2024-12-07T09:05:21.000Z" title="发表于 2024-12-07 17:05:21">2024-12-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/07/%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95(%E4%B8%80%E5%85%AD%E5%85%AD)%E4%B9%8BVulnHubVikings/" title="打靶记录(一六六)之VulnHubVikings">打靶记录(一六六)之VulnHubVikings</a><time datetime="2024-12-07T08:08:20.000Z" title="发表于 2024-12-07 16:08:20">2024-12-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/02/24-11%E6%9D%82%E8%B0%88/" title="24-11杂谈">24-11杂谈</a><time datetime="2024-12-02T06:12:07.000Z" title="发表于 2024-12-02 14:12:07">2024-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/02/2024%E7%A6%8F%E5%BB%BA%E7%9C%81%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9BWP(Web)/" title="2024福建省数据安全大赛WP(Web)">2024福建省数据安全大赛WP(Web)</a><time datetime="2024-12-01T16:11:19.000Z" title="发表于 2024-12-02 00:11:19">2024-12-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Mikannse</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'http://mikannse.space/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/'
    this.page.identifier = '/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/'
    this.page.title = 'THM域学习EnumeratingActiveDirectory'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>